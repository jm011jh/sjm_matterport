/*! For license information please see 136.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[136],{64366:(e,t,i)=>{"use strict";e.exports=i.p+"images/tagbg.png"},28636:(e,t,i)=>{"use strict";e.exports=i.p+"images/NoteColor.png"},27832:(e,t,i)=>{"use strict";e.exports=i.p+"images/objectColor.png"},30749:(e,t,i)=>{"use strict";e.exports=i.p+"images/pinAnchor.png"},44148:(e,t,i)=>{"use strict";e.exports=i.p+"images/pinIconDefault.png"},48072:(e,t,i)=>{"use strict";e.exports=i.p+"images/360_placement_pin_mask.png"},68444:(e,t,i)=>{"use strict";e.exports=i.p+"images/exterior.png"},85089:(e,t,i)=>{"use strict";e.exports=i.p+"images/exterior_hover.png"},45545:(e,t,i)=>{"use strict";e.exports=i.p+"images/interior.png"},64293:(e,t,i)=>{"use strict";e.exports=i.p+"images/interior_hover.png"},4592:(e,t,i)=>{"use strict";e.exports=i.p+"images/tagColor.png"},42606:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>QuickMenus});var n=i(97542),s=i(57956),a=i(74903),o=i(25985),r=i(53954),d=i(65636),l=i(93642),h=i(49219),c=i(92001),m=i(14439),u=i(96042),g=i(34029),p=i(32597),v=i(43736),y=i(71776),w=i(45786);class QuickMenus extends n.Y{constructor(){super(...arguments),this.name="quick-menus"}async init(e,t){this.settingsModule=await t.getModuleBySymbol(s.y.SETTINGS),this.scanInfoDataModule=await t.getModuleBySymbol(s.y.SCAN_INFO),this.settingsGui=this.settingsModule.getSettingsGui();const i=await t.getModuleBySymbol(s.y.DEEP_LINKS),n=await t.market.waitForData(r.Z),b=await t.market.waitForData(g.e),f=await t.market.waitForData(o.M);this.uIndex=this.settingsGui.addPanel("Link to location",[p.R.U],{allowSubGroups:!1,width:400,ratio:90});const T=[38,38,40,40,37,39,37,39,66,65,p.R.O];this.oIndex=this.settingsGui.addPanel("Scan Info",T,{allowSubGroups:!1,width:400,ratio:75}),this.pIndex=this.settingsGui.addPanel("Quick settings",[p.R.P],{allowSubGroups:!1}),this.settingsGui.loadPromise.then((()=>{this.settingsGui.addControl(this.uIndex,"","Link",{}),this.settingsGui.addButton(this.uIndex,"","Copy to clipboard",(()=>{const e=document.createElement("input");e.type="text",e.value=this.buildLink(i),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)})),this.settingsGui.toggle(this.uIndex),this.settingsGui.addControl(this.oIndex,"","Scan ID",{}),this.settingsGui.addControl(this.oIndex,"","Anchor ID",{}),this.settingsGui.addControl(this.oIndex,"","Created",{}),this.settingsGui.addControl(this.oIndex,"","Time of Day",{}),this.settingsGui.addControl(this.oIndex,"","Alignment",{}),this.settingsGui.addControl(this.oIndex,"","Options",{}),this.settingsGui.addControl(this.oIndex,"","Camera",{}),this.settingsGui.addControl(this.oIndex,"","Camera Types",{}),this.settingsGui.addControl(this.oIndex,"","Sensor Serials",{}),this.settingsGui.addControl(this.oIndex,"","Serial Number",{}),this.settingsGui.addControl(this.oIndex,"","Mount Calibration",{}),this.settingsGui.addControl(this.oIndex,"","Software Version",{}),this.settingsGui.addButton(this.oIndex,"","Copy Scan ID",(async()=>{if(n.currentSweep){const e=await this.scanInfoDataModule.getScanInfo(n.currentSweep);if(e){const t=document.createElement("input");t.type="text",t.value=e.id,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}}})),this.settingsGui.addButton(this.oIndex,"","Download Scan",(async()=>{if(n.currentSweep){const e=await this.scanInfoDataModule.getScanDownloadURL(n.currentSweep);e&&window.open(e)}})),this.settingsGui.toggle(this.oIndex);const e=l.WI*(180/Math.PI)*60;this.settingsGui.addControl(this.pIndex,"",c.U,!0),this.settingsGui.addControl(this.pIndex,"",v.s,!0),this.settingsGui.addControl(this.pIndex,"",y.re,!0),this.settingsGui.addControl(this.pIndex,"",w.b,!0),this.settingsGui.addSlider(this.pIndex,"",h.lookAccelerationKey,e,.25,10,2),this.settingsGui.addSlider(this.pIndex,"",a.baseTransitionSpeedKey,d.Z.camera.baseTransitionTime,1,5e3,0);const t=b.tryGetProperty(m.EU,m.Im);this.settingsGui.addSlider(this.pIndex,"",m.WQ,(0,u.JG)(t),.5,10,2),this.settingsGui.toggle(this.pIndex),this.settingsModule.registerSetting("Quick settings",h.lookAccelerationKey,e,!1),this.settingsModule.registerSetting("Quick settings",a.baseTransitionSpeedKey,d.Z.camera.baseTransitionTime,!1),this.settingsGui.onToggle(this.uIndex,(e=>{e&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i))})),this.settingsGui.onToggle(this.oIndex,(e=>{e&&this.refreshScanInfo(n)})),f.pose.onChanged((()=>{this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.uIndex)&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i)),this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.oIndex)&&this.refreshScanInfo(n)})),b.onPropertyChanged(m.WQ,(e=>{b.setProperty(m.EU,(0,u.HG)(e))}))}))}refreshScanInfo(e){e.currentSweep?this.scanInfoDataModule.getScanInfo(e.currentSweep).then((e=>{this.updateScanInfo(e)})):this.updateScanInfo(void 0)}updateScanInfo(e){this.settingsGui.updateSetting(this.oIndex,"Scan ID",e?e.id:""),this.settingsGui.updateSetting(this.oIndex,"Anchor ID",e?e.anchorId:""),this.settingsGui.updateSetting(this.oIndex,"Created",e?e.created:""),this.settingsGui.updateSetting(this.oIndex,"Time of Day",e?e.timeOfDay:""),this.settingsGui.updateSetting(this.oIndex,"Alignment",e?e.alignment:""),this.settingsGui.updateSetting(this.oIndex,"Options",e?JSON.stringify(e.options):""),this.settingsGui.updateSetting(this.oIndex,"Camera",e?`${e.camera.vendor} ${e.camera.model}`:""),this.settingsGui.updateSetting(this.oIndex,"Camera Types",e?JSON.stringify(e.camera.cameraTypes):""),this.settingsGui.updateSetting(this.oIndex,"Sensor Serials",e?JSON.stringify(e.camera.sensorSerialNumbers):""),this.settingsGui.updateSetting(this.oIndex,"Serial Number",e?e.camera.serialNumber:""),this.settingsGui.updateSetting(this.oIndex,"Mount Calibration",e?e.camera.mountCalibrationVersion:""),this.settingsGui.updateSetting(this.oIndex,"Software Version",e?e.camera.softwareVersion:"")}buildLink(e){return decodeURIComponent(e.creator.createDeepLink().href)}}},2290:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AnnotationAttachmentClickedMessage:()=>h.q,AnnotationBlockClickedMessage:()=>h.i,AnnotationType:()=>c.J,AnnotationsViewData:()=>r.A,CloseAnnotationCommand:()=>d.Aj,CloseBillboardCommand:()=>d.G5,CloseDockedAnnotationCommand:()=>d.JD,CloseOtherAnnotationsCommand:()=>d.yL,DockAnnotationCommand:()=>d.bd,PreviewAnnotationCommand:()=>d.Kw,SelectAnnotationCommand:()=>d.oM,default:()=>m});var n=i(97542),s=i(40964),a=i(54244),o=i(80742),r=i(16935),d=i(43470),l=i(96154);class AnnotationsModule extends n.Y{constructor(){super(...arguments),this.name="annotations",this.handleDockAnnotation=async e=>{const t=this.viewData,{dockedAnnotation:i}=t,{id:n,annotationType:s}=e;this.viewData.getCapabilities(n).dock&&((null==i?void 0:i.id)!==n||(null==i?void 0:i.annotationType)!==s?t.atomic((()=>{t.setDockedAnnotation(n,s),t.setBillboardAnnotation(null)})):this.log.debug("Annotation is already docked"))},this.handleSelectAnnotation=async e=>{const t=this.viewData,{billboardAnnotation:i,billboardSelected:n}=t,{id:s,annotationType:a}=e;this.viewData.getCapabilities(s).select&&(n&&(null==i?void 0:i.id)===s&&(null==i?void 0:i.annotationType)===a?this.log.debug("Annotation is already selected"):t.atomic((()=>{t.setBillboardAnnotation(s,a,!0),t.setDockedAnnotation(null)})))},this.handlePreviewAnnotation=async e=>{this.viewData.getCapabilities(e.id).preview&&this.viewData.setBillboardAnnotation(e.id,e.annotationType,!1)},this.handleCloseBillboard=async()=>{this.viewData.setBillboardAnnotation(null)},this.handleCloseDockedAnnotation=async()=>{this.viewData.setDockedAnnotation(null)},this.handleClosingOtherAnnotations=async e=>{const{exceptType:t,exceptId:i}=e;this.closeOtherAnnotations(t,i)},this.closeOtherAnnotations=(e,t)=>{const i=this.viewData,{billboardAnnotation:n,dockedAnnotation:s}=i,a=n&&!this.isMatchingAnnotation(n,e,t),o=s&&!this.isMatchingAnnotation(s,e,t);i.atomic((()=>{n&&a&&i.setBillboardAnnotation(null),s&&o&&i.setDockedAnnotation(null)}))},this.handleCloseAnnotation=async e=>{const t=this.viewData,{billboardAnnotation:i,dockedAnnotation:n}=t,{id:s,annotationType:a}=e;t.atomic((()=>{s===(null==i?void 0:i.id)&&a===(null==i?void 0:i.annotationType)&&t.setBillboardAnnotation(null),s===(null==n?void 0:n.id)&&a===(null==n?void 0:n.annotationType)&&t.setDockedAnnotation(null)}))},this.handleDockedAnnotationChanged=()=>{this.viewData.dockedAnnotation?this.engine.broadcast(new s.ro):this.engine.broadcast(new s.A)}}async init(e,t){this.viewData=new r.A,this.engine=t,[this.applicationData,this.layersData]=await Promise.all([t.market.waitForData(a.pu),t.market.waitForData(o.R)]),this.bindings.push(t.commandBinder.addBinding(d.bd,this.handleDockAnnotation),t.commandBinder.addBinding(d.oM,this.handleSelectAnnotation),t.commandBinder.addBinding(d.Kw,this.handlePreviewAnnotation),t.commandBinder.addBinding(d.Aj,this.handleCloseAnnotation),t.commandBinder.addBinding(d.G5,this.handleCloseBillboard),t.commandBinder.addBinding(d.JD,this.handleCloseDockedAnnotation),t.commandBinder.addBinding(d.yL,this.handleClosingOtherAnnotations),t.subscribe(l.oR,this.handleCloseBillboard),this.applicationData.onPropertyChanged("application",this.closeOtherAnnotations),this.layersData.onPropertyChanged("currentViewId",this.handleCloseBillboard),this.viewData.onDockedAnnotationChanged(this.handleDockedAnnotationChanged)),t.market.register(this,r.A,this.viewData)}dispose(e){this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],super.dispose(e)}onUpdate(){}isMatchingAnnotation(e,t,i){return!(!i&&!t)&&((!i||i===e.id)&&(!t||t===e.annotationType))}}var h=i(5604),c=i(86283);const m=AnnotationsModule},58989:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Attachment:()=>o.P,AttachmentCategory:()=>r.G$,AttachmentEmbedStatus:()=>r._V,AttachmentUploadDoneMessage:()=>d.RE,AttachmentUploadError:()=>r.kV,AttachmentUploadProgressMessage:()=>d.Vj,AttachmentViewerCommand:()=>M.xW,AttachmentsData:()=>P.b,AttachmentsStore:()=>AttachmentsStore,CancelAttachmentChangesCommand:()=>M.Ze,CloseAttachmentViewerMessage:()=>d.Rd,ConfirmAttachmentChangesCommand:()=>M.iu,EmbedMediaCommand:()=>M.wu,EmbeddingDoneMessage:()=>d.v8,ExternalAttachmentDeserializer:()=>u.d,ExternalAttachmentSerializer:()=>ExternalAttachmentSerializer,FileAttachmentDeserializer:()=>g.O,FileAttachmentStorage:()=>FileAttachmentStorage,FileUploadDeserializer:()=>FileUploadDeserializer,FileUploadSerializer:()=>FileUploadSerializer,LoadEmbeddedMediaCommand:()=>M.st,MediaType:()=>r.DD,RemoveAttachmentCommand:()=>M.$T,RemoveFailureCommand:()=>M.Rh,ResetAttachmentChangesCommand:()=>M.x9,UploadAttachmentsCommand:()=>M.It,ViewAttachmentsMessage:()=>d.O,default:()=>N});var n=i(97542),s=i(92558),a=i(5823),o=i(71608),r=i(32347),d=i(13794),l=i(17788),h=i(73123),c=i(97998),m=i(21149);class ExternalAttachmentSerializer{constructor(){this.getAttachmentDetails=e=>e.mediaType?{mediaType:(0,m.m)(e.mediaType),srcUrl:e.src,thumbnailUrl:e.src,width:e.width,height:e.height}:null,this.validate=e=>!!e&&void 0!==e.mediaType}serialize(e){const t=this.getAttachmentDetails(e);return t&&this.validate(t)?t:null}}var u=i(63665),g=i(65222),p=i(36159),v=i(63437);const y=new c.Z("AttachmentsStore");class AttachmentsStore extends l.u{constructor(e){super(e),this.embedSerializer=new ExternalAttachmentSerializer,this.embedDeserializer=new u.d,this.fileDeserializer=new g.O}create(e){if(0===e.length)return Promise.resolve(null);const t=e[0].parentId,i=e[0].parentType;if(e.find((e=>e.parentId!==t||e.parentType!==i)))throw new Error("Cannot attach to different parents in one request");const n=this.getViewId(),s=[],o=[];let d,l;if(e.forEach((e=>{if(e.category===r.G$.EXTERNAL){const t=this.embedSerializer.serialize(e);if(!t)throw y.error("Failure attaching external attachment:",e),new Error("Could not attach External Attachment");s.push(t)}else e.category===r.G$.UPLOAD&&o.push(e.id)})),i!==a.ud.COMMENT)throw new Error(`Cannot attach to attachment to a ${i}`);return d=p.AddCommentAttachments,l="addCommentAttachments",this.mutate(d,{modelId:n,parentId:t,externalAttachments:s,fileAttachments:o}).then((e=>{const t=[],i=(0,h.q)(e,`data.${l}.externalAttachments`);if(i&&Array.isArray(i))for(const e of i){const i=this.embedDeserializer.deserialize(e);i&&t.push(i)}const n=(0,h.q)(e,`data.${l}.fileAttachments`);if(n&&Array.isArray(n))for(const e of n){const i=this.fileDeserializer.deserialize(e);i&&t.push(i)}return t.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async remove(e){const{id:t,parentId:i,parentType:n}=e,s=this.getViewId(),a=await this.mutate(v.RemoveFileAttachment,{modelId:s,attachmentId:t,parentType:n,parentId:i}),o=(0,h.q)(a,"data.removeFileAttachment")||!1;return o||y.error("remove file attachment failed!"),o}async delete(e,t,i){const n=this.getViewId();return Promise.all(e.map((e=>this.mutate(v.DeleteExternalAttachment,{modelId:n,attachmentId:e,parentType:i,parentId:t}))))}getViewId(){if(!this.viewId)throw new Error("Invalid valid id!");return this.viewId}}var w=i(77827),b=i(44602),f=i(9133),T=i(56367);const D=new c.Z("file-upload-deserializer");class FileUploadDeserializer{deserialize(e){if(!e||!this.validate(e))return D.debug("Deserialized invalid file attachment data from MDS",e),null;const t=new o.P;return t.id=e.id,t.created=(0,f.p)(e.created),e.mimeType&&(t.mimeType=e.mimeType,t.mediaType=(0,m.id)(e.mimeType)),t.thumbnailUrl=new T.n(e.url||"",(0,f.p)(e.validUntil,null)),t.url=new T.n(e.url||"",(0,f.p)(e.validUntil,null)),t.filename=e.filename||"",t.bytes=e.bytes||0,t.category=r.G$.UPLOAD,t.width=e.imageWidth||0,t.height=e.imageHeight||0,t}validate(e){return["id","created","url","filename","mimeType","validUntil"].every((t=>t in e))}}class FileUploadSerializer{constructor(){}serialize(e){return{filename:e.file.name,contents:{filename:e.file.name,blob:e.file}}}}const C=new c.Z("FileAttachmentStorage");class FileAttachmentStorage extends w.U{constructor(e){super(e),this.uploadDeserializer=new FileUploadDeserializer,this.uploadSerializer=new FileUploadSerializer}async create(e,t){const i=w.U.baseViewId,n=this.uploadSerializer.serialize(e);let s;try{s=await this.client.upload(b.UploadFileAttachmentToModel,"UploadFileAttachmentToModel",Object.assign(Object.assign({},n),{modelId:i,organizationId:this.config.organizationId}),t)}catch(t){return C.error(t),"file.upload.quota.exceeded"===t.code?e.error=r.kV.OVER_QUOTA:e.error=r.kV.UPLOAD_FAILED,e.progress=100,e}if(s.errors&&s.errors.length>0)C.error(s.errors),e.error=r.kV.UPLOAD_FAILED;else{const t=(0,h.q)(s,"data.uploadFileAttachmentToModel")||null;if(t){const i=this.uploadDeserializer.deserialize(t);i?(C.info("upload successful!"),e.attachment=i):(C.error("cannot create attachment"),e.error=r.kV.UPLOAD_FAILED)}else C.error("upload failed!"),e.error=r.kV.UPLOAD_FAILED}return e.progress=100,e}async delete(e){const t=await this.client.mutate(b.DeleteFileAttachment,{id:e}),i=(0,h.q)(t,"data.deleteFileAttachment")||!1;return i?C.info("upload deleted!"):C.error("upload deletion failed!"),i}}var P=i(97163),M=i(35446),S=i(36892),A=i(56382);function E(e){switch(e){case A.ht.PHOTO:return r.DD.IMAGE;case A.ht.VIDEO:return r.DD.VIDEO;case A.ht.RICH:return r.DD.RICH;default:return}}function k(e){const{height:t,width:i,thumbnail_height:n,thumbnail_width:s,cache_age:a}=e,o=(void 0===t||void 0===i)&&(s&&n),r=e.type===A.ht.PHOTO?e.url:void 0,d=e.thumbnail_url||r,l=a?new Date(Date.now()+1e3*a):null;return{width:o?s:i,height:o?n:t,mediaType:E(e.type),url:new T.n(r||"",l),thumbnailUrl:new T.n(d||"",l)}}var I=i(80742);class AttachmentsModule extends n.Y{constructor(){super(...arguments),this.name="attachments-module",this.loadEmbeddedAttachment=async e=>this.getUpdatedEmbed(e.attachment),this.embedMedia=async e=>{let t,i=null;const n=await this.oEmbedConsumer.getOEmbedData(e.src);return n?(i=new o.P,i.id=(0,s.fV)(),i.parentType=e.parentType,i.parentId=e.parentId,i.src=e.src,i.category=r.G$.EXTERNAL,Object.assign(i,k(n)),this.attachmentsData.addPending(i),t=r._V.EMBED_SUCCESS):t=r._V.EMBED_FAIL,this.engine.broadcast(new d.v8(i,t,e.parentId,e.parentType)),i},this.uploadAttachments=async e=>{const{parentType:t,parentId:i,files:n}=e,s=this.attachmentsData;n.forEach((e=>{this.uploadAttachment(e,i,t).then((e=>{s.atomic((()=>{e.error?(s.removeUpload(e.id),s.addFailure(e)):e.attachment&&(e.attachment.parentId=i,e.attachment.parentType=t,s.removeUpload(e.id),s.addPending(e.attachment))})),this.engine.broadcast(new d.RE(e))}))}))},this.onProgress=(e,t)=>{if(!e.lengthComputable)return;const i=e.total>0?Math.floor(e.loaded/e.total*100):100,n=Object.assign(Object.assign({},t),{progress:i});this.attachmentsData.updateUpload(n),this.engine.broadcast(new d.Vj(n))},this.removeFailure=async e=>{this.attachmentsData.removeFailure(e.id)},this.removeAttachment=async e=>{if(!this.fileAttachmentStorage)return void this.log.error("No file attachment store");const{attachment:t}=e,i=this.attachmentsData,n=i.getPendingAttachment(t.id);n?(n.category===r.G$.UPLOAD&&await this.fileAttachmentStorage.delete(t.id),i.removePendingAttachment(t.id)):i.markAttachmentForDelete(t)},this.confirmAttachmentChanges=async e=>{const t=this.attachmentsData,{pendings:i,removals:n}=t,{parentId:s,parentType:o,prevParentId:d}=e,l=i.length>0||n.length>0;if(i.length>0){const e=d||s;t.iteratePending((t=>{d&&t.parentId===e&&t.parentType===o&&(t.parentId=s)}));const n=o!==a.ud.MATTERTAG?i.values:i.values.filter((e=>e.category===r.G$.UPLOAD));await this.attachmentsStore.create(n)}if(n.length>0){const e=o!==a.ud.MATTERTAG?n.values:n.values.filter((e=>e.category===r.G$.UPLOAD));e.length>0&&await this.deleteAttachments(e,s,o)}return this.resetAttachmentData(),l},this.cancelAttachmentChanges=async()=>{const e=this.attachmentsData,{pendings:t,removals:i}=e;0===t.length&&0===i.length||(this.fileAttachmentStorage?(e.pendings.values.forEach((e=>{e.category===r.G$.UPLOAD&&this.fileAttachmentStorage.delete(e.id)})),this.resetAttachmentData()):this.log.error("No file attachment store"))},this.deleteAttachments=async(e,t,i)=>{if(!this.fileAttachmentStorage)return void this.log.error("No file attachment store");if(0===e.length)return;const n=[],s=[];this.attachmentsData.atomic((()=>{e.forEach((e=>{e.category===r.G$.UPLOAD?n.push(e):e.category===r.G$.EXTERNAL&&s.push(e.id)}))})),n.length>0&&await Promise.all(n.map((e=>this.attachmentsStore.remove(e)))),s.length>0&&await this.attachmentsStore.delete(s,t,i)},this.handleAttachmentViewerCommand=async e=>{const{open:t,attachments:i,attachmentId:n}=e;t&&i?this.openAttachmentViewer(i,n):this.closeAttachmentViewer()}}async init(e,t){this.engine=t;const{organizationId:i,oEmbedConsumer:n}=e;this.attachmentsStore=new AttachmentsStore({readonly:!1});const s=await t.market.waitForData(I.R),a=()=>{this.attachmentsStore.setStoreViewId(s.getNonworkshopViewId())};a(),this.bindings.push(s.onPropertyChanged("currentViewId",a)),i&&(this.fileAttachmentStorage=new FileAttachmentStorage({readonly:!1,organizationId:i})),this.oEmbedConsumer=await n,this.attachmentsData=new P.b,this.bindings.push(t.commandBinder.addBinding(M.It,this.uploadAttachments),t.commandBinder.addBinding(M.wu,this.embedMedia),t.commandBinder.addBinding(M.st,this.loadEmbeddedAttachment),t.commandBinder.addBinding(M.iu,this.confirmAttachmentChanges),t.commandBinder.addBinding(M.Ze,this.cancelAttachmentChanges),t.commandBinder.addBinding(M.x9,(async()=>this.resetAttachmentData())),t.commandBinder.addBinding(M.$T,this.removeAttachment),t.commandBinder.addBinding(M.Rh,this.removeFailure),t.commandBinder.addBinding(M.xW,this.handleAttachmentViewerCommand)),t.market.register(this,P.b,this.attachmentsData)}async getUpdatedEmbed(e){if(e.category===r.G$.EXTERNAL){const t=await this.oEmbedConsumer.getOEmbedData(e.src);return Object.assign(e,k(t)),t}return null}async uploadAttachment(e,t,i){const n={file:e,id:(0,s.fV)(),progress:0,error:null,attachment:null,parentId:t,parentType:i};if(!this.fileAttachmentStorage)return this.log.error("No file attachment store"),n.error=r.kV.PERMISSION_DENIED,Promise.resolve(n);const a=e.size;return 0===a?(n.error=r.kV.EMPTY_FILE,Promise.resolve(n)):a>S.z6?(n.error=r.kV.FILE_TOO_LARGE,Promise.resolve(n)):(this.attachmentsData.addUpload(n),this.fileAttachmentStorage.create(n,(e=>this.onProgress(e,n))))}resetAttachmentData(){const e=this.attachmentsData;e.atomic((()=>{e.clearPending(),e.clearRemovals(),e.clearUploads(),e.clearFailures()}))}openAttachmentViewer(e,t){this.viewerOpen=!0,this.engine.broadcast(new d.O(e,t))}closeAttachmentViewer(){this.viewerOpen&&(this.viewerOpen=!1,this.engine.broadcast(new d.Rd))}}const N=AttachmentsModule},63665:(e,t,i)=>{"use strict";i.d(t,{d:()=>ExternalAttachmentDeserializer});var n=i(97998),s=i(56367),a=i(9133),o=i(21149),r=i(71608),d=i(32347);const l=new n.Z("external-attachment-deserializer");class ExternalAttachmentDeserializer{constructor(){}deserialize(e){if(!e||!this.validate(e))return l.debug("Deserialized invalid external attachment data from MDS",e),null;const t=new r.P;return t.id=e.id,t.created=(0,a.p)(e.created),t.src=e.url||"",t.thumbnailUrl=new s.n(e.thumbnailUrl||"",(0,a.p)(e.validUntil,null)),t.url=new s.n(e.url||"",(0,a.p)(e.validUntil,null)),e.mediaType&&(t.mediaType=(0,o.bY)(e.mediaType)),t.category=d.G$.EXTERNAL,e.width&&(t.width=e.width),e.height&&(t.height=e.height),t.parentType=e.parentDetails.type,t.parentId=e.parentDetails.parent.id,t}validate(e){if(!e)return!1;const t=["id","created","modified","mediaType","parentDetails"].filter((t=>!(t in e))),i=0===t.length;return i||l.debug("Attachment invalid:",{missingFields:t}),i}}},65222:(e,t,i)=>{"use strict";i.d(t,{O:()=>FileAttachmentDeserializer});var n=i(97998),s=i(9133),a=i(21149),o=i(71608),r=i(32347),d=i(56367);const l=new n.Z("file-attachment-deserializer");class FileAttachmentDeserializer{constructor(){}deserialize(e){if(!e||!this.validate(e))return l.debug("Deserialized invalid file attachment data from MDS",e),null;const t=new o.P;return t.id=e.id,t.created=(0,s.p)(e.created),e.mimeType&&(t.mimeType=e.mimeType,t.mediaType=(0,a.id)(e.mimeType)),t.category=r.G$.UPLOAD,t.thumbnailUrl=new d.n(e.url||"",(0,s.p)(e.validUntil,null)),t.url=new d.n(e.url||"",(0,s.p)(e.validUntil,null)),t.filename=e.filename||"",t.bytes=e.bytes||0,t.width=e.imageWidth||0,t.height=e.imageHeight||0,t}validate(e){if(!e)return!1;return["id","created","url","mimeType","filename"].every((t=>t in e))}}},25821:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>CurrentPanoMarker});var n=i(97542),s=i(57956),a=i(84428),o=i(12529),r=i(77597);const d=new a.Vector3(0,1,0),l=16724312,h=[{innerRadius:0,outerRadius:.42,color:l,opacity:.7},{innerRadius:.67,outerRadius:1,color:l,opacity:.7}];class MarkerRenderer{constructor(e,t,i){this.scene=e,this.sweepData=t,this.mesh=new r.f({radius:.25,normal:d,rings:h}),this.mesh.name="CurrentPanoMarker",this.mesh.renderOrder=o.z.panoMarker,this.mesh.layers.mask=i.mask}init(){}dispose(){this.mesh.dispose()}render(){const e=this.sweepData.currentAlignedSweepObject;e&&this.move(e.floorPosition)}activate(){this.scene.add(this.mesh)}deactivate(){this.scene.remove(this.mesh)}move(e){this.mesh.position.copy(e).setY(e.y+MarkerRenderer.floorOffset)}}MarkerRenderer.floorOffset=.01;var c=i(23254),m=i(53954),u=i(19663);class TogglePanoMarkerCommand extends u.m{constructor(e){super(),this.id="TOGGLE_PANO_MARKER",this.payload={enabled:e}}}var g=i(95882),p=i(34029),v=i(98819);class CurrentPanoMarker extends n.Y{constructor(){super(...arguments),this.name="current-pano-marker",this.state={markerEnabled:!1,transitionPromise:null}}async init(e,t){const i=(await t.getModuleBySymbol(s.y.WEBGL_RENDERER)).getScene(),n=t.claimRenderLayer(this.name),[a,o,r]=await Promise.all([t.market.waitForData(p.e),t.market.waitForData(m.Z),t.market.waitForData(c.O)]);this.engine=t,this.settingsData=a,this.sweepData=o,this.viewmodeData=r,this.markerRenderer=new MarkerRenderer(i,o,n),this.bindings.push(t.commandBinder.addBinding(TogglePanoMarkerCommand,(async({enabled:e})=>this.setCommandOverride(e))),this.viewmodeData.makeModeChangeSubscription((()=>this.updateMarker())),this.sweepData.makeSweepChangeSubscription((()=>this.updateMarker())),this.settingsData.onPropertyChanged(v.o,(()=>this.updateMarker()))),this.updateMarker()}setCommandOverride(e){this.state.commandOverride=e,this.updateMarker()}async updateMarker(){const{commandOverride:e}=this.state,t=this.viewmodeData.currentMode,i=this.sweepData.currentAlignedSweepObject,n=!1===this.settingsData.tryGetProperty(v.o,!0)||!1===e||(0,g.Bw)(t)||t===g.Ey.Transition;return this.toggleMarker(!!i&&!n)}async toggleMarker(e){const{markerEnabled:t,transitionPromise:i}=this.state;if(i&&await i,t===e)return;const n=e?this.enableMarker():this.disableMarker();return this.state.transitionPromise=n.finally((()=>{this.state.markerEnabled=e,this.state.transitionPromise=null})),this.state.transitionPromise}async enableMarker(){return this.engine.addComponent(this,this.markerRenderer)}async disableMarker(){return this.engine.removeComponent(this,this.markerRenderer)}}},95512:(e,t,i)=>{"use strict";i.d(t,{y:()=>DisableCursorMeshCommand});var n=i(19663);class DisableCursorMeshCommand extends n.m{constructor(e){super(),this.payload={disable:e}}}},79565:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>CursorController});var n=i(97542),s=i(57956),a=i(95882),o=i(23254),r=i(2473),d=i(5135),l=i(53954),h=i(95512),c=i(34029),m=i(45786);class CursorController extends n.Y{constructor(){super(...arguments),this.name="cursor-controller",this.visibilityRules=[],this.disabled=!1}async init(e,t){this.bindings.push(t.commandBinder.addBinding(h.y,(async e=>{this.disabled=e.disable}))),[this.cursorMesh,this.cursorModule]=await Promise.all([t.getModuleBySymbol(s.y.CURSOR_MESH),t.getModuleBySymbol(s.y.CURSORS)]),this.visibilityRules.push((()=>{const e=t.market.tryGetData(o.O);return!!e&&(0,a.Bw)(e.closestMode)}),(()=>{const e=t.market.tryGetData(l.Z);return!!e&&!e.isSweepUnaligned(e.currentSweep)}),(()=>{const e=t.market.tryGetData(r.k);return!!e&&!e.isTourActive()}),(()=>{const e=t.market.tryGetData(d.Z);return!!e&&!e.isMobile()}),(()=>{const e=t.market.tryGetData(c.e);return!!e&&e.tryGetProperty(m.b,!0)}))}onUpdate(){this.updateCursorVisibility()}addVisibilityRule(e){this.visibilityRules.push(e)}removeVisibilityRule(e){const t=this.visibilityRules.indexOf(e);-1!==t&&this.visibilityRules.splice(t,1)}setFadeProps(e){this.cursorModule.setFadeProps(e)}updateCursorVisibility(){const e=!this.disabled&&this.visibilityRules.reduce(((e,t)=>e&&t()),!0);this.cursorMesh.setVisible(e)}setTexture(e){this.cursorModule.setTexture(e)}}},45786:(e,t,i)=>{"use strict";i.d(t,{b:()=>n});const n="features/cursor"},30747:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>CursorDataModule});var n=i(57956),s=i(97542),a=i(84428),o=i(93411),r=i(13310),d=i(67678),l=i(85992);class CursorDataModule extends s.Y{constructor(){super(...arguments),this.name="cursor-data",this.cursorState=new r.Y,this.position=new a.Vector2,this.timeToFade=0}async init(e,t){this.input=await t.getModuleBySymbol(n.y.INPUT),this.raycasterData=await t.market.waitForData(l.P),t.market.register(this,r.Y,this.cursorState),this.bindings.push(this.input.registerHandler(d.mE,this.onPointerMove.bind(this))),CursorDataModule.fadeInDuration>CursorDataModule.fadeOutDelay&&this.log.warn("fadeInDuration should be less than fadeOutDelay!")}onUpdate(e){let t=!1;this.timeToFade>0&&(this.timeToFade-=e,this.timeToFade<=0&&(t=!0)),this.cursorState.opacity.tick(e),this.cursorState.commit(),t&&this.cursorState.opacity.modifyAnimation(1,0,CursorDataModule.fadeOutDuration)}setFadeProps(e){const{fadeOut:t,fadeIn:i}=e;CursorDataModule.fadeOutDuration=t&&t.duration?t.duration:CursorDataModule.fadeOutDuration,CursorDataModule.fadeOutDelay=t&&t.delay?t.delay:CursorDataModule.fadeOutDelay,CursorDataModule.fadeInDuration=i&&i.duration?i.duration:CursorDataModule.fadeInDuration}setTexture(e){this.cursorState.texture=e}onPointerMove(){if(null!==this.raycasterData.hit&&this.raycasterData.pointerNdcPosition.distanceToSquared(this.position)>CursorDataModule.movementThreshold){this.position.copy(this.raycasterData.pointerNdcPosition),this.timeToFade=CursorDataModule.fadeOutDelay;const e=(0,o.t)(0,CursorDataModule.fadeInDuration,1-this.cursorState.opacity.value);this.cursorState.opacity.modifyAnimation(this.cursorState.opacity.value,1,e),this.cursorState.commit()}}dispose(e){super.dispose(e)}}CursorDataModule.fadeOutDelay=700,CursorDataModule.fadeOutDuration=700,CursorDataModule.fadeInDuration=300,CursorDataModule.movementThreshold=.003},13310:(e,t,i)=>{"use strict";i.d(t,{Y:()=>CursorData});var n=i(89557),s=i(67992);class CursorData extends s.V{constructor(){super(),this.name="cursor",this.opacity=new n.z(0),this.texture=null}}},85042:(e,t,i)=>{"use strict";var n;i.d(t,{L:()=>n}),function(e){e[e.Reticle=0]="Reticle",e[e.GridPlane=1]="GridPlane"}(n||(n={}))},90763:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>CursorMesh});var n=i(97542),s=i(57956),a=i(84428),o=i(13310),r=i(85992),d=i(17878),l=i(85042),h=i(12529),c=i(77597);const m=[{outerRadius:.977,innerRadius:.926,color:16777215,opacity:1},{outerRadius:.898,innerRadius:.648,color:16777215,opacity:.73}];class Cursor{constructor(e,t=d.o.ALL){this.scene=e,this.layer=t,this.supportsMobile=!1,this.style=l.L.Reticle,this.bindings=[],this.onCursorDataUpdated=e=>{this.mesh.configure({opacity:e.opacity.value,texture:e.texture})},this.onPositionUpdate=e=>{if(e.hit&&e.hit.face){const t=e.hit.point.clone(),i=e.hit.face.normal;this.container.position.copy(t),this.mesh.configure({normal:i})}},this.container=new a.Group,this.container.name="cursor",this.mesh=new c.f({radius:.2,rings:m}),this.container.add(this.mesh),this.mesh.renderOrder=h.z.reticule,this.mesh.layers.mask=this.layer.mask}init(){}render(){}dispose(){this.mesh.dispose(),this.container.children.forEach((e=>{if(e.isMesh&&e!==this.mesh){e.geometry.dispose();const t=e.material;t.dispose(),t.map&&t.map.dispose()}}))}async activate(e){const t=await e.market.waitForData(o.Y),i=await e.market.waitForData(r.P);this.bindings.push(t.onChanged(this.onCursorDataUpdated),i.onChanged(this.onPositionUpdate)),this.scene.add(this.container)}deactivate(){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}setVisible(e){this.container.visible=e}}class CursorMesh extends n.Y{constructor(){super(...arguments),this.name="cursor-mesh",this.setVisible=e=>{this.cursor&&this.cursor.setVisible(e)}}async init(e,t){const i=(await t.getModuleBySymbol(s.y.WEBGL_RENDERER)).getScene(),n=t.claimRenderLayer(this.name);this.cursor=new Cursor(i,n),t.addComponent(this,this.cursor)}get container(){return this.cursor.container}}},95810:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>Fatcaster});var n=i(97542),s=i(57956),a=i(53058),o=i(84428),r=i(90304);class Fatcaster extends n.Y{constructor(){super(...arguments),this.name="fat-caster",this.rayAssembly=new Array(Fatcaster.rayCount),this.rayPlaneOrientation=new o.Quaternion,this.rayVisuals=[]}async init(e,t){this.config={debug:!!e.debug},this.raycaster=await t.getModuleBySymbol(s.y.RAYCASTER);for(let e=0;e<Fatcaster.rayCount;++e)this.rayAssembly[e]=new o.Ray;if(e.debug){const e=(await t.getModuleBySymbol(s.y.WEBGL_RENDERER)).getScene();for(let t=0;t<Fatcaster.rayCount;++t){this.rayVisuals[t]=new o.ArrowHelper(new o.Vector3,new o.Vector3);const i=this.rayVisuals[t];i.remove(i.cone),i.setLength(1e3),e.add(this.rayVisuals[t])}}}async dispose(e){const t=(await e.getModuleBySymbol(s.y.WEBGL_RENDERER)).getScene();for(const e of this.rayVisuals)t.remove(e)}get ray(){return this.raycaster.pointer.pointerRay.clone()}cast(e,t,i=a.a.Filter.AVERAGE){const n=this.ray;return this.updateRayAssembly(n.origin,n.direction,e),this.castRays(t,i)}castRays(e,t){const i=[];let n=null;for(const t of this.rayAssembly){const s=this.raycaster.picking.pick(t.origin,t.direction,e);s&&(t===this.rayAssembly[0]&&(n=s),s.point.add(this.rayAssembly[0].origin).sub(t.origin),i.push(s))}return t(i,n,this.rayAssembly)}updateRayAssembly(e,t,i){for(const e of this.rayAssembly)e.direction.copy(t);if(this.rayPlaneOrientation.setFromUnitVectors(r.f.FORWARD,t),this.rayAssembly[0].origin.copy(e),this.rayAssembly[1].origin.copy(r.f.RIGHT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[2].origin.copy(r.f.UP).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[3].origin.copy(r.f.LEFT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[4].origin.copy(r.f.DOWN).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[5].origin.copy(r.f.UP).add(r.f.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[6].origin.copy(r.f.UP).add(r.f.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[7].origin.copy(r.f.DOWN).add(r.f.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[8].origin.copy(r.f.DOWN).add(r.f.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.config.debug)for(let e=0;e<this.rayVisuals.length;++e){const i=this.rayVisuals[e];i.setDirection(t),i.position.copy(this.rayAssembly[e].origin)}}}Fatcaster.rayCount=9},53058:(e,t,i)=>{"use strict";i.d(t,{a:()=>n});var n,s=i(84428);!function(e){let t;!function(e){const t=e=>{for(const t of e)if(t.face)return{point:t.point,object:t.object,distance:t.distance,face:t.face};return null},i=(e,t)=>e.distance-t.distance;e.CENTER_FIRST=(e,i)=>i&&i.face?{point:i.point,normal:i.face.normal,object:i.object,distance:i.distance,face:i.face}:t(e),e.CLOSEST=e=>t(e.sort(i)),e.AVERAGE=e=>{if(0===e.length)return null;const t={point:new s.Vector3,face:{a:0,b:1,c:2,normal:new s.Vector3,materialIndex:0},distance:0,object:e[0].object};for(const i of e)t.face&&i.face&&(t.point.add(i.point),t.face.normal.add(i.face.normal));return t.point.divideScalar(e.length),t.face&&t.face.normal.divideScalar(e.length).normalize(),t};e.CENTER_GROUP=t=>(i,s,a)=>{if(s){const n=[s];for(let e=1;e<i.length&&e<3;++e){const o=i[e];if(o.face){const i=Math.abs(a[e].direction.dot(o.face.normal));s.point.distanceTo(o.point)*i<=t&&n.push(o)}}if(n.length>=3){const t=e.AVERAGE(n,null,a);if(t&&t.face&&s.face)return t.face.normal=s.face.normal,t}}const o=n(i,a,t);return o?e.AVERAGE(o,null,a):e.CENTER_FIRST(i,s,a)};const n=(e,t,n)=>{const s=e.slice().sort(i),a=[s[0]];let o;for(o=1;o<s.length&&a.length<3;++o){const e=s[o];if(e.face){const i=Math.abs(t[o].direction.dot(e.face.normal));a[0].point.distanceTo(e.point)*i>n&&(a.length=0),a.push(e)}}return a.length<3?null:a}}(t=e.Filter||(e.Filter={}))}(n||(n={}))},69582:(e,t,i)=>{"use strict";i.r(t),i.d(t,{GetFloorIntersectCommand:()=>n.Z,default:()=>y});var n=i(29900),s=i(97542),a=i(57956),o=i(947),r=i(25985),d=i(59370),l=i(76957),h=i(23254),c=i(95882),m=i(82814),u=i(16769),g=i(67944),p=i(84428),v=i(90304);class FloorCaster extends s.Y{constructor(){super(...arguments),this.name="floor-caster",this.cameraPosition=new p.Vector3,this.forwardPosition=new p.Vector3,this.targetPlane=new p.Plane}async init(e,t){this.engine=t,[this.renderer,this.cameraData,this.viewmodeData,this.raycaster,this.floorsData,this.meshQuery]=await Promise.all([t.getModuleBySymbol(a.y.WEBGL_RENDERER),t.market.waitForData(r.M),t.market.waitForData(h.O),t.getModuleBySymbol(a.y.RAYCASTER),t.market.waitForData(l.i),t.getModuleBySymbol(a.y.MESH_QUERY)]),t.commandBinder.addBinding(n.Z,(e=>this.castToFloor(e.screenPosition,e.height,e.includeHiddenFloors)))}async castToFloor(e,t,i=!0){await this.engine.after(o.A.End);const n=this.renderer.getScene().camera,s=(0,d.z5)(e.x,e.y,this.cameraData.width,this.cameraData.height);let a,r=null;this.cameraPosition.set(s.x,s.y,-1).unproject(n),this.forwardPosition.set(s.x,s.y,1).unproject(n);const l=this.raycaster.picking.cast(this.cameraPosition,this.forwardPosition.clone().sub(this.cameraPosition).normalize(),i?u.T0:u.Pv)[0];if(l&&l.object instanceof m.S){r=l&&l.point||null;const e=this.meshQuery.floorIdFromObject(l.object);e?a=this.floorsData.getFloor(e):r&&(a=this.floorsData.getClosestFloorAtHeight(r.y))}if(void 0!==t){this.cameraPosition.copy(this.cameraData.pose.position);const e=(0,d.st)(this.cameraData,s);if(this.viewmodeData.currentMode!==c.Ey.Floorplan){const i=(0,g.n0)(this.cameraPosition,e);this.targetPlane.set(v.f.DOWN,t),r=(0,g.Fe)(this.cameraPosition,i,this.targetPlane)||null}else e.y=t,r=e}const h=a?a.index:-1;return{position:r,floor:h,floorIndex:h}}}const y=FloorCaster},51728:(e,t,i)=>{"use strict";i.d(t,{U:()=>n});const n=Object.freeze({pink:"#f78da7",plum:"#9c4b92",purple:"#673ab7",teal:"#03687d",cerulean:"#03a9f4",ocean:"#00bcd4",fog:"#abb8c3",iron:"#607d8b",forest:"#417505",emerald:"#51a868",mint:"#37d67a",lime:"#cddc39",canary:"#fbcd00",sunflower:"#ffac17",tangerine:"#ff6900",sunset:"#f44336",sierra:"#d44441",magenta:"#e91e63"})},74082:(e,t,i)=>{"use strict";i.d(t,{$:()=>DescriptionParser});var n=i(49947),s=i(7159),a=i(30643),o=i(31362);class DescriptionParser{constructor(e){this.capabilites={links:{enable:e.supportLinks,keepLabels:e.keepLinkLabels}}}parse(e,t){const i=[];if(!e)return[];return e.split("[").map((function(e,t){return 0===t?e:"["+e})).forEach((e=>{const n=this.findLink(e);n?-1===n.url.indexOf("javascript:")&&(this.addLinkChunk(i,n,t),this.addTextChunk(i,e.slice(n.markdown.length))):this.addTextChunk(i,e)})),i}findLink(e){const t=e.match(/\[([^\]]*)\]\((.*)\)/);if(!t)return null;const i=t[2];let n=1,s=0;for(;s<i.length&&("("===i[s]?n++:")"===i[s]&&n--,0!==n);)s++;const a=i.length-s;return{markdown:t[0].substring(0,t[0].length-a),label:t[1],url:this.conditionallyEncode(t[2].substring(0,s))}}conditionallyEncode(e){return this.needsEncoding(e)?encodeURI(e):e}needsEncoding(e){if(e.match(o.jx))return!0;let t=e;try{t=decodeURI(e)}catch(e){}return!1}addTextChunk(e,t){0!==t.length&&e.push({type:a.z.text,text:t})}addLinkChunk(e,t,i){if(!this.capabilites.links.enable)return void(this.capabilites.links.keepLabels&&this.addTextChunk(e,t.label));const o={label:t.label,url:t.url,type:n.U.EXT_LINK};-1===o.url.indexOf("://")&&(o.url="http://"+o.url);const r=-1!==o.url.indexOf("matterport.com/show"),d=-1!==o.url.indexOf(window.location.host+"/show");if(r||d){const e=-1!==o.url.indexOf(i),t=s.K.deserialize(o.url);e&&t?(o.type=n.U.NAVIGATION,o.navigationData=t):(o.type=n.U.MODEL,o.url+="&play=1")}e.push({type:a.z.link,link:o})}static getNumLinks(e){let t=0;return e.forEach((e=>{"link"===e.type&&void 0!==e.link&&t++})),t}}},20480:(e,t,i)=>{"use strict";i.d(t,{U:()=>Mattertag});var n=i(84428),s=i(15462),a=i(30643),o=i(78283),r=i(75287);var d=i(10385);class Mattertag extends r.T{constructor(e){super(),this.sid="",this.layerId="",this.created=new Date,this.modified=new Date,this.enabled=!0,this.label="",this.description="",this.parsedDescription=[],this.anchorPosition=new n.Vector3,this.anchorNormal=new n.Vector3(0,1,0),this.stemVector=new n.Vector3(0,0,(0,o._F)(1)),this.stemHeight=(0,o._F)(1),this.stemVisible=!0,this.fileAttachments=new d.d,this.externalAttachments=new d.d,this.sandboxAttachments=new d.d,this.color=s.I.MATTERTAG_BLUE.clone(),this.mediaType=a.z.none,this.mediaSrc="",this.widgetFrame=null,this.keywords=[],e&&Object.assign(this,e)}copy(e){this.anchorNormal.copy(e.anchorNormal),this.anchorPosition.copy(e.anchorPosition),this.color.copy(e.color),this.created.setTime(e.created.getTime()),this.description=e.description,this.enabled=e.enabled,this.layerId=e.layerId,this.floorId=e.floorId,this.roomId=e.roomId,this.label=e.label,this.mediaType=e.mediaType,this.mediaSrc=e.mediaSrc,this.modified.setTime(e.modified.getTime()),this.sid=e.sid,this.stemVector.copy(e.stemVector),this.stemHeight=e.stemHeight,this.stemVisible=e.stemVisible,this.fileAttachments=e.fileAttachments,this.externalAttachments=e.externalAttachments,this.sandboxAttachments=e.sandboxAttachments,this.objectAnnotationId=e.objectAnnotationId,this.keywords=e.keywords,this.icon=e.icon,this.parsedDescription=[];for(const t of e.parsedDescription)this.parsedDescription.push({link:t.link&&{label:t.link.label.slice(),url:t.link.url.slice(),type:t.link.type,navigationData:t.link.navigationData&&{floorVisibility:t.link.navigationData.floorVisibility,mode:t.link.navigationData.mode,sweepIndex:t.link.navigationData.sweepIndex,panoId:t.link.navigationData.panoId,position:t.link.navigationData.position&&t.link.navigationData.position.clone(),quaternion:t.link.navigationData.quaternion.clone(),zoom:t.link.navigationData.zoom}},text:t.text,type:t.type});return this.copyWidgetFrame(e.widgetFrame),this.commit(),this}clone(){return(new Mattertag).copy(this)}copyWidgetFrame(e){e?this.widgetFrame?(!function(e,t,...i){for(const n of i)e[n]=t[n]}(this.widgetFrame.size,e.size,"width","height"),this.widgetFrame.frame=e.frame):this.widgetFrame=Object.assign({},e):this.widgetFrame=null}refresh(e){this.fileAttachments.forEach((t=>{const i=e[t.id];i&&(t.thumbnailUrl.refreshFrom(i.thumbnailUrl),t.url.refreshFrom(i.url))}))}getPin(){const{anchorPosition:e,color:t,enabled:i,floorId:n,roomId:s,stemVector:a,stemHeight:o,layerId:r}=this;return{anchorPosition:e,color:t.getHexString(),floorId:n,roomId:s,layerId:r,stemEnabled:i,stemNormal:a,stemLength:o}}updateFromOptions(e,t,i){void 0!==e.color&&(this.color=new n.Color(e.color.r,e.color.g,e.color.b)),void 0!==e.enabled&&(this.enabled=e.enabled),void 0!==e.stemHeight&&(this.stemHeight=e.stemHeight,this.stemVector.copy(this.anchorNormal).setLength(e.stemHeight)),void 0!==e.stemVisible&&(this.stemVisible=e.stemVisible),void 0!==e.label&&(this.label=e.label.slice()),void 0!==e.description&&(this.description=e.description,this.parsedDescription=t.parse(this.description,i)),void 0!==e.floorId&&(this.floorId=e.floorId),void 0!==e.normal&&(this.anchorNormal.copy(e.normal).normalize(),this.stemVector.copy(e.normal).setLength(this.stemHeight)),void 0!==e.position&&this.anchorPosition.copy(e.position),void 0!==e.keywords&&(this.keywords=e.keywords.slice()),Object.prototype.hasOwnProperty.call(e,"icon")&&(this.icon=e.icon),void 0!==e.objectAnnotationId&&(this.objectAnnotationId=e.objectAnnotationId)}}},87048:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>MattertagDataModule});var n=i(97542),s=i(57956),a=i(20480),o=i(39880),r=i(79728),d=i(45905),l=i(90632),h=i(85979),c=i(635),m=i(71954),u=i(64567),g=i(2541),p=i(19648),v=i(47620),y=i(30643),w=i(85679),b=i(74082),f=i(29474);class ListSerializer{constructor(e){this.config=e}serialize(e){const{serializer:t}=this.config;if(!e||!Array.isArray(e)||!t)return null;const i=[];for(const n of e){const e=t.serialize(n);e&&i.push(e)}return i}deserialize(e){const{deserializer:t}=this.config;if(!e||!Array.isArray(e)||!t)return null;const i=[];for(const n of e){const e=t.deserialize(n);e&&i.push(e)}return i}}var T=i(17788),D=i(97998),C=i(73123),P=i(63665),M=i(65222),S=i(40731);const A=new D.Z("mds-mattertag-serializer");class MdsMattertagCreateSerializer{constructor(e,t){this.updateSerializer=e,this.mediaSerializer=t}serialize(e){const t=this.mediaSerializer.serialize(e),i=this.updateSerializer.serialize(e),n=null!==t?Object.assign(Object.assign({},t),i):i;return this.validate(n)?n:null}validate(e){if(!e)return!1;const t=["label","description","mediaUrl"].some((t=>t in e)),i=["floorId","enabled","anchorPosition"].filter((t=>!(t in e))),n=0===i.length,s=!!e.anchorPosition&&(0,S.u)(e.anchorPosition),a=n&&t&&s;return a||A.debug("Invalid MattertagDetails:",{missingFields:i,validPosition:s}),a}}var E=i(5823),k=i(9133),I=i(2569),N=i(84428),O=i(37519),V=i(29282);const R=new D.Z("mds-mattertag-serializer");class MdsMattertagDeserializer{constructor(e,t){this.fileAttachmentDeserializer=e,this.externalAttachmentDeserializer=t}deserialize(e){var t,i;if(!e||!this.validate(e))return R.debug("Deserialized invalid Mattertag data from MDS",e),null;const n=e.anchorPosition?I.ep.fromVisionVector(e.anchorPosition):void 0,s=e.stemNormal?I.ep.fromVisionVector(e.stemNormal):void 0,o=new a.U;if(o.sid=e.id,o.layerId=(null===(t=e.layer)||void 0===t?void 0:t.id)||"",o.label=e.label||"",o.description=e.description||"",o.enabled=!!e.enabled,e.color&&(o.color=new N.Color(e.color)),o.created=(0,k.p)(e.created),o.modified=(0,k.p)(e.modified),e.floor&&e.floor.id&&(o.floorId=e.floor.id),e.room&&e.room.id&&(o.roomId=e.room.id),n&&(o.anchorPosition=n),e.media&&(o.mediaSrc=e.media),e.mediaType&&(o.mediaType=(0,v.m7)(e.mediaType)),o.fileAttachments.replace(this.getFileAttachments(o,e)),o.externalAttachments.replace(this.getExternalAttachments(o,e)),(0,O.hj)(e.stemLength)&&(o.stemHeight=e.stemLength),s&&s instanceof N.Vector3){const t=s.clone().setLength(o.stemHeight);o.anchorNormal=s,o.stemVector=t,o.stemVisible=!!e.stemEnabled}else o.stemVector=new N.Vector3(0,0,0),o.stemVisible=!!e.stemEnabled;return o.objectAnnotationId=null===(i=e.objectAnnotation)||void 0===i?void 0:i.id,o.keywords=e.keywords||[],(0,V.r)(e.icon)&&(o.icon=e.icon),o}validate(e){if(!e)return!1;return["id","created","modified","enabled"].every((t=>t in e))}getFileAttachments(e,t){return this.fileAttachmentDeserializer?this.deserializeFileAttachments(t).sort(((e,t)=>e.created.getTime()-t.created.getTime())):[]}getExternalAttachments(e,t){if(!this.externalAttachmentDeserializer)return[];const i=this.deserializeExternalAttachments(t);if(t.media&&t.mediaType){const n=(0,v.Nc)(e.sid,t.media,t.mediaType);n&&i.push(n)}return i.sort(((e,t)=>e.created.getTime()-t.created.getTime()))}deserializeExternalAttachments(e){const t=e.externalAttachments||[],i=[];return t.forEach((t=>{var n;const s=null===(n=this.externalAttachmentDeserializer)||void 0===n?void 0:n.deserialize(t);s&&(s.parentId=e.id,s.parentType=E.ud.MATTERTAG,i.push(s))})),i}deserializeFileAttachments(e){const t=e.fileAttachments||[],i=[];return t.forEach((t=>{var n;const s=null===(n=this.fileAttachmentDeserializer)||void 0===n?void 0:n.deserialize(t);s&&(s.parentId=e.id,s.parentType=E.ud.MATTERTAG,i.push(s))})),i}}class MdsMattertagMediaRemoveSerializer{serialize(e){return this.validate(e)?{sid:e.sid}:null}validate(e){const t=null!==e&&!!e.mediaType&&e.mediaType===y.z.none;return null!==e&&!!e.sid&&t}}const x=new D.Z("mds-mattertag-serializer");class MdsMattertagMediaUpdateSerializer{serialize(e){const t=this.extractMedia(e);return this.validate(t)?t:null}validate(e){if(!e)return!1;const t=["mediaUrl","mediaType"].every((t=>t in e)),i=void 0!==e.mediaType&&["rich","photo","video"].includes(e.mediaType),n=t&&i;return n||x.debug("invalid media",e,{hasRequiredFields:t,hasValidMediaType:i}),n}extractMedia(e){const t={};return e.mediaSrc&&(t.mediaUrl=e.mediaSrc),e.mediaType&&e.mediaType in B&&(t.mediaType=e.mediaType),t.mediaUrl&&t.mediaType?t:null}}const B={[y.z.photo]:[E.L0.PHOTO],[y.z.rich]:[E.L0.RICH],[y.z.video]:[E.L0.VIDEO]};var L=i(69984);const F=new D.Z("mds-mattertag-serializer");class MdsMattertagUpdateSerializer{serialize(e){var t;if(!e)return null;const i={};return void 0!==e.enabled&&(i.enabled=e.enabled),void 0!==e.stemVisible&&(i.stemEnabled=e.stemVisible),void 0!==e.label&&(i.label=e.label),void 0!==e.description&&(i.description=e.description),void 0!==e.color&&(0,L.D5)(e.color)&&(i.color=(0,L.Ex)(e.color)),void 0!==e.anchorPosition&&(0,S.u)(e.anchorPosition)&&(i.anchorPosition=I.ep.toVisionVector(e.anchorPosition)),void 0!==e.anchorNormal&&(0,S.u)(e.anchorNormal)&&(i.stemNormal=I.ep.toVisionVector(e.anchorNormal)),void 0!==e.stemHeight&&(i.stemLength=e.stemHeight),Object.prototype.hasOwnProperty.call(e,"icon")&&(i.icon=null!==(t=e.icon)&&void 0!==t?t:""),void 0!==e.keywords&&(i.keywords=e.keywords),e.floorId&&(i.floorId=e.floorId),e.roomId&&(i.roomId=e.roomId),e.objectAnnotationId&&(i.objectAnnotationId=e.objectAnnotationId),i&&this.validate(i)?i:null}validate(e){if(!e)return!1;const t=["floorId","roomId","color","label","description","enabled","stemEnabled","stemLength","stemNormal","stemDirection","anchorPosition","objectAnnotationId","keywords","icon"],i=Object.keys(e).length>0,n=Object.keys(e).every((e=>t.includes(e))),s=n&&i;return s||F.debug("Invalid MattertagPatch:",{hasContents:i,hasValidFields:n,data:e}),s}}class MdsMattertagFileAttachmentSerializer{serialize(e){const t=e.fileAttachments;return void 0===t?null:{fileAttachments:t.map((e=>e.id))}}}var H=i(82686);const U=new D.Z("MdsMattertagStore");class MdsMattertagStore extends T.u{constructor(e,t){super(e),this.prefetchKey="data.model.mattertags";const i=t?new P.d:void 0;this.fileAttachmentDeserializer=t?new M.O:void 0,this.fileAttachmentSerializer=new MdsMattertagFileAttachmentSerializer,this.patchSerializer=new MdsMattertagUpdateSerializer,this.mediaUpdateSerializer=new MdsMattertagMediaUpdateSerializer,this.mediaRemovalSerializer=new MdsMattertagMediaRemoveSerializer,this.createSerializer=new MdsMattertagCreateSerializer(this.patchSerializer,this.mediaUpdateSerializer),this.tagDeserializer=new MdsMattertagDeserializer(this.fileAttachmentDeserializer,i),this.deserializer=new ListSerializer({deserializer:this.tagDeserializer})}async read(e){const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t,prefetchKey:this.prefetchKey,includeLayers:!!T.u.currentLayerId};return this.query(H.GetMattertags,i,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return null;return(this.deserializer.deserialize(n)||[]).reduce(((e,t)=>(e[t.sid]=t,e)),{})}))}async refreshFileAttachments(e){if(!this.fileAttachmentDeserializer)return{};const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t};return this.query(H.RefreshTagFileAttachments,i,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return{};const s=[];for(const e of n){if(!e.id||!e.fileAttachments)throw U.error("Failure refreshing tag file attachments"),new Error("Failure refreshing tag file attachments");e.fileAttachments.forEach((e=>{var t;const i=null===(t=this.fileAttachmentDeserializer)||void 0===t?void 0:t.deserialize(e);i&&s.push(i)}))}return s.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async create(e){const t=this.getViewId(),i=[];for(const n of e){const e=this.createSerializer.serialize(n);if(!e)throw U.error("Failure saving tag:",n.sid,n),new Error("Could not save Mattertag");const s=n.sid;let o=", $data: MattertagDetails!";const r={modelId:t,mattertagId:s,data:e},d=this.fileAttachmentSerializer.serialize(n);d&&(o+=", $fileAttachments: [ID!]",r.fileAttachments=d.fileAttachments);const l=`\n        ${this.shouldWriteLayerId()?`\n          patchLayer(id: "${t}", layerId: "${n.layerId}", writable: true) { id }\n          `:""}\n        addMattertag(\n          modelId: $modelId,\n          mattertagId: "${s}",\n          mattertag: $data) {\n            id\n            created\n            modified\n          }\n        ${d?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${s}",\n            fileAttachments: $fileAttachments) {\n              id\n            }`:""}\n        ${this.shouldWriteLayerId()?`\n          patchLayer(id: "${t}", layerId: "${T.u.currentLayerId}", writable: true) { id }\n          `:""}            \n      `,h=f.Ps`
        mutation AddMattertag($modelId: ID! ${o}) {
          ${l}
        }
      `,c=await this.mutate(h,r),m=(0,C.q)(c,"data.addMattertag"),u=(new a.U).copy(n);u.sid=m.id,u.commit(),i.push(u)}return i}async update(e,t){if(!e||0===e.length)return;let i="";const n={},s=this.getViewId();n.modelId=s;let a="";for(const t of e){const e=t.sid,o=this.mediaUpdateSerializer.serialize(t),r=this.mediaRemovalSerializer.serialize(t),d=this.patchSerializer.serialize(t),l=d||r||o,h=this.fileAttachmentSerializer.serialize(t);if(!(d||o||r||h))return void U.debug(`Nothing to update for tag ${e}`,t);if(l){const t=d||{};i+=`, $patch${e}: MattertagPatch!`,r&&(t.mediaUrl=""),o&&(t.mediaUrl=o.mediaUrl,t.mediaType=o.mediaType),n[`patch${e}`]=t}h&&(i+=`, $fileAttachments${e}: [ID!]`,n[`fileAttachments${e}`]=h.fileAttachments),n[`mediaType${e}`]=o&&o.mediaType,n[`mediaUrl${e}`]=o&&o.mediaUrl;a+=`\n        update${e}:\n        ${this.shouldWriteLayerId()?`\n          patchLayer(id: "${s}", layerId: "${t.layerId}", writable: true) { id }\n        `:""}\n        ${l?`patchMattertag(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            patch: $patch${e}) {\n              id\n            }`:""}\n        ${h?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            fileAttachments: $fileAttachments${e}) {\n              id\n            }`:""}\n      `}for(const{attachment:e,layerId:o}of t)(null==e?void 0:e.id)&&(null==e?void 0:e.parentId)&&e.parentType?(i+=`, $parentType${e.id}: ParentType!`,n[`parentType${e.id}`]=e.parentType,a+=`\n        unattach${e.id}:\n        ${this.shouldWriteLayerId()?`\n          patchLayer(id: "${s}", layerId: "${o}", writable: true) { id }\n        `:""}\n        removeFileAttachment(modelId: $modelId,\n                             attachmentId: "${e.id}",\n                             parentType: $parentType${e.id},\n                             parentId: "${e.parentId}") `):U.debug("MattertagStore.update: unable to remove file attachment");this.shouldWriteLayerId()&&(a+=`\n        restoreLayer: patchLayer(id: "${s}", layerId: "${T.u.currentLayerId}", writable: true) { id }\n      `);const o=f.Ps`
      mutation tagUpdate($modelId: ID! ${i}) {
        ${a}
      }
    `;await this.mutate(o,n)}async delete(e){if(!e||0===e.length)return;const t=this.getViewId();let i="";for(const n of e){if(!n||n&&!n.sid)throw new Error("MattertagStore.delete failed");this.shouldWriteLayerId()&&(i+=`setLayer${n.sid}: patchLayer(id: "${t}", layerId: "${n.layerId}", writable: true) { id } `),i+=`delete${n.sid}: deleteMattertag(modelId: $modelId, mattertagId: "${n.sid}") `}this.shouldWriteLayerId()&&(i+=`\n        restoreLayer: patchLayer(id: "${t}", layerId: "${T.u.currentLayerId}", writable: true) { id }\n      `);const n=f.Ps`
      mutation batchDeleteMattertag($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(n,{modelId:t}).then((()=>{}))}}var G=i(25985),z=i(59370),j=i(59279),_=i(79232),$=i(33824),W=i(54244),J=i(89570),K=i(60975),Y=i(71776),q=i(64918),Z=i(43470),Q=i(86283),X=i(36120),ee=i(56163),te=i(12039),ie=i(25071),ne=i(39689),se=i(62612);class SharedTagSearchResultItem extends ee.K{constructor(e,t,i,n,s){super(e),this.mattertag=t,this.typeId=n,this.tagIconsEnabled=s,this.id=this.mattertag.sid,this.title=this.mattertag.label,this.description=this.textParser.getPlainText(this.mattertag.description),this.icon=`icon-${(0,ne.m)(se.Er.MATTERTAG,this.mattertag.icon,this.tagIconsEnabled)}`,this.floorId=this.mattertag.floorId,this.layerId=this.mattertag.layerId,this.color=function(e){return`rgb(${255*e.r}, ${255*e.g}, ${255*e.b})`}(this.mattertag.color),this.textParser=i}}class TagSearchResultItem extends SharedTagSearchResultItem{constructor(){super(...arguments),this.onSelect=async()=>{super.onSelect(),await this.commandBinder.issueCommand(new te.OR({pinPosition:this.mattertag.getPin(),transition:q.n.FadeToBlack}));!(0,ie.OR)()?this.commandBinder.issueCommand(new Z.bd(this.id,Q.J.TAG)):this.commandBinder.issueCommand(new Z.oM(this.id,Q.J.TAG))}}}class MattertagSearchResultItem extends SharedTagSearchResultItem{constructor(){super(...arguments),this.onSelect=()=>{super.onSelect(),this.commandBinder.issueCommand(new X.Y(this.mattertag.sid,q.n.FadeToBlack))}}}var ae=i(52528),oe=i(43037),re=i(71166),de=i(38399),le=i(48945),he=i(75557);const{TAGS:ce}=de.Z.SHOWCASE,me=new ae.v({links:!0}),ue="0"===(0,j.eY)("mt"),ge="MP_MATTERTAG_SEARCH_GROUP";function pe(e,t,i,n,s,a){const o=n.tryGetProperty(le.RV,!1),r=(n,r,d=[])=>{const l=[],h=s.application===W.Mx.WORKSHOP;return t.iterate((t=>{if(!(h||t.enabled&&i.layerToggled(t.layerId)))return;if(t.objectAnnotationId)return;let s=n(t.label,me.getPlainText(t.description));s&&d.length>0&&(s=t.keywords.length>0&&t.keywords.some((e=>d.includes(e)))),s&&l.push((t=>new(a?TagSearchResultItem:MattertagSearchResultItem)(e,t,me,ge,o))(t))})),a?e.issueCommand(new oe.Sq(l.map((e=>e.id)))):e.issueCommand(new he.n(l.map((e=>e.id)))),l},d=new K.u(n,{[Y.re]:!0}),l=t=>{a?e.issueCommand(new oe.aI(t)):e.issueCommand(new he.E(t)),d.toggle(t)},h={renew:()=>{e.issueCommandWhenBound(new re.c6({id:ge,groupPhraseKey:ce.SEARCH_GROUP_HEADER,getSimpleMatches:r,registerChangeObserver:e=>t.onChanged(e),onSearchActivatedChanged:l,getKeywords:t.getTagKeywords.bind(t),groupOrder:20,groupIcon:"toolbar-mattertags"}))},cancel:()=>{e.issueCommandWhenBound(new re.Pe(ge))}},c=e=>{const t=e===W.Mx.WORKSHOP;!ue||t?h.renew():h.cancel()},m=s.onPropertyChanged("application",c);return c(s.application),new J.V(h,m)}var ve=i(5666),ye=i(80742),we=i(34029);class MattertagDataModule extends n.Y{constructor(){super(...arguments),this.name="mattertag-data",this.monitor=null,this.filesToUnattach=[],this.getDiscPositions=(()=>{const e=[],t={},i={},n=new N.Vector3;return async s=>(e.length=0,s.tags.forEach((s=>{const a=this.data.getTag(s);a&&(i[s]||(i[s]=new N.Vector3),i[s].copy(a.anchorPosition).add(a.stemVector),t[s]||(t[s]=new N.Vector2),(0,z.q9)(this.cameraData,i[s],t[s],n),e.push({sid:s,screen:n.z>1?null:t[s],world:i[s]}))})),e)})(),this.addTag=async e=>{const{positionOptions:t,standardOptions:i,mediaOptions:n}=e,s=Object.assign(Object.assign({},t),i),a=this.createTag((0,o.O1)(11),s,[],n);return a.modified=new Date,a.commit(),a.sid},this.editTag=async e=>{const{sid:t,positionOptions:i,standardOptions:n,mediaOptions:s}=e,a=Object.assign(Object.assign({},i),n),o=this.data.getTag(t);o&&(this.updateTag(o,a,s),o.modified=new Date,o.commit())},this.removeTag=async e=>{const t=this.data.getTag(e.sid);if(void 0!==t&&this.data.removeTag(e.sid))return t&&t.objectAnnotationId&&this.engine.commandBinder.issueCommand(new ve.SO(t.objectAnnotationId)),e.sid},this.saveNewTag=async e=>{const{id:t,properties:i,embed:n,fileAttachments:s}=e,a=n?{mediaSrc:n.src,mediaType:(0,v.F5)(n.mediaType)}:void 0;return this.createTag(t,i,s,a),this.engine.commandBinder.issueCommand(new c.VQ({dataTypes:[r.g.MATTERTAGS]}))},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:s,embed:a}=e,o=this.data.getTag(t);if(!o)return void this.log.debug("Cannot save non-existent tag");const d=a?(0,v.F5)(a.mediaType):y.z.none,l=a?a.src:"";void 0!==a&&(l===o.mediaSrc&&d!==o.mediaType||this.updateExternalAttachment(o,a));const h=void 0!==a?{mediaSrc:l,mediaType:d}:void 0;return this.updateTag(o,i,h),n.forEach((e=>{o.fileAttachments.push(e)})),this.removeFileAttachments(o,s),this.data.addTag(o),this.data.updateOnStaleCallbacks(t),this.engine.commandBinder.issueCommand(new c.VQ({dataTypes:[r.g.MATTERTAGS]}))}}async init(e,t){const{readonly:i,baseUrl:n,newTagsEnabled:a}=e;this.engine=t,this.config=e,this.descParser=new b.$({supportLinks:!0,keepLinkLabels:!0}),[this.meshQueryModule,this.cameraData,this.layersData]=await Promise.all([t.getModuleBySymbol(s.y.MESH_QUERY),t.market.waitForData(G.M),t.market.waitForData(ye.R)]),this.store=new MdsMattertagStore({readonly:i,includeDisabled:!i,baseUrl:n},a);const o=await t.getModuleBySymbol(s.y.STORAGE);if(this.data=new w.n,this.bindings.push(this.store.onNewData((async i=>{this.initializeTagData(i,t.market,e.parserOptions)})),t.commandBinder.addBinding(p.cH,this.getDiscPositions),t.commandBinder.addBinding(p.Fz,this.addTag),t.commandBinder.addBinding(p.Ek,this.editTag),t.commandBinder.addBinding(p.Gn,this.removeTag)),await this.store.refresh(),!i){this.bindings.push(t.commandBinder.addBinding(p.Mm,this.saveNewTag),t.commandBinder.addBinding(p.qq,this.saveTag),o.onSave((()=>this.save()),{dataType:r.g.MATTERTAGS}),o.onPublish((()=>this.onAfterPublish()),{dataType:r.g.MATTERTAGS,phase:d.Q.AFTER}));const e=await t.market.waitForData(l.Q);e.setRevertableType(r.g.MATTERTAGS),e.setPublishableType(r.g.MATTERTAGS),this.monitor=new u.c(this.data.collection,{aggregationType:g.E.Manual,shallow:!0}),this.configureTrash()}t.market.register(this,w.n,this.data);(async()=>{const[e,i]=await Promise.all([this.engine.market.waitForData(we.e),this.engine.market.waitForData(W.pu)]);a&&await t.getModuleBySymbol(s.y.TAGS);const n=pe(this.engine.commandBinder,this.data,this.layersData,e,i,a);this.bindings.push(n)})()}dispose(e){this.store.dispose(),super.dispose(e)}async save(){if(this.monitor&&this.monitor.commitChanges(),!this.store||!this.monitor)return void this.log.warn("Mattertags changes will NOT be saved");const e=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const t=e.map((e=>{var t;const i=e.diff.layerId||(null===(t=this.data.getTag(e.index))||void 0===t?void 0:t.layerId);return Object.assign({layerId:i},e)})).filter((e=>!this.layersData.isInMemoryLayer(e.layerId))),i=t.filter((e=>e.action===m.KI.removed)).map((e=>({sid:e.index,layerId:e.layerId}))),n=t.filter((e=>e.action===m.KI.added)).map((e=>this.data.getTag(e.index))),s=t.filter((e=>e.action===m.KI.updated)).map((e=>{const t=Object.assign({sid:e.index,layerId:e.layerId},e.diff);return"mediaSrc"in t&&(t.mediaType=this.data.getTag(e.index).mediaType),t.objectAnnotationId=this.data.getTag(e.index).objectAnnotationId,t}));await this.store.delete(i),await this.store.create(n),await this.store.update(s,this.filesToUnattach)}clearDiffRecord(){this.monitor&&this.monitor.clearDiffRecord()}initializeTagData(e,t,i){var n;const s=i?new b.$(i):this.descParser;this.data.atomic((()=>{this.layersData.replaceBackendLayers(this.data.collection,{})})),this.data.atomic((()=>{for(const t in e){const i=e[t];i.parsedDescription=s.parse(e[t].description,this.layersData.currentViewId),this.meshQueryModule.inferMeshIdsFromPoint(i,i.anchorPosition),this.data.addTag(i)}})),this.data.onStale=()=>this.store.refreshFileAttachments(),this.data.updateOnStaleCallbacks(),null===(n=this.monitor)||void 0===n||n.clearDiffRecord()}createTag(e,t,i,n){let s=e;for(;this.data.getTag(s);)s=(0,o.O1)(11);const r=new a.U;if(r.sid=s,r.layerId=this.layersData.currentLayer.id,this.config.newTagsEnabled&&n){const e=(0,v.gj)(n.mediaType);if(n.mediaSrc&&e){const t=(0,v.Nc)(s,n.mediaSrc,e);t&&r.externalAttachments.push(t)}}return t.objectAnnotationId&&(r.objectAnnotationId=t.objectAnnotationId),t.keywords&&(r.keywords=t.keywords),i.forEach((e=>{r.fileAttachments.push(e)})),this.updateTag(r,t,n),this.data.addTag(r),this.data.updateOnStaleCallbacks(s),r}updateTag(e,t,i){e.updateFromOptions(t,this.descParser,this.layersData.currentViewId),void 0!==(null==i?void 0:i.mediaType)&&(e.mediaType=i.mediaType),void 0!==(null==i?void 0:i.mediaSrc)&&(e.mediaSrc=i.mediaSrc.slice())}removeFileAttachments(e,t){const{fileAttachments:i}=e;t.forEach((t=>{const n=i.findIndex((e=>e.id===t.id));-1!==n?(i.splice(n,1),this.filesToUnattach.push({attachment:t,layerId:e.layerId})):this.log.debug("Attempting to remove an attachment that is not in the tag")}))}updateExternalAttachment(e,t){const{mediaSrc:i}=e;i&&e.externalAttachments.replace([]),t&&e.externalAttachments.replace([t])}async onAfterPublish(){this.verifyDataIntegrity()}async verifyDataIntegrity(){const e="data-integrity"===(0,j.eY)("error",""),t=this.data.getTagCount(),i=await this.store.read().catch((e=>{this.log.debug("Mattertag integrity check failed",e)}))||{},n=Object.keys(i).length;(n!==t||e)&&this.engine.broadcast(new h.Qq(`Unexpected tag count after publish (${n}/${t})`,r.g.MATTERTAGS,e))}async configureTrash(){const{readonly:e}=this.config,{commandBinder:t}=this.engine;if(e)return;const i=r.g.MATTERTAGS,n=new MdsMattertagDeserializer,s={objectType:i,create:e=>new _.F({label:e.label||(0,o.aS)(e.description||"",100)||"Mattertag",objectId:e.id,objectType:i,created:new Date,value:e}),restore:e=>{const t=n.deserialize(e.value);t&&this.data.addTag(t)}},a=await t.issueCommandWhenBound(new $.B(s));this.bindings.push(a)}}},47620:(e,t,i)=>{"use strict";i.d(t,{m7:()=>l,F5:()=>h,gj:()=>c,Nc:()=>u});var n=i(30643),s=i(32347),a=i(71608),o=i(92558),r=i(56367),d=i(5823);function l(e){const t={[d.L0.VIDEO]:n.z.video,[d.L0.PHOTO]:n.z.photo,[d.L0.RICH]:n.z.rich};return e in t?t[e]:n.z.none}function h(e){switch(e){case s.DD.VIDEO:return n.z.video;case s.DD.IMAGE:return n.z.photo;case s.DD.RICH:return n.z.rich}return n.z.none}function c(e){switch(e){case n.z.video:return d.L0.VIDEO;case n.z.photo:return d.L0.PHOTO;case n.z.rich:return d.L0.RICH}return null}function m(e){return{[d.L0.VIDEO]:s.DD.VIDEO,[d.L0.PHOTO]:s.DD.IMAGE,[d.L0.RICH]:s.DD.RICH}[e]}function u(e,t,i){return t?new a.P({id:(0,o.fV)(),created:new Date,parentId:e,parentType:d.ud.MATTERTAG,mediaType:m(i),src:t,url:new r.n(t,null),thumbnailUrl:new r.n(t,null),category:s.G$.EXTERNAL}):null}},28812:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>MattertagMeshModule});var n=i(97542),s=i(57956),a=i(34029),o=i(85679),r=i(54244),d=i(62612),l=i(48945),h=i(71776),c=i(67511),m=i(87926),u=i(64366),g=i(80742);class MattertagMeshModule extends n.Y{constructor(){super(...arguments),this.name="mattertag-mesh",this.visibilityDirty=!0,this.unanchoredTagOpacity=1,this.anchoredTagOpacity=1,this.addNewTagMesh=(e,t)=>{this.settings.tryGetProperty(l.RY,!1)||this.pinRenderer.updatePin(e.sid,d.Er.MATTERTAG,Object.assign(Object.assign({},e),{stemNormal:e.stemVector,stemLength:e.stemHeight,stemEnabled:e.stemVisible,color:`#${e.color.getHexString()}`,icon:d.Qk[d.Er.MATTERTAG]}),this.backgroundTexture,this.pinsModule.iconMaskTexture)},this.removeTagMesh=(e,t)=>{this.settings.tryGetProperty(l.RY,!1)||this.pinRenderer.removePin(e.sid)},this.updateTagMesh=(e,t)=>{this.addNewTagMesh(e,e.sid)},this.initializeTagVisibility=()=>{if(this.settings.tryGetProperty(l.RY,!1))return;const e=this.settings.tryGetProperty(h.re,!0);this.pinRenderer.setPinOpacityByType(d.Er.MATTERTAG,e?1:0),e&&this.mattertagData.iterate((e=>{this.pinRenderer.setPinVisible(e.sid,e.enabled)}))},this.updateTagVisibility=()=>{if(this.settings.tryGetProperty(l.RY,!1))return;this.settings.tryGetProperty(h.re,!1)?this.fadePinsToState():this.pinRenderer.fadePinOpacityByType(d.Er.MATTERTAG,0)},this.selectedTagChanged=()=>{if(!this.settings.tryGetProperty(l.RY,!1)){if(this.mattertagViewData.selectedTag&&!this.mattertagViewData.navigating){const e=this.mattertagData.getTag(this.mattertagViewData.selectedTag);this.pinRenderer.showSelectedMesh(d.Er.MATTERTAG,e.sid)}this.mattertagViewData.selectedTag||this.pinRenderer.hideSelectedMesh()}}}async init(e,t){[this.mattertagData,this.pinsModule,this.settings,this.mattertagViewData,this.layersData,this.appData]=await Promise.all([t.market.waitForData(o.n),t.getModuleBySymbol(s.y.PINS),t.market.waitForData(a.e),t.market.waitForData(c.P5),t.market.waitForData(g.R),t.market.waitForData(r.pu)]),this.pinRenderer=this.pinsModule.pinRenderer;this.pinsModule.fontManager.getFont(this.pinsModule.fontId).onChanged((()=>{this.mattertagData.iterate((e=>{this.addNewTagMesh(e,e.sid)}))}));const i=()=>{this.visibilityDirty=!0};this.bindings.push(this.mattertagData.collection.onElementChanged({onAdded:this.addNewTagMesh,onRemoved:this.removeTagMesh,onUpdated:this.updateTagMesh}),this.mattertagViewData.onChanged(i),this.appData.onChanged(i),this.settings.onPropertyChanged(h.re,i),this.mattertagData.onChanged(i),this.mattertagViewData.onSelectedTagChanged(this.selectedTagChanged),this.mattertagViewData.onNavigatingTagChanged(this.selectedTagChanged),this.layersData.onCurrentLayersChanged(i)),this.backgroundTexture=(0,m.p)(u),this.mattertagData.iterate((e=>{this.addNewTagMesh(e,e.sid)})),this.initializeTagVisibility()}dispose(e){this.pinRenderer.removePinsByType(d.Er.MATTERTAG),this.backgroundTexture.dispose(),super.dispose(e)}onUpdate(e){this.visibilityDirty&&(this.visibilityDirty=!1,this.updateTagVisibility())}showAnchorMesh(e){this.pinRenderer.showAnchorMesh(d.Er.MATTERTAG,e.sid,Object.assign(Object.assign({},e),{stemNormal:e.stemVector,stemLength:e.stemHeight})),this.unanchoredTagOpacity=.5,this.anchoredTagOpacity=1,this.anchorTagId=e.sid,this.fadePinsToState()}hideAnchorMesh(){this.unanchoredTagOpacity=1,this.anchoredTagOpacity=1,this.anchorTagId=void 0,this.pinRenderer.hideAnchorMesh(),this.fadePinsToState()}resetPinOpacity(){this.fadePinsToState()}changeDiscOpacity(e,t){this.pinRenderer.setPinOpacity(e,t)}setTagVisibility(e){this.pinRenderer.setPinTypeVisible(d.Er.MATTERTAG,e)}setTagVisible(e,t){this.pinRenderer.setPinVisible(e,t)}setOverrideMaterial(e,t,i){this.pinRenderer.setPinRenderOverrides(e,t,i)}visibleByLayer(e){return this.appData.application===r.Mx.WORKSHOP||this.layersData.layerToggled(e)}fadePinsToState(){const{selectedTag:e,idVisibilityEnabled:t,idVisibility:i}=this.mattertagViewData;this.mattertagData.iterate((n=>{const s=e===n.sid,a=this.visibleByLayer(n.layerId),o=!t||i.has(n.sid),r=s||n.enabled&&a&&o;this.pinRenderer.setPinVisible(n.sid,r);const d=n.sid===this.anchorTagId?this.anchoredTagOpacity:this.unanchoredTagOpacity;this.pinRenderer.fadePinOpacity(n.sid,r?d:0)}))}}},75557:(e,t,i)=>{"use strict";i.d(t,{E:()=>MattertagsVisibilityFilterEnabledCommand,n:()=>FilterVisibleMattertagsCommand});var n=i(19663);class MattertagsVisibilityFilterEnabledCommand extends n.m{constructor(e){super(),this.payload={enabled:e}}}class FilterVisibleMattertagsCommand extends n.m{constructor(e){super(),this.payload={ids:e}}}},81149:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>MattertagViewDataModule});var n=i(84428),s=i(97542),a=i(57956),o=i(85679),r=i(19648),d=i(25985),l=i(55502),h=i(18923),c=i(5090),m=i(10374),u=i(64918),g=i(51397),p=i(54244),v=i(95882),y=i(71776),w=i(48945),b=i(34029),f=i(36120),T=i(67511),D=i(12039),C=i(90304),P=i(75557),M=i(62612),S=i(13132),A=i(80742);class MattertagViewDataModule extends s.Y{constructor(){super(...arguments),this.name="mattertags-viewdata",this.distance=new n.Vector3,this.cameraPosition=new n.Vector3,this.hoverTimeout=0,this.updateViewData=()=>{this.data.iterate((e=>{this.viewData.derivedData[e.sid]=this.makeViewDataForMattertag(e)})),this.viewData.commit()},this.makeViewDataForMattertag=e=>{const t=this.viewData.activeBillboards.get(e.sid),i=this.viewData.selectedTag===e.sid,n=t?t.position:null,s=t?t.distance:0;return{position:n,selected:i,located:!(!n||!s),closeTheTag:!t||t.closing||!(i||!this.viewData.selectedTag),navigating:!(!this.viewData.navigating||this.viewData.navigating!==e.sid),navigatingPosition:i?this.viewData.getNavigatingPosition():void 0,positioned:!1,distance:s,stemHeight:e.stemHeight,visible:e.enabled,color:`#${e.color.getHexString()}`,onTagDirectionChanged:this.onTagDirectionChanged}},this.onCameraUpdate=e=>{this.viewData.activeBillboards.keys.length>0&&(this.cameraPosition.copy(e.pose.position),this.updateActiveBillboards(this.viewData.activeBillboards.keys),this.viewData.commit())},this.updateBillboardData=(e,t)=>{const i=this.viewData.activeBillboards.get(e);i&&(Object.assign(i,t),i.commit())},this.addActiveBillboard=e=>{this.viewData.activeBillboards.has(e)||this.viewData.activeBillboards.set(e,new T.ZJ(e))},this.removeFromActiveBillboards=e=>{this.viewData.activeBillboards.has(e)&&this.viewData.activeBillboards.delete(e)},this.handleOpenBillboardChanged=()=>{const e=this.viewData.openTag;this.viewData.activeBillboards.atomic((()=>{e&&(this.viewData.activeBillboards.get(e)?(window.clearTimeout(this.viewData.activeBillboards.get(e).timeoutId),this.updateBillboardData(e,{timeoutId:0,closing:!1})):this.addActiveBillboard(e),this.updateActiveBillboards([e]));for(const t of this.viewData.activeBillboards.keys){if(t===e)return;this.updateBillboardData(t,{closing:!0,direction:void 0,timeoutId:window.setTimeout((()=>{this.removeFromActiveBillboards(t)}),1e3)})}}))},this.updateActiveBillboards=async e=>{try{await this.engine.commandBinder.issueCommand(new r.cH(e)).then((e=>{for(const t of e)this.updateBillboardData(t.sid,{distance:this.distance.copy(this.cameraPosition).distanceToSquared(t.world),position:t.screen})}))}catch(e){this.log.error(`Could not get Disc Positions for tags - ${e}`)}},this.onSweepChosen=e=>{this.viewData.setNavigatingPosition(e)},this.onDiscHoverChange=e=>{if(this.settings.tryGetProperty(w.RY,!1))return;if(e.pinType!==M.Er.MATTERTAG)return;const t=this.viewData.toolState;if(t!==T.rI.CLOSED&&this.viewData.selectedTag)return;const i=this.data.getTag(e.id);if(i&&i.enabled)if(clearTimeout(this.hoverTimeout),e.hovering)t!==T.rI.EDITING&&(this.hoverTimeout=window.setTimeout((()=>this.discHoverChange(e.id,e.hovering)),125));else{if(e.id===this.viewData.selectedTag)return;this.discHoverChange(e.id,!1)}},this.onDiscClicked=e=>{if(this.settings.tryGetProperty(w.RY,!1))return;const t=this.viewData.toolState;e.pinType===M.Er.MATTERTAG&&t===T.rI.CLOSED&&(e.id===this.viewData.selectedTag?this.closeBillboard(e.id):(this.viewData.setSelectedTag(e.id),this.navigateToTag(e.id,u.n.Interpolate)))},this.onSweepExit=e=>{e.toSweep&&e.fromSweep!==e.toSweep&&(this.viewData.isCreatingNewMattertag()||this.viewData.closeOpenBillboard())},this.onAppChange=e=>{this.currentApp=e.application,this.viewData.closeOpenBillboard(),this.viewData.setSelectedTag(null)},this.onViewmodeChange=e=>{null===this.viewData.navigating&&(0,v.Bw)(e.fromMode)&&this.viewData.closeOpenBillboard()},this.onTagDirectionChanged=(e,t)=>{this.updateBillboardData(e,{direction:t})},this.filterVisibleTags=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit()},this.tagVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit()}}async init(e,t){this.engine=t;const[i,n,s,r]=await Promise.all([t.market.waitForData(o.n),t.market.waitForData(b.e),t.market.waitForData(d.M),t.getModuleBySymbol(a.y.PINS),t.market.waitForData(A.R)]);this.data=i,this.settings=n,this.cameraData=s,this.pinRenderer=r.pinRenderer,this.viewData=t.market.tryGetData(T.P5)||new T.P5(this.data),t.market.register(this,T.P5,this.viewData),this.viewData.setViewDataFactory(this.makeViewDataForMattertag),this.updateViewData(),this.settings.onPropertyChanged(y.re,(e=>{0!==e&&this.viewData.closeOpenBillboard()})),this.bindings.push(t.subscribe(S.tP,this.onDiscHoverChange),t.subscribe(S.F7,this.onDiscClicked),t.subscribe(h.Z,this.onSweepExit),t.subscribe(c.Z,this.onViewmodeChange),t.subscribe(m.bS,this.onAppChange),this.cameraData.onChanged(this.onCameraUpdate),this.data.onChanged(this.updateViewData),this.viewData.onOpenTagChanged(this.handleOpenBillboardChanged),this.viewData.activeBillboards.onChanged(this.updateViewData),t.commandBinder.addBinding(P.n,this.filterVisibleTags),t.commandBinder.addBinding(P.E,this.tagVisbilityFilterEnabled)),this.engine.commandBinder.addBinding(f.Y,(async e=>this.navigateToTag(e.sid,e.transition,e.navigateToDisabled)))}openBillboard(e){const t=this.viewData.tagCapabilities[e];t&&!t.opening||this.viewData.openBillboard(e)}closeBillboard(e){this.viewData.closeBillboard(e)}async navigateToTag(e,t,i=!1){if(this.settings.tryGetProperty(w.RY,!1))return;const n=this.data.getTag(e);if(!n)throw new Error("No tag with that sid was found");if(!n.enabled&&!i)throw new Error("Cannot navigate to a disabled mattertag");const s=this.viewData.tagCapabilities[e];if(s&&!s.navigating)return;this.viewData.setNavigatingTag(e);const a=this.viewData.activeBillboards.get(e),o=a&&a.direction,r=this.tagDirectionToOrientationAdjust(o);return this.engine.commandBinder.issueCommand(new D.OR({pinPosition:n.getPin(),transition:t,orientationAdjust:r,onSweepChosen:this.onSweepChosen})).then((()=>{this.viewData.setSelectedTag(e),this.onTagVisited(e),this.openBillboard(e),this.viewData.setNavigatingTag(null),this.viewData.setNavigatingPosition(void 0)})).catch((e=>{this.log.debug(e),this.viewData.setNavigatingTag(null),this.viewData.setNavigatingPosition(void 0)}))}onTagVisited(e){this.viewData.visitTag(e),this.engine.broadcast(new l.dJ(e,g.V.OPEN)),this.engine.broadcast(new l.QY(e))}discHoverChange(e,t){if(this.settings.tryGetProperty(w.RY,!1))return;if(!this.data.getTag(e))return;const i=this.viewData.openTag===e;t&&!i?(this.currentApp===p.Mx.SHOWCASE&&this.engine.broadcast(new l.dJ(e,g.V.HOVER)),this.openBillboard(e),this.pinRenderer.setPinColorVariant(e,M.K_.HIGHLIGHTED)):!t&&i&&(this.closeBillboard(e),this.pinRenderer.setPinColorVariant(e,M.K_.DEFAULT)),this.viewData.commit()}tagDirectionToOrientationAdjust(e,t=new n.Quaternion){const i=.25;let s=0,a=0;if(e){switch(e){case T.Pg.RIGHT:case T.Pg.RIGHT_DOWN:case T.Pg.RIGHT_UP:s=-.25;break;case T.Pg.LEFT:case T.Pg.LEFT_DOWN:case T.Pg.LEFT_UP:s=i}switch(e){case T.Pg.UP:case T.Pg.LEFT_UP:case T.Pg.RIGHT_UP:a=i;break;case T.Pg.DOWN:case T.Pg.LEFT_DOWN:case T.Pg.RIGHT_DOWN:s=-.25}}else s=-.25,a=-.25;return t.setFromAxisAngle(C.f.RIGHT,a),t.multiply((new n.Quaternion).setFromAxisAngle(C.f.UP,s)),t}}},84810:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AddCommentCommand:()=>X.Df,CancelCommentChangesCommand:()=>X.oH,CancelCommentSearchCommand:()=>X.av,CancelNewNoteCommand:()=>X.gc,CloseNoteCommand:()=>X._N,Comment:()=>Comment,DeleteCommentCommand:()=>X.mH,DeleteNoteCommand:()=>X.sG,EditCommentCommand:()=>X.x4,FilterVisibleNotesCommand:()=>X.Gx,FocusCommentMessage:()=>ee.J,HashtagData:()=>Q.c,Note:()=>Note,NoteColorVariant:()=>j.Y,NoteResolutionChangeMessage:()=>ee.h,NotesData:()=>NotesData,NotesFilter:()=>j.$,NotesModeToggleCommand:()=>X.yK,NotesPhase:()=>z.U,NotesViewData:()=>Z.X,NotesVisibilityFilterEnabledCommand:()=>X.GV,OpenNoteListViewCommand:()=>X.Zd,OpenNoteToCommentCommand:()=>X.yW,ResolveNoteCommand:()=>X.yp,SaveNewNoteCommand:()=>X.FB,SaveNoteAppearanceCommand:()=>X.oE,SaveNoteChangesCommand:()=>X.kd,StartNewNoteCommand:()=>X.VI,ToggleNoteToolEditorCommand:()=>X.df,UpdateCommentCommand:()=>X.Uw,default:()=>Ae});var n=i(97542),s=i(57956),a=i(35895),o=i(87926),r=i(28636),d=i(39880),l=i(64918),h=i(52528),c=i(95160),m=i(76631),u=i(40964),g=i(89549),p=i(91380),v=i(92211),y=i(5823),w=i(20436),b=i(66197),f=i(5686),T=i(10374),D=i(53954),C=i(23254),P=i(34029),M=i(5135),S=i(79727),A=i(80742),E=i(14630),k=i(64773),I=i(12039),N=i(72936),O=i(62612),V=i(60083),R=i(13132),x=i(43470),B=i(86283),L=i(16935),F=i(5604),H=i(44877),U=i(35446),G=i(21149),z=i(38965),j=i(22744),_=i(84428),$=i(75287),W=i(10385),J=i(67622),K=i(39693);class Note extends $.T{constructor(e){super(),this.id="",this.layerId="",this.color=K.Rn,this.anchorPosition=new _.Vector3,this.stemNormal=new _.Vector3,this.stemLength=K.ZP.stem.length,this.stemEnabled=!0,this.created=new Date,this.modified=new Date,this.lastCommentMs=(new Date).getTime(),this.resolved=!1,this.user=(0,J.Q)(""),this.comments=(0,W.C)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.resolved=e.resolved,this.color=e.color,this.floorId=e.floorId,this.roomId=e.roomId,this.anchorPosition.copy(e.anchorPosition),this.stemNormal.copy(e.stemNormal),this.stemLength=e.stemLength,this.stemEnabled=e.stemEnabled,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.lastCommentMs=e.lastCommentMs,this.comments.replace(e.comments.values()),this.commit(),this}getComment(e){return this.comments.find((t=>t.id===e))||null}updateComment(e){const t=this.comments.findIndex((t=>t.id===e.id));-1!==t&&(e.assetId=this.id,this.comments.update(t,e))}deleteComment(e){const t=this.comments.findIndex((t=>t.id===e));-1!==t&&this.comments.splice(t,1)}}var Y=i(67992),q=i(15637);class NotesData extends Y.V{constructor(e){super(),this.name="notes-data",this.notes=(0,q.q)(e)}iterate(e){for(const t of this.notes)e(t)}updateNote(e){this.notes.has(e.id)?this.notes.get(e.id).copy(e):this.notes.set(e.id,e)}updateNoteProperties(e,t){if(this.notes.has(e)){const i=this.notes.get(e);let n=!1;void 0!==t.resolved&&t.resolved!==i.resolved&&(i.resolved=t.resolved,n=!0),void 0!==t.color&&t.color!==i.color&&(i.color=t.color,n=!0),void 0!==t.anchorPosition&&t.anchorPosition!==i.anchorPosition&&(i.anchorPosition=t.anchorPosition,n=!0),void 0!==t.stemNormal&&t.stemNormal!==i.stemNormal&&(i.stemNormal=t.stemNormal,n=!0),void 0!==t.stemLength&&t.stemLength!==i.stemLength&&(i.stemLength=t.stemLength,n=!0),void 0!==t.stemEnabled&&t.stemEnabled!==i.stemEnabled&&(i.stemEnabled=t.stemEnabled,n=!0),void 0!==t.floorId&&t.floorId!==i.floorId&&(i.floorId=t.floorId,n=!0),void 0!==t.roomId&&t.roomId!==i.roomId&&(i.roomId=t.roomId,n=!0),n&&i.commit()}}removeNote(e){this.notes.has(e)&&(this.notes.delete(e),this.commit())}getNote(e){return this.notes.get(e)}getNoteProperties(e){const t=this.notes.get(e);if(!t)return null;return Object.assign({},t)}get collection(){return this.notes}}var Z=i(66291),Q=i(10359),X=i(24696),ee=i(35004),te=i(17788),ie=i(97998),ne=i(63665),se=i(65222),ae=i(40731),oe=i(2569);const re=new ie.Z("mds-note-serialize");class MdsNoteCreateSerializer{constructor(){this.getNoteDetails=(e,t)=>{const i={enabled:!0,floorId:"",roomId:void 0};void 0!==e.floorId&&""!==e.floorId&&(i.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(i.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(i.color=e.color),void 0!==e.stemEnabled&&(i.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(i.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,ae.u)(e.anchorPosition)&&(i.anchorPosition=oe.ep.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,ae.u)(e.stemNormal)&&(i.stemNormal=oe.ep.toVisionVector(e.stemNormal)),void 0!==e.resolved&&(i.resolution=e.resolved?y.d7.RESOLVED:y.d7.OPEN);const n={text:t};return i.comment=n,Object.keys(i).length>0?i:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","enabled"].filter((t=>!(t in e))),i=0===t.length,n=!!e.floorId&&"string"==typeof e.floorId,s=!!e.anchorPosition&&(0,ae.u)(e.anchorPosition),a=i&&n&&s;return a||re.debug("Note invalid:",{missingFields:t,validPosition:s}),a}}serialize(e,t){const i=this.getNoteDetails(e,t);return this.validate(i)?i:null}}class MdsNotePatchSerializer{constructor(){this.getNotePatch=e=>{if(!e)return null;const t={};return void 0!==e.floorId&&""!==e.floorId&&(t.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(t.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(t.color=e.color),void 0!==e.stemEnabled&&(t.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(t.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,ae.u)(e.anchorPosition)&&(t.anchorPosition=oe.ep.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,ae.u)(e.stemNormal)&&(t.stemNormal=oe.ep.toVisionVector(e.stemNormal.normalize())),Object.keys(t).length>0?t:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","color","anchorPosition","stemNormal","stemLength","stemEnabled","stemNormal","enabled"];return Object.keys(e).every((e=>t.includes(e)))}}serialize(e){const t=this.getNotePatch(e);return t&&this.validate(t)?t:null}}var de=i(9133),le=i(37519);function he(e){const t=Object.assign({modelAccess:y.x6.PUBLIC},e);return t.__typename&&delete t.__typename,t}const ce=new ie.Z("mds-note-deserializer");class MdsNoteDeserializer{constructor(e,t){this.commentDeserializer=e,this.userData=t,this.validate=e=>{if(!e)return!1;const t=["id","created","modified","floor","resolution"].filter((t=>!(t in e))),i=0===t.length,n=!(!e.floor||!e.floor.id);return i&&n||ce.debug("Note invalid:",{missingFields:t,validFloor:n}),i&&n}}deserialize(e){var t;if(!e||!this.validate(e)||!e.floor)return ce.debug("Deserialized invalid Note data from MDS",e),null;const i=new Note;i.id=e.id,i.layerId=(null===(t=e.layer)||void 0===t?void 0:t.id)||"",i.floorId=e.floor.id,e.room&&e.room.id&&(i.roomId=e.room.id),i.resolved=e.resolution===y.d7.RESOLVED,i.created=(0,de.p)(e.created),i.modified=(0,de.p)(e.modified),i.user=this.userData.loadContributor(he(e.createdBy)),i.lastCommentMs=(0,de.p)(e.lastCommentAt).getTime();const n=this.deserializeComments(e);if(!(n.length>0))return ce.error("Note without a comment:",i.id),null;i.comments.replace(n),e.color&&(i.color=e.color);const s=e.anchorPosition?oe.ep.fromVisionVector(e.anchorPosition):void 0;s&&(i.anchorPosition=s),(0,le.hj)(e.stemLength)&&(i.stemLength=e.stemLength);const a=e.stemNormal?oe.ep.fromVisionVector(e.stemNormal):void 0;return a?(i.stemNormal=a,i.stemEnabled=!!e.stemEnabled):(i.stemNormal=new _.Vector3(0,0,0),i.stemEnabled=!!e.stemEnabled),i}deserializeComments(e){var t;const i=(null===(t=e.comments)||void 0===t?void 0:t.results)||[],n=[];return i.forEach((t=>{const i=this.commentDeserializer.deserialize(t);i&&(i.assetId=e.id,n.push(i))})),n}}class MdsCommentSerializer{constructor(){this.validate=e=>!!e}serialize(e){if(void 0===e.text)return null;const t={text:e.text};return t&&this.validate(t)?t:null}}class Comment extends $.T{constructor(e){super(),this.id="",this.assetId="",this.text="",this.user=(0,J.Q)(""),this.created=new Date,this.modified=new Date,this.edited=!1,this.attachments=(0,W.C)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.assetId=e.assetId,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.text=e.text,this.edited=e.edited,this.attachments=e.attachments,this.commit(),this}}const me=new ie.Z("mds-comment-deserializer");class MdsCommentDeserializer{constructor(e,t,i){this.fileDeserializer=e,this.embedDeserializer=t,this.userData=i}deserialize(e){if(!e||!this.validate(e))return me.debug("Deserialized invalid Comment data from MDS",e),null;const t=new Comment;t.id=e.id,t.created=(0,de.p)(e.created),t.modified=(0,de.p)(e.modified),e.text&&(t.text=e.text),t.edited=e.edited,t.user=this.userData.loadContributor(he(e.createdBy));const i=this.deserializeExternalAttachments(e),n=this.deserializeFileAttachments(e),s=i.concat(n).sort(((e,t)=>e.created.getTime()-t.created.getTime()));return s.length>0&&t.attachments.replace(s),t}deserializeExternalAttachments(e){const t=e.externalAttachments||[],i=[];return t.forEach((t=>{const n=this.embedDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=y.ud.COMMENT,i.push(n))})),i}deserializeFileAttachments(e){const t=e.fileAttachments||[],i=[];return t.forEach((t=>{const n=this.fileDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=y.ud.COMMENT,i.push(n))})),i}validate(e){if(!e)return!1;const t=["id","created","modified","edited","createdBy"].filter((t=>!(t in e))),i=0===t.length;return i||me.debug("Comment invalid:",{missingFields:t}),i}}var ue=i(44571),ge=i(36159);const pe=new ie.Z("MdsNoteStore");class MdsNoteStore extends te.u{constructor(e,t){super(e),this.userData=t,this.prefetchKey="data.model.notes",this.embedDeserializer=new ne.d,this.fileDeserializer=new se.O,this.commentDeserializer=new MdsCommentDeserializer(this.fileDeserializer,this.embedDeserializer,this.userData),this.deserializer=new MdsNoteDeserializer(this.commentDeserializer,this.userData),this.createSerializer=new MdsNoteCreateSerializer,this.patchSerializer=new MdsNotePatchSerializer,this.commentSerializer=new MdsCommentSerializer}async read(e){const t={modelId:this.getViewId(),ids:null,includeLayers:!!te.u.currentLayerId};return this.query(ue.GetNotes,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;if(!n||!Array.isArray(n))return{};const s=[];for(const e of n){const t=this.deserializer.deserialize(e);t&&s.push(t)}return s.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async readNote(e,t){const i={modelId:this.getViewId(),ids:[e],includeLayers:!!te.u.currentLayerId};return this.query(ue.GetNotes,i,t).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;return n&&Array.isArray(n)&&1===n.length?this.deserializer.deserialize(n[0]):null}))}async create(e,t){const i=this.getViewId(),n=this.createSerializer.serialize(e,t);if(!n)throw pe.error("Failure creating note:",e.id,e),new Error("Could not create Note");const s={modelId:i,data:n,includeLayers:!!te.u.currentLayerId};return this.mutate(this.addLayerId(ue.AddNote,e.layerId),s).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.addNote)?this.deserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.addNote):null}))}async update(e,t){const i=this.getViewId(),n=e.id,s=this.patchSerializer.serialize(e);if(!s||!n)throw pe.error("Failure updating note:",n),new Error("Could not update Note");const a={modelId:i,noteId:n,data:s,includeLayers:!!te.u.currentLayerId};return this.mutate(this.addLayerId(ue.PatchNote,t),a).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchNote)?this.deserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchNote):null}))}async updateResolution(e,t,i){const n={modelId:this.getViewId(),noteId:e};return t?this.mutate(this.addLayerId(ue.ResolveNote,i),n).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.resolveNote})):this.mutate(this.addLayerId(ue.ReopenNote,i),n).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.reopenNote}))}async delete(e){const t=this.getViewId();for(const i of e)await this.mutate(this.addLayerId(ue.DeleteNote,i.layerId),{modelId:t,noteId:i.id})}async createComment(e,t,i){const n=this.getViewId(),s=this.commentSerializer.serialize(i);if(!s)throw pe.error("Failure creating comment:",i),new Error("Could not create Comment");const a={modelId:n,noteId:e,data:s};return this.mutate(this.addLayerId(ue.AddNoteComment,t),a).then((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.addNoteComment)?this.commentDeserializer.deserialize(e.data.addNoteComment):null}))}async updateComment(e,t){const i=this.getViewId(),n=t.id,s=this.commentSerializer.serialize(t);if(!s||!n)throw pe.error("Failure updating comment:",n),new Error("Could not update Comment");const a={modelId:i,commentId:n,data:s};return this.mutate(this.addLayerId(ge.PatchComment,e),a).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchComment)?this.commentDeserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchComment):null}))}async deleteComment(e,t){const i=this.getViewId();if(!t||!(null==t?void 0:t.id))throw new Error("MdsNoteStore.deleteComment failed");const n={modelId:i,commentId:t.id};await this.mutate(this.addLayerId(ge.DeleteComment,e),n)}}var ve=i(54244),ye=i(89570),we=i(60975),be=i(71166),fe=i(56163);class CommentSearchResultItem extends fe.K{constructor(e,t,i,n,s){super(e),this.comment=t,this.note=i,this.textParser=n,this.typeId=s,this.id=this.comment.id,this.title=this.comment.user.name,this.description=this.textParser.getPlainText(this.comment.text),this.icon="icon-comment",this.floorId=this.note.floorId,this.layerId=this.note.layerId,this.color=this.note.color,this.onSelect=async()=>{super.onSelect(),this.commandBinder.issueCommand(new X.yW(this.note.id,!1,this.id))}}}var Te=i(38399);const{NOTES:De}=Te.Z.SHOWCASE,Ce="MP_NOTE_SEARCH_GROUP";var Pe=i(635),Me=i(79728),Se=i(28022);class NotesModule extends n.Y{constructor(){super(...arguments),this.name="notes",this.activated=!1,this.registered=!1,this.activeBindings=[],this.refreshPromise=null,this.pollOnNotes=()=>{let e;return(0,a.k1)((()=>{clearInterval(e),e=window.setInterval((()=>{this.refreshNotes()}),1e3*K.GR)}),(()=>{window.clearInterval(e)}),!0)},this.modelViewChanged=()=>{this.cancelNoteCreation(!0)},this.updatePerSettings=()=>{const e=this.settingsData.tryGetProperty(K.Mp,!1),t=!this.in360View(),i=!this.interactionmodeData.isVR(),n=t&&i&&e,s=n?this.getFilteredNoteIds(!1):[];this.engine.commandBinder.issueCommand(new N.kb(O.Er.NOTE,n?1:0,s)),n||this.closeNoteBillboard()},this.toggleNotesMode=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.togglePinAssetEditor=async e=>{this.viewData.setActiveNotation(null),e.opened?this.changeNotesPhase(z.U.EDITING):this.viewData.notesPhase===z.U.EDITING&&this.changeNotesPhase(z.U.OPEN)},this.openNoteToComment=async e=>{const{noteId:t,commentId:i,docked:n}=e,s=this.viewData,a=s.getNoteView(t);if(!a)return;const{notesFilter:o}=s,r=o===j.$.RESOLVED;o!==j.$.ALL&&a.resolved!==r&&s.setNotesFilter(j.$.ALL),this.setFocusedNoteComment(t,i),await this.openNote(t,e.transitionType,n),this.openAnnotation(t,n)},this.onAppChange=()=>{this.deactivateTool(),this.updatePerSettings(),this.displayNotes()},this.onNotesPhaseChanged=()=>{let e=!0;const t=this.toolsData.toolPanelLayout===m.wS.BOTTOM_PANEL;switch(this.viewData.notesPhase){case z.U.EDITING:case z.U.CREATING:e=!1;break;case z.U.OPENING:case z.U.OPEN:e=!t}this.engine.broadcast(new u.ps(e))},this.changeNotesPhase=e=>{e!==this.viewData.notesPhase&&this.viewData.setNotesPhase(e)},this.onCloseNote=async()=>{this.closeNote()},this.pinAddCancelled=e=>{e.pinType===O.Er.NOTE&&this.cancelNoteCreation(!1)},this.onCancelNewNote=async()=>{this.cancelNoteCreation(!0)},this.cancelNoteCreation=e=>{var t;if(!this.userData.isCommenter())return;const i=this.viewData,n=null===(t=i.openNoteView)||void 0===t?void 0:t.id;n&&(e&&this.engine.commandBinder.issueCommand(new N.tT(n,O.Er.NOTE)),this.engine.commandBinder.issueCommand(new x.Aj(n,B.J.NOTE))),this.cancelAttachmentChanges(),i.setActiveNotation(null),i.setOpenNoteView(null),i.setFocusedComment(null),i.isNewNote=!1,i.commit(),this.changeNotesPhase(z.U.IDLE)},this.updateNotes=()=>{this.activated&&(this.parseNotes(),this.updateNoteViewData())},this.onNoteFilterChanged=()=>{this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),this.viewData.updateNotesListView(),this.displayNotes()},this.onSearchBlockChanged=()=>{this.closeNote(),this.viewData.updateNotesListView(),this.displayNotes()},this.onViewModeOrFloorChanged=()=>{this.updatePerSettings()},this.onLayersChanged=()=>{this.closeNoteBillboard(),this.displayNotes()},this.onOpenNoteViewChanged=()=>{const e=this.viewData.openNoteView;e&&this.updateNotePin(e)},this.startNoteCreation=async()=>{if(!this.userData.isCommenter())return;this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new g.z2(m.w1.NOTES,!1));const e=this.viewData;let t=(0,d.O1)(11);for(;this.notesData.getNote(t);)t=(0,d.O1)(11);const i=new Note;i.user=this.userData.getCurrentUser(),i.id=t,i.floorId=this.floorsViewData.getHighestVisibleFloorId(),i.layerId=this.layersData.getNotesLayerId();const n=e.createNoteView(i);e.isNewNote=!0,e.commit(),this.changeNotesPhase(z.U.CREATING),e.setOpenNoteView(n),e.setFocusedComment(null),this.engine.commandBinder.issueCommand(new N.fM(i.id,n,O.Er.NOTE,n.backgroundTexture)),this.engine.commandBinder.issueCommand(new X.av)},this.saveNewNote=async e=>{if(!this.userData.isCommenter())return;const{text:t}=e,i=this.viewData,n=i.getPendingNote();if(n){if(this.layersData.isInMemoryLayer(n.layerId)){const e=new Note(n);return this.notesData.updateNote(e),i.setActiveNotation(null),i.isNewNote=!1,i.commit(),this.updateNoteViewData(),void this.updateListIndex(n.id)}const e=await this.store.create(n,t);if(!e)return void this.log.error("MDS Note saved failed");const s=e.comments.get(0);if(!s)throw new Error("No root comment in the new note");const a=await this.confirmAttachmentChanges(s.id,n.id);this.notesData.updateNote(e),a&&await this.refreshNote(e.id),this.parseMarkdown(t),i.setOpenNoteView(i.getNoteView(e.id));const o=i.openNoteView;if(o){const t=(0,H.C)(this.userData,B.J.NOTE,o.user);this.engine.commandBinder.issueCommand(new N.Ar(e.id,O.Er.NOTE,t)),this.engine.commandBinder.issueCommand(new N.OL(n.id,O.Er.NOTE))}i.setActiveNotation(null),i.isNewNote=!1,i.commit(),this.updateNoteViewData(),this.updateListIndex(e.id)}else this.log.debug("No pending note")},this.pinMoved=async e=>{const{id:t,pinType:i,pinPos:n}=e,s=this.viewData.openNoteView;if(s&&i===O.Er.NOTE&&t===s.id){const e=this.notesData.getNote(t);if(e){if(this.layersData.isInMemoryLayer(e.layerId))return;const{anchorPosition:i,stemNormal:s,floorId:a,roomId:o}=n;this.store.update({id:t,anchorPosition:i,stemNormal:s,floorId:a,roomId:o},e.layerId).then((e=>{e&&this.notesData.updateNote(e)}))}else this.log.debug("Cannot move a non-existent note")}},this.pinPlaced=e=>{const t=this.viewData.openNoteView;t&&e.pinType===O.Er.NOTE&&e.id===t.id&&(this.viewData.updateOpenNoteView(e.pinPos),this.changeNotesPhase(z.U.OPEN),this.viewData.setActiveNotation(t.id),this.openAnnotation(t.id,!0))},this.onPinUnselected=e=>{const{openNoteView:t,notesPhase:i,activeNotation:n}=this.viewData;n||t&&e.pinType===O.Er.NOTE&&e.id===t.id&&(i!==z.U.CLOSED&&this.toolsData.softOpening?i!==z.U.OPEN&&i!==z.U.IDLE||this.engine.commandBinder.issueCommand(new g.CH(m.w1.NOTES)):this.closeNote())},this.handleOpeningFromList=async e=>{const t=this.viewData.noteListViews.values(),{id:i,editText:n}=e,s=t.findIndex((e=>e.noteId===i||e.commentId===i));if(-1===s)return void this.log.debug("note/comment id not in list");const a=t[s];if(!a)return void this.log.debug("Cannot open non-existent list view");const o=this.toolsData.toolPanelLayout===m.wS.SIDE_PANEL?l.n.FadeToBlack:l.n.Instant,{noteId:r,commentId:d}=a;await this.openNote(r,o,!0,d,n),d&&this.engine.broadcast(new ee.J(d)),this.openAnnotation(r,!0)},this.onEditComment=async e=>{this.viewData.setActiveNotation(e.id)},this.handlePinFocusChange=async()=>{const{openNoteView:e,isNewNote:t}=this.viewData;if(t)return;const{commandBinder:i}=this.engine,{focusedPin:n,selectedPin:s}=this.pinsViewData,{billboardAnnotation:a,billboardSelected:o}=this.annotationsViewData;if(!n)return void(a&&a.annotationType===B.J.NOTE&&a.id!==(null==s?void 0:s.id)&&this.closeNoteBillboard());const r=(null==e?void 0:e.id)===(null==a?void 0:a.id)&&o,d=e&&(null==e?void 0:e.id)===(null==n?void 0:n.id);if(e&&r&&!d&&this.closeNote(),n.pinType===O.Er.NOTE){const t=this.viewData.getNoteView(n.id);if(!t)return void this.log.debug("Focused pin changed, but no note view.");t.id!==(null==e?void 0:e.id)&&i.issueCommand(new x.Kw(t.id,B.J.NOTE))}},this.handleAnnotationsChanged=async()=>{const{openNoteView:e,isNewNote:t,focusedComment:i}=this.viewData;if(t)return;const{dockedAnnotation:n,selectedAnnotation:s}=this.annotationsViewData,a=n||s,o=(null==n?void 0:n.annotationType)===B.J.NOTE&&n,r=(null==s?void 0:s.annotationType)===B.J.NOTE&&s,d=o||r,l=!!o;d&&d.id!==(null==e?void 0:e.id)?await this.openNote(d.id,null,l):e&&e.id!==(null==a?void 0:a.id)&&this.closeNote(),l?(this.activated||await this.engine.commandBinder.issueCommand(new g.z2(m.w1.NOTES,!0)),i&&this.engine.broadcast(new ee.J(i.id))):this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new g.CH(m.w1.NOTES))},this.handlePinSelection=async e=>{const{id:t,pinType:i}=e;this.viewData.activeNotation||(i===O.Er.NOTE?(await this.openNote(t,l.n.Interpolate,!0),this.openAnnotation(t,!0)):this.closeNote())},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==B.J.NOTE)return;const s=this.viewData.getNoteAttachments(i),a=s.find((e=>e.id===n));if(a&&(0,G.lV)(a)){const e=s.filter((e=>(0,G.lV)(e)));this.engine.commandBinder.issueCommand(new U.xW(!0,e,n))}},this.deleteNote=async e=>{const t=e.noteId,i=this.notesData.getNote(t);if(i){this.engine.commandBinder.issueCommand(new v.rE),this.layersData.isInMemoryLayer(i.layerId)||this.store.delete([i]),this.notesData.removeNote(t);const e=this.viewData.openNoteView;e&&e.id===t&&this.closeNote(),this.engine.commandBinder.issueCommand(new N.OL(t,O.Er.NOTE))}else this.log.debug("Cannot delete a non-existent note")},this.onResolveNoteCommand=async e=>{const{noteId:t,resolved:i}=e;i?await this.resolveNote(t):await this.reopenNote(t)},this.onSaveNoteChanges=async e=>{const{noteId:t,text:i}=e,n=this.notesData.getNote(t);if(n){const e=n.comments.get(0);if(e)return this.updateNoteComment(t,e.id,i);this.log.warn("no root comment")}else this.log.debug("Cannot update a non-existent note")},this.cancelCommentChanges=async e=>{this.cancelAttachmentChanges(),this.viewData.setActiveNotation(null)},this.saveNoteAppearance=async e=>{const t=this.notesData,{noteId:i,properties:n}=e,s=t.getNote(i);if(s){const e=this.viewData,{openNoteView:a}=e;if(Object.keys(n)){const o=this.layersData.isInMemoryLayer(s.layerId)?Object.assign(s,n):await this.store.update(Object.assign({id:i},n),s.layerId);o&&(this.updateNotePin(o),t.updateNote(o),(null==a?void 0:a.id)===i&&e.updateOpenNoteView(n))}}else this.log.debug("Cannot update a non-existent note")},this.addComment=async e=>{const{noteId:t,text:i,replyId:n}=e,s=this.notesData.getNote(t);if(s){s.resolved&&(this.viewData.setNotesFilter(j.$.ALL),this.reopenNote(s.id));const e=await this.store.createComment(t,s.layerId,{text:i});return e?(this.viewData.setActiveNotation(null),this.parseMarkdown(i),await this.confirmAttachmentChanges(e.id,n),await this.refreshNote(s.id),this.refreshNotes(),e):(this.log.error("Cannot create MDS comment"),null)}return this.log.debug("Cannot add a comment to a non-existent note"),null},this.onUpdateComment=async e=>{const{noteId:t,commentId:i,text:n}=e;return this.updateNoteComment(t,i,n)},this.deleteComment=async e=>{const{commentId:t,noteId:i}=e,n=this.notesData.getNote(i);if(n){const e=n.getComment(t);e&&(this.layersData.isInMemoryLayer(n.layerId)||await this.store.deleteComment(n.layerId,e),n.deleteComment(t)),this.refreshNotes()}else this.log.debug("Cannot delete a comment in a non-existent note")},this.cancelSearch=async()=>{this.viewData.searchBlock&&this.viewData.setSearchBlock(null)},this.notationBlockClicked=async e=>{const{annotationType:t,block:i}=e;t===B.J.NOTE&&(i.blockType!==c.C.USER&&i.blockType!==c.C.HASH||(this.activated&&!this.toolsData.softOpening||await this.engine.commandBinder.issueCommand(new g.z2(m.w1.NOTES,!1)),this.viewData.setSearchBlock(i)))},this.filterVisibleNotes=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit(),this.displayNotes()},this.noteVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit(),this.displayNotes()}}async init(e,t){const[i,n,a,d]=await Promise.all([t.market.waitForData(P.e),t.market.waitForData(M.Z),t.market.waitForData(w.m),t.market.waitForData(ve.pu)]);if(!a.isLoggedIn()||n.isVR()||!i.tryGetProperty(K.IA,!1))return;this.engine=t,this.config=e,this.interactionmodeData=n,this.userData=a,this.settingsData=i,this.appData=d;const[l,c,m,u,g,v,y]=await Promise.all([t.market.waitForData(p.t),t.market.waitForData(D.Z),t.market.waitForData(C.O),t.market.waitForData(S.c),t.market.waitForData(L.A),t.getModuleBySymbol(s.y.DEEP_LINKS),t.market.waitForData(A.R)]);this.toolsData=l,this.sweepData=c,this.viewmodeData=m,this.floorsViewData=u,this.annotationsViewData=g,this.linkHandler=v,this.layersData=y;const{readonly:b,baseUrl:f}=this.config;this.store=new MdsNoteStore({readonly:b,includeDisabled:!0,baseUrl:f},this.userData);const I=()=>{this.store.setStoreViewId(y.getNonworkshopViewId())};I(),this.bindings.push(this.store.onNewData(this.loadNewNotes.bind(this)),y.onPropertyChanged("currentViewId",I)),this.notesData=new NotesData({}),this.textParser=new h.v({links:!0,hashtags:!0,users:this.userData}),this.backgroundTexture=(0,o.p)(r),this.viewData=new Z.X(this.notesData,this.textParser,this.linkHandler,this.backgroundTexture),this.hashtagData=new Q.c,t.market.register(this,Q.c,this.hashtagData),this.pinsViewData=await t.market.waitForData(V.B),this.bindings.push(i.onPropertyChanged(K.Mp,this.updatePerSettings),t.commandBinder.addBinding(X.yK,this.toggleNotesMode),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),g.onChanged(this.handleAnnotationsChanged),t.subscribe(R.Q4,this.handlePinSelection),t.subscribe(R.WM,this.onPinUnselected),t.subscribe(F.q,this.handleViewingAttachment),t.subscribe(F.i,this.notationBlockClicked),t.commandBinder.addBinding(X.yW,this.openNoteToComment),t.subscribe(T.bS,this.onAppChange),m.makeModeChangeSubscription(this.onViewModeOrFloorChanged),u.makeFloorChangeSubscription(this.onViewModeOrFloorChanged),t.subscribe(E.Z,this.updatePerSettings),t.subscribe(k.m,this.updatePerSettings),this.layersData.onCurrentLayersChanged(this.onLayersChanged),t.commandBinder.addBinding(X.Gx,this.filterVisibleNotes),t.commandBinder.addBinding(X.GV,this.noteVisbilityFilterEnabled),this.pollOnNotes(),this.notesData.collection.onElementChanged({onAdded:this.updateNotePin.bind(this),onUpdated:this.updateNotePin.bind(this),onRemoved:this.removeNotePin.bind(this)}),t.subscribe(Se.Y,this.modelViewChanged)),t.market.register(this,Z.X,this.viewData),this.updatePerSettings(),this.parseNotes(),async function(e,t,i,n,s,a,o,r){const d=(o,r,d=[])=>{const l=[],h=i.notesFilter,c=h===j.$.RESOLVED,m=s.application===ve.Mx.WORKSHOP,u=[];return t.iterate((t=>{let i=m||n.layerToggled(t.layerId);if(i){if(h!==j.$.ALL&&t.resolved!==c)i=!1;else if(d.length>0)i=!1;else if(r){let n=0;t.comments.forEach((i=>{o(i.user.name,a.getPlainText(i.text))&&(n+=1,l.push(new CommentSearchResultItem(e,i,t,a,Ce)))})),i=n>0}else{const n=t.comments.get(0);i=o(t.user.name,a.getPlainText(n.text)),i&&l.push(new CommentSearchResultItem(e,n,t,a,Ce))}i&&u.push(t.id)}})),e.issueCommand(new X.Gx(u)),l},l=new we.u(r,{[K.Mp]:!0}),h=t=>{e.issueCommand(new X.GV(t)),l.toggle(t)},c=e=>new ye.V(t.onChanged(e),o.onChanged(e)),m={renew:()=>{e.issueCommandWhenBound(new be.c6({id:Ce,groupPhraseKey:De.SEARCH_GROUP_HEADER_NOTES,groupMatchingPhraseKey:De.SEARCH_GROUP_HEADER,getSimpleMatches:d,registerChangeObserver:c,onSearchActivatedChanged:h,groupOrder:50,groupIcon:"comment-outline"}))},cancel:()=>{e.issueCommandWhenBound(new be.Pe(Ce))}},u=()=>{const e=s.application===ve.Mx.WORKSHOP;r.tryGetProperty(K.IA,!1)||e?m.renew():m.cancel()},g=s.onPropertyChanged("application",u),p=r.onPropertyChanged(K.IA,u);return u(),new ye.V(m,g,p)}(t.commandBinder,this.notesData,this.viewData,this.layersData,d,this.textParser,this.userData,this.settingsData).then((e=>this.bindings.push(e))),await this.refreshNotes(),t.market.register(this,NotesData,this.notesData)}dispose(e){this.deactivateTool(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.engine.commandBinder.issueCommand(new N.zM(O.Er.NOTE)),this.backgroundTexture.dispose(),this.cancelSearch(),this.viewData.dispose(),this.store.dispose(),super.dispose(e)}onUpdate(){}async refreshNotes(){if(this.refreshPromise)return;const e=this.viewData,{isNewNote:t,notesPhase:i}=e;t||i===z.U.EDITING||(this.refreshPromise=this.store.refresh().finally((()=>{this.refreshPromise=null})))}loadNewNotes(e){var t;const{viewData:i}=this,n=Object.values(e),s=null===(t=i.openNoteView)||void 0===t?void 0:t.id,{collection:a}=this.notesData;this.notesData.atomic((()=>{const t=a.keys.filter((t=>!this.layersData.isInMemoryLayer(a.get(t).layerId)&&!e[t]));t.length&&t.forEach((e=>{e===s&&(this.log.debug("Open note was deleted"),i.setOpenNoteView(null),i.setFocusedComment(null),i.setActiveNotation(null),i.setNotesPhase(z.U.IDLE)),a.delete(e)})),n.length&&n.forEach((e=>{this.notesData.updateNote(e)}))}))}async refreshNote(e){if(this.refreshPromise)return;const t=this.notesData.getNote(e);if(this.layersData.isInMemoryLayer(null==t?void 0:t.layerId))this.notesData.updateNote(t);else{const t=await this.store.readNote(e);t&&this.notesData.updateNote(t)}}activateTool(){this.activated||(this.engine.commandBinder.issueCommand(new x.yL(B.J.NOTE)),this.userData.isCommenter()&&this.engine.commandBinder.issueCommand(new N.Ki(!0)),this.changeNotesPhase(z.U.IDLE),this.updateNoteViewData(),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0)}deactivateTool(e){var t;if(!this.activated)return;const{isNewNote:i,openNoteView:n}=this.viewData,s=(null===(t=this.annotationsViewData.dockedAnnotation)||void 0===t?void 0:t.annotationType)===B.J.NOTE;i?this.cancelNoteCreation(!0):n&&(e||s)&&this.closeNote(),this.viewData.setSearchBlock(null),this.changeNotesPhase(z.U.CLOSED),this.engine.commandBinder.issueCommand(new N.Ki(!1)),this.activeBindings.forEach((e=>{e.cancel()})),this.activated=!1}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(R.b0,this.pinPlaced),this.engine.subscribe(R.bV,this.modifyInsideSaveCommand(this.pinMoved)),this.engine.subscribe(R.hu,this.pinAddCancelled),e.addBinding(X.VI,this.startNoteCreation),e.addBinding(X.FB,this.modifyInsideSaveCommand(this.saveNewNote)),e.addBinding(X.gc,this.onCancelNewNote),e.addBinding(X._N,this.onCloseNote),e.addBinding(X.kd,this.modifyInsideSaveCommand(this.onSaveNoteChanges)),e.addBinding(X.oH,this.cancelCommentChanges),e.addBinding(X.Zd,this.handleOpeningFromList),e.addBinding(X.x4,this.onEditComment),e.addBinding(X.sG,this.modifyInsideSaveCommand(this.deleteNote)),e.addBinding(X.yp,this.modifyInsideSaveCommand(this.onResolveNoteCommand)),e.addBinding(X.Df,this.modifyInsideSaveCommand(this.addComment)),e.addBinding(X.Uw,this.modifyInsideSaveCommand(this.onUpdateComment)),e.addBinding(X.mH,this.modifyInsideSaveCommand(this.deleteComment)),e.addBinding(X.oE,this.modifyInsideSaveCommand(this.saveNoteAppearance)),e.addBinding(X.df,this.togglePinAssetEditor),e.addBinding(X.av,this.cancelSearch),this.viewData.onSearchBlockChanged(this.onSearchBlockChanged),this.viewData.onNotesFilterChanged(this.onNoteFilterChanged),this.viewData.onOpenNoteViewChanged(this.onOpenNoteViewChanged),this.viewData.onNotesPhaseChanged(this.onNotesPhaseChanged),this.notesData.onChanged(this.updateNotes)),this.registered=!0}async parseNotes(){const e=[],t=[];return this.notesData.iterate((i=>{i.comments.forEach((i=>{const n=this.getUserMentionsAndHashtags(i.text);n.emails.forEach((t=>{e.push({email:t,userStatus:b.J.MENTIONED})})),t.push(...n.hashtags)}))})),this.hashtagData.addHashtags(t),this.engine.commandBinder.issueCommand(new f.Vu(e))}async parseMarkdown(e){const t=[],i=this.getUserMentionsAndHashtags(e);return i.emails.forEach((e=>{t.push({email:e,userStatus:b.J.MENTIONED})})),this.hashtagData.addHashtags(i.hashtags),this.engine.commandBinder.issueCommand(new f.Vu(t))}getUserMentionsAndHashtags(e){const t=[],i=[];for(const n of this.textParser.parse(e))n.blockType===c.C.USER&&n.value?t.push(n.value):n.blockType===c.C.HASH&&i.push(n.text);return{emails:t,hashtags:i}}closeNoteBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===B.J.NOTE&&this.engine.commandBinder.issueCommand(new x.Aj(e.id,B.J.NOTE))}openAnnotation(e,t){t?this.engine.commandBinder.issueCommand(new x.bd(e,B.J.NOTE)):this.engine.commandBinder.issueCommand(new x.oM(e,B.J.NOTE))}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeNote(){var e;const{commandBinder:t}=this.engine,{openNoteView:i,notesPhase:n}=this.viewData;if(this.viewData.setActiveNotation(null),this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),n!==z.U.CLOSED&&this.changeNotesPhase(z.U.IDLE),i){const n=i.id;this.cancelAttachmentChanges(),t.issueCommand(new U.xW(!1));const s=this.notesData.getNote(n);s&&(t.issueCommand(new N.RH(n,O.Er.NOTE)),t.issueCommand(new N.ik(n,O.Er.NOTE,this.getNoteVisibility(n,s.layerId,i.resolved))));(null===(e=this.annotationsViewData.dockedAnnotation)||void 0===e?void 0:e.annotationType)===B.J.NOTE&&await t.issueCommand(new x.JD)}}updateNoteViewData(){this.viewData.updateViewData()}getFilteredNoteIds(e){const t=[];return this.notesData.iterate((i=>{this.getNoteVisibility(i.id,i.layerId,i.resolved)===e&&t.push(i.id)})),t}getNoteVisibility(e,t,i){const{notesFilter:n,openNoteView:s,idVisibilityEnabled:a,idVisibility:o}=this.viewData,r=(null==s?void 0:s.id)===e,d=n===j.$.ALL||i&&n===j.$.RESOLVED||!i&&n===j.$.OPEN,l=!a||o.has(e);return(this.appData.application===ve.Mx.WORKSHOP||this.layersData.layerToggled(t))&&(r||d&&l)}displayNotes(){const e=[];this.notesData.iterate((t=>{e.push(Object.assign(Object.assign({},t),{pinType:O.Er.NOTE,backgroundTexture:this.backgroundTexture,visible:this.getNoteVisibility(t.id,t.layerId,t.resolved)}))})),this.engine.commandBinder.issueCommand(new N.mE(e))}updateNotePin(e){const t=Object.assign(Object.assign({},e),{pinType:O.Er.NOTE,backgroundTexture:this.backgroundTexture,visible:this.getNoteVisibility(e.id,e.layerId,e.resolved),icon:O.Qk[O.Er.NOTE]});this.engine.commandBinder.issueCommand(new N.mE([t]))}removeNotePin(e){this.engine.commandBinder.issueCommand(new N.OL(e.id,O.Er.NOTE))}async confirmAttachmentChanges(e,t){return this.engine.commandBinder.issueCommand(new U.iu(e,y.ud.COMMENT,t))}async cancelAttachmentChanges(){return this.engine.commandBinder.issueCommand(new U.Ze)}setFocusedNoteComment(e,t){if(t){const i=this.viewData.getComment(e,t);this.viewData.setFocusedComment(i)}else this.viewData.setFocusedComment(null)}async openNote(e,t,i,n,s){var a;const o=(null===(a=this.annotationsViewData.dockedAnnotation)||void 0===a?void 0:a.annotationType)===B.J.NOTE;return(null!==i?i:o)?this.dockNote(e,t,n):this.selectNote(e,t)}async selectNote(e,t){var i;const{commandBinder:n}=this.engine,s=this.viewData.getNoteView(e);if(s){const{openNoteView:a}=this.viewData,o=(null==a?void 0:a.id)===e,r=(null===(i=this.annotationsViewData.dockedAnnotation)||void 0===i?void 0:i.id)===e;if(o&&!r&&a)return void this.log.debug("Note is already selected");this.activated&&await n.issueCommand(new g.CH(m.w1.NOTES)),n.issueCommand(new U.xW(!1)),a&&(n.issueCommand(new x.Aj(a.id,B.J.NOTE)),n.issueCommand(new N.RH(a.id,O.Er.NOTE))),this.viewData.setOpenNoteView(s),await n.issueCommand(new N.Ar(e,O.Er.NOTE,!1)),null!==t&&await n.issueCommand(new I.OR({pinPosition:s,transition:t}))}else this.log.debug("Cannot select a non-existent note")}async dockNote(e,t,i,n=!1){var s;const{toolsData:a,viewData:o,engine:r,activated:d,userData:l}=this,h=o.getNoteView(e);if(h){const{openNoteView:c}=this.viewData,u=(null==c?void 0:c.id)===e,p=(null===(s=this.annotationsViewData.dockedAnnotation)||void 0===s?void 0:s.id)===e;if(a.toolCollapsed&&r.commandBinder.issueCommand(new g.Fg(!1)),u&&p&&c)return void this.log.debug("Note is already docked");r.commandBinder.issueCommand(new v.rE),d||await r.commandBinder.issueCommand(new g.z2(m.w1.NOTES,!0)),u||o.setOpenNoteView(h),this.updateListIndex(i||e);const y=(0,H.C)(l,B.J.NOTE,h.user);if(r.commandBinder.issueCommand(new N.Ar(e,O.Er.NOTE,y)),this.changeNotesPhase(z.U.OPENING),null!==t&&await r.commandBinder.issueCommand(new I.OR({pinPosition:h,transition:t})),this.changeNotesPhase(z.U.OPEN),y&&n){const e=h.comments.get(0);e?o.setActiveNotation(e.id):this.log.debug("Missing note post")}else o.setActiveNotation(null)}else this.log.debug("Cannot open a non-existent note")}updateListIndex(e){const t=this.viewData.noteListViews.values().findIndex((t=>t.noteId===e||t.commentId===e));this.viewData.setListIndex(t)}async resolveNote(e){const t=this.notesData.getNote(e);if(t){if(t.resolved)return;this.closeNote(),await(0,d.gw)(350),this.engine.broadcast(new ee.h(e,!0));!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!0,t.layerId)?this.notesData.updateNoteProperties(e,{resolved:!0}):this.log.error("Resolving note failed")}else this.log.debug("Cannot resolve a non-existent note")}async reopenNote(e){const t=this.notesData.getNote(e);if(t){if(!t.resolved)return;this.viewData.updateOpenNoteView({resolved:!1});!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!1,t.layerId)?this.notesData.updateNoteProperties(e,{resolved:!1}):this.log.error("Reopen note failed")}else this.log.debug("Cannot reopen a non-existent note")}modifyInsideSaveCommand(e){return async(...t)=>{await this.engine.commandBinder.issueCommand(new Pe.VQ({dataTypes:[Me.g.NOTES],onCallback:()=>e(...t),skipDirtyUpdate:!0}))}}async updateNoteComment(e,t,i){const n=this.notesData.getNote(e);if(n){const s=this.layersData.isInMemoryLayer(n.layerId),a=n.getComment(t);if(a)if(a.user.id===this.userData.getCurrentUserId()){const o=!s&&await this.confirmAttachmentChanges(t,y.ud.COMMENT),r=i!==a.text;if(r){if(s)a.text=i;else{const e=await this.store.updateComment(n.layerId,{id:t,text:i});e&&n.updateComment(e)}this.parseMarkdown(i)}(o||r)&&(await this.refreshNote(n.id),n.resolved&&(this.viewData.setNotesFilter(j.$.ALL),this.reopenNote(e))),this.viewData.setActiveNotation(null)}else this.log.debug("Cannot update another user's comment");else this.log.debug("Cannot update a non-existent comment")}else this.log.debug("Cannot update a comment in a non-existent note")}}const Ae=NotesModule},95153:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ObjectTagSuggestionsDataModule});var n=i(97542),s=i(57956),a=i(84428),o=i(64918),r=i(12039),d=i(62612),l=i(72936),h=i(60083),c=i(43470),m=i(16935),u=i(5666),g=i(59512),p=i(86283),v=i(56163),y=i(38399),w=i(71166);const{OBJECT_TAG_SUGGESTION:b}=y.Z.WORKSHOP;class ObjectTagSuggestionSearchResultItem extends v.K{constructor(e,t,i,n,s,a){super(e),this.suggestion=i,this.typeId=n,this.isEditable=s,this.mattertag=a,this.onToggleVisible=async e=>{this.suggestion.visible=!this.suggestion.visible,this.enabled=this.suggestion.visible,this.commandBinder.issueCommand(new u.Bh(this.suggestion.visible,this.suggestion.id)),e.stopPropagation();const t=this.suggestion.visible?"object_tags_show_click":"object_tags_hide_click";this.trackEvent(t)},this.onMattertagChange=()=>{this.mattertag&&(this.updateColor(),this.commandBinder.issueCommand(new l.tE(this.suggestion.id,d.Er.OBJECT,this.suggestion.getPin(this.mattertag))),this.updateLabels(),this.commandBinder.issueCommand(new w.s7))},this.updateLabels=()=>{var e,t;this.title=(null===(e=this.mattertag)||void 0===e?void 0:e.label)?this.mattertag.label:this.suggestion.displayLabel,this.description=(null===(t=this.mattertag)||void 0===t?void 0:t.description)?this.mattertag.description:this.suggestion.displayCategory},this.updateColor=()=>{var e;this.color=(null===(e=this.mattertag)||void 0===e?void 0:e.color)?`#${this.mattertag.color.getHexString()}`:this.suggestion.color},this.updateVisibility=()=>{this.enabled=this.suggestion.visible,this.actions&&(this.actions[0].icon=this.suggestion.visible?"eye-show":"eye-hide",this.actions[0].tooltipKey=this.suggestion.visible?b.SEARCH_ITEM_HIDE_TOOLTIP:b.SEARCH_ITEM_SHOW_TOOLTIP),this.commandBinder.issueCommand(new l.ik(this.suggestion.id,d.Er.OBJECT,this.suggestion.visible))},this.onEditClick=()=>{this.trackEvent("object_tags_edit_click"),this.commandBinder.issueCommand(new u.OD(this.suggestion.id))},this.onDeleteClick=()=>{const e=this.suggestion.id;this.commandBinder.issueCommand(new u.SO(e)),this.commandBinder.issueCommand(new l.OL(e,d.Er.OBJECT)),this.commandBinder.issueCommand(new c.Aj(e,p.J.OBJECT)),this.trackEvent("object_tags_delete_click")},this.id=this.suggestion.id,this.title=this.suggestion.displayLabel,this.description=this.suggestion.displayCategory,this.icon="icon-simple-tag",this.color=this.suggestion.color,this.enabled=this.suggestion.visible,this.floorId=this.suggestion.floorId,this.actions=this.isEditable?[{icon:this.suggestion.visible?"eye-show":"eye-hide",tooltipKey:this.suggestion.visible?b.SEARCH_ITEM_HIDE_TOOLTIP:b.SEARCH_ITEM_SHOW_TOOLTIP,handler:this.onToggleVisible}]:void 0,this.menuActions=this.isEditable?[{labelKey:b.SEARCH_ITEM_EDIT,handler:this.onEditClick,icon:"toggle-pencil"},{labelKey:b.SEARCH_ITEM_DELETE,handler:this.onDeleteClick,className:"menu-delete-btn",icon:"delete"}]:void 0,this.onSelect=()=>{super.onSelect(),this.suggestion.visible&&this.commandBinder.issueCommand(new u.w$(this.suggestion.id))},this.updateVisibility(),this.updateLabels(),this.updateColor(),this.init(t)}async init(e){this.analytics=await e.getModuleBySymbol(s.y.ANALYTICS)}registerBindings(){var e;this.bindings.push(this.suggestion.onPropertyChanged("enabled",this.updateVisibility)),this.mattertag&&this.bindings.push(null===(e=this.mattertag)||void 0===e?void 0:e.onChanged(this.onMattertagChange))}trackEvent(e){this.analytics&&this.analytics.track("showcase_gui",{tool:"object_tags",gui_action:e})}}var f=i(54244),T=i(89570),D=i(6735),C=i(63319);const{OBJECT_TAG_SUGGESTION:P}=y.Z.WORKSHOP,M="MP_OBJECT_SEARCH_GROUP";var S=i(69665),A=i(17788),E=i(75287),k=i(45611);class ObjectTagSuggestion extends E.T{constructor(e){super(),this.sweeps=[],this.position=new a.Vector3,this.stemDirection=new a.Vector3,this.stemLength=k.K,this.stemEnabled=!1,this.enabled=!0,e&&(Object.assign(this,e),this.keywords=e.keywords||[])}get displayLabel(){return this.localizedName?this.localizedName:this.label}get displayCategory(){return this.localizedCategory?this.localizedCategory:""}get visible(){return this.enabled}set visible(e){this.enabled=e,this.commit()}getMattertagOptions(){return{color:new a.Color(this.color),description:this.displayCategory,enabled:!0,floorId:this.floorId,label:this.displayLabel,normal:this.stemDirection.clone(),objectAnnotationId:this.id,position:this.position.clone(),stemHeight:this.stemLength,stemVisible:!0,keywords:this.keywords.slice()}}getPin(e){return{id:this.id,floorId:this.floorId,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemEnabled:!1,stemLength:k.K,layerId:this.layerId,color:e?`#${e.color.getHexString()}`:this.color,roomId:this.roomId}}toTagView(e){return{id:this.id,label:e?e.label:this.displayLabel,description:e?e.description:this.displayCategory,enabled:this.enabled,backgroundTexture:W,attachments:(null==e?void 0:e.fileAttachments.values())||[],created:this.created,modified:this.modified,stemEnabled:this.stemEnabled,color:this.color,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemLength:this.stemLength,floorId:this.floorId,roomId:this.roomId,layerId:this.layerId,keywords:e?null==e?void 0:e.keywords.slice():this.keywords.slice(),icon:"simple-tag-small"}}}var I,N=i(9133),O=i(2569),V=i(97998),R=i(51728);!function(e){e.APPLIANCE="Appliance",e.CONSUMER_ELECTRONICS="Consumer Electronics",e.FIXTURE="Fixture",e.FURNITURE="Furniture",e.LIGHTING="Lighting"}(I||(I={}));const x="WORKSHOP.OBJECT_TAG_SUGGESTION.VISION.";class MdsObjectTagSuggestionDeserializer{constructor(e){this.locale=e,this.log=new V.Z("Object-tag-deserializer"),this.keywordList=Object.values(I)}deserialize(e){var t,i,n,s;if(!e||!this.validate(e))return null;const a=e.region,o=(null==a?void 0:a.anchorPosition)?O.ep.fromVisionVector(a.anchorPosition):void 0,r=(null==a?void 0:a.stemNormal)?O.ep.fromVisionVector(a.stemNormal):void 0,d=new ObjectTagSuggestion;d.id=e.id,d.confidence=null!==(t=e.confidence)&&void 0!==t?t:0,d.created=(0,N.p)(e.created),d.modified=(0,N.p)(e.modified),d.enabled=e.enabled,(null===(i=e.region)||void 0===i?void 0:i.stemLength)&&(d.stemLength=e.region.stemLength),d.sweeps=[],e.panos&&e.panos.forEach((e=>{e&&e.id&&d.sweeps.push(e.id)})),e.floor&&e.floor.id&&(d.floorId=e.floor.id),e.room&&e.room.id&&(d.roomId=e.room.id),e.layer&&e.layer.id&&(d.layerId=e.layer.id),o&&(d.position=o),r&&(d.stemDirection=r),d.mattertagId=null===(n=e.tag)||void 0===n?void 0:n.id;let l=e.keywords||[],h=e.label||"";if(e.classification){const t=e.classification,i=x+this.formatStringToPhraseKey(t.label);this.locale.has(i)&&(d.localizedName=this.locale.t(i));const{defaultKeywords:n}=t;if(n&&n.length>0){const e=n[n.length-1],t=x+this.formatStringToPhraseKey(e);this.locale.has(t)&&(d.localizedCategory=this.locale.t(t))}t.label&&(h=t.label),t.defaultKeywords&&(l=t.defaultKeywords);const s=[];for(const e of l){const t=x+this.formatStringToPhraseKey(e);this.locale.has(t)?s.push(this.locale.t(t)):s.push(e)}l=s}return d.keywords=l,d.label=h,this.postProcess(d,null===(s=e.classification)||void 0===s?void 0:s.defaultKeywords),d}formatStringToPhraseKey(e){return e.trim().replace(/\s/,"_").toUpperCase()}validate(e){if(!e)return!1;const t=["id","label","created","modified","region"];for(const i of t){if(!(i in e))return this.log.error("Missing field: ",i),!1}return!0}postProcess(e,t){let[i,n]=e.label.split(".").slice(1);if(i&&(e.localizedCategory=this.locale.t(x+i.toUpperCase())),n&&(e.localizedName=this.locale.t(x+n.toUpperCase())),t&&t.length>0)for(const e of this.keywordList)if(t.includes(e)){i=e;break}e.color=this.getCategoryColor(i)}getCategoryColor(e){switch(e){case"appliances":return R.U.cerulean;case"consumer_electronics":return R.U.emerald;case"fixtures":return R.U.sunset;case I.APPLIANCE:return R.U.cerulean;case I.CONSUMER_ELECTRONICS:return R.U.emerald;case I.FIXTURE:return R.U.sunset;case I.FURNITURE:return R.U.canary;case I.LIGHTING:return R.U.fog;default:return R.U.forest}}}class MdsObjectTagStore extends A.u{constructor(e,t,i,n){super(e),this.modelId=i,this.classifications=[],this.confidence=n||.9,this.deserializer=new MdsObjectTagSuggestionDeserializer(t)}async read(e){const t={modelId:this.getViewId(),minConfidence:this.confidence,includeDisabled:!0,inferenceEvents:null,ids:null,includeLayers:!!A.u.currentLayerId};return this.query(S.GetObjectAnnotations,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.objectAnnotations;if(!n||!Array.isArray(n))return[];const s=[];return n.map((e=>{const t=this.deserializer.deserialize(e);t&&s.push(t)})),s}))}async setEnabled(e,...t){const i={modelId:this.modelId,objectAnnotationIds:t,setEnabled:e,includeLayers:!!A.u.currentLayerId};return this.query(S.SetBulkObjectAnnotationsEnabled,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.setBulkObjectAnnotationsEnabled;if(!i)return[];return i.map((e=>e.id))}))}async deleteObjectAnnotation(e){const t={modelId:this.modelId,objectAnnotationId:e};return this.query(S.DeleteObjectAnnotation,t).then((e=>{var t;return!!(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.deleteObjectAnnotation)}))}async createObjectTag(e){const t={label:e.label,keywords:e.keywords||[],floorId:e.floorId,enabled:!0,vectorRegion:{anchorPosition:O.ep.toVisionVector(e.position),stemNormal:O.ep.toVisionVector(e.stemDirection),stemLength:e.stemLength}},i={modelId:this.modelId,objectAnnotation:t,includeLayers:!!A.u.currentLayerId};return this.query(S.AddObjectAnnotation,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.addObjectAnnotation;if(i)return i}))}async toggleEnabled(e,...t){return this.setEnabled(e,...t)}}var B=i(87926),L=i(27832),F=i(85679),H=i(43037),U=i(39880),G=i(19648),z=i(89549),j=i(76631),_=i(66917),$=i(80742);const W=(0,B.p)(L);class ObjectTagSuggestionsDataModule extends n.Y{constructor(){super(...arguments),this.name="object-tag-suggestions-data",this.onPinFocusChange=async()=>{const{commandBinder:e}=this.engine,{focusedPin:t,selectedPin:i}=this.pinsViewData,{billboardAnnotation:n,dockedAnnotation:s}=this.annotationsViewData;t?(i&&i.pinType===d.Er.OBJECT&&(e.issueCommand(new l.RH(i.id,i.pinType)),e.issueCommand(new w.IL(null))),t.pinType===d.Er.OBJECT&&t.id!==(null==s?void 0:s.id)&&e.issueCommand(new c.Kw(t.id,p.J.OBJECT))):n&&n.annotationType===p.J.OBJECT&&n.id!==(null==i?void 0:i.id)&&await e.issueCommand(new c.Aj(n.id,p.J.OBJECT))},this.createObjectTag=async e=>{const{id:t,options:i,pendingAttachments:n,embed:s}=e,o=new ObjectTagSuggestion,r=null==i?void 0:i.color,h=r?`#${new a.Color(r.r,r.g,r.b).getHexString()}`:"#ffffff";o.label=i.label||"",o.floorId=i.floorId||"",o.keywords=i.keywords||[],o.stemDirection=i.normal||new a.Vector3,o.stemLength=i.stemHeight?Math.max(i.stemHeight,k.K):k.K,o.position=i.position||new a.Vector3,o.color=h;const c=await this.data.create(o);if(!c)return;const{commandBinder:m}=this.engine;i.objectAnnotationId=c.id,o.mattertagId=t,await m.issueCommand(new H.QG(t,i,n,void 0,s)),m.issueCommand(new l.tE(c.id,d.Er.OBJECT,this.getPinUpdate(o))),await m.issueCommand(new z.CH(j.w1.TAGS)),m.issueCommand(new _.M),await m.issueCommand(new z.z2(j.w1.LAYERS)),m.issueCommand(new _.I);const g=new ObjectTagSuggestionSearchResultItem(m,this.engine,o,M,!1);m.issueCommand(new w.IL(g)),await m.issueCommand(new u.w$(c.id))},this.dockObjectTag=async e=>{const{id:t}=e,i=this.data.getTag(t);if(!i)return;const{commandBinder:n}=this.engine;if(!i.mattertagId){const e=i.getMattertagOptions(),t=(0,U.O1)(11);n.issueCommand(new G.Mm(t,e)),i.mattertagId=t}n.issueCommand(new H.lt(i.mattertagId,null,!0,!0))}}async init(e,t){super.init(e,t),this.engine=t,[this.locale,this.pinsViewData,this.annotationsViewData,this.mattertagsData]=await Promise.all([t.getModuleBySymbol(s.y.LOCALE),t.market.waitForData(h.B),t.market.waitForData(m.A),t.market.waitForData(F.n)]);const i=new MdsObjectTagStore({readonly:!1,baseUrl:e.baseUrl},this.locale,e.baseModelId,e.minConfidence),n=await i.read();this.data=new g.h(i),this.data.add(...n),this.engine.market.register(this,g.h,this.data),async function(e,t,i,n){const s=await e.market.waitForData(f.pu),a=await e.getModuleBySymbol(D.y.ANALYTICS);let o=s.application===f.Mx.WORKSHOP;const r=[],h=[],c=t=>{let s;const a=n.getCurrentView().viewType===C.X.USER;return t.mattertagId&&(s=i.getTag(t.mattertagId)),new ObjectTagSuggestionSearchResultItem(e.commandBinder,e,t,M,o&&!a,s)},m=(n,s,a=[])=>{r.length=0,h.length=0;let d=!0,l=!0;for(const e of t.suggestions){const t=[e.displayLabel,e.displayCategory],s=[...e.keywords];if(e.mattertagId){const n=i.getTag(e.mattertagId);n&&(t.length=0,s.length=0,t.push(n.label,n.description),s.push(...n.keywords))}let m=n(...t.filter((e=>!!e)));if(m&&a.length>0&&(m=s.length>0&&s.some((e=>a.includes(e)))),m){if(e.visible?l=!1:d=!1,!o&&!e.visible)continue;r.push(c(e)),h.push(e.id)}}return e.commandBinder.issueCommand(new u.yJ(h)),o&&e.commandBinder.issueCommand(new w.Np(M,A(l,d))),g(r),r},g=e=>{e.sort(((e,t)=>{var i;const n=e,s=t,a=null===(i=n.description)||void 0===i?void 0:i.localeCompare(s.description);return 0!==a?a:n.title.localeCompare(s.title)}))},p=t=>{e.commandBinder.issueCommand(new l.qN(d.Er.OBJECT,t)),t||e.commandBinder.issueCommand(new u.xN)},v=()=>{e.commandBinder.issueCommand(new u.Bh(!0,...h)),e.commandBinder.issueCommand(new w.Np(M,A(!1,!0))),a.track("showcase_gui",{tool:"object_tags",gui_action:"show_all_click"})},y=()=>{e.commandBinder.issueCommand(new u.Bh(!1,...h)),e.commandBinder.issueCommand(new w.Np(M,A(!0,!1))),a.track("showcase_gui",{tool:"object_tags",gui_action:"hide_all_click"})},b=()=>{e.commandBinder.issueCommand(new u.SO(...h)),a.track("showcase_gui",{tool:"object_tags",gui_action:"delete_all_click"})},S=()=>{let e=[];return t.suggestions.forEach((t=>{t.visible&&t.keywords.length&&!t.mattertagId&&(e=e.concat(t.keywords))})),e},A=(e,t)=>[{labelKey:P.SEARCH_GROUP_HIDE_ALL,handler:y,disabled:e},{labelKey:P.SEARCH_GROUP_SHOW_ALL,handler:v,disabled:t},{labelKey:P.SEARCH_GROUP_DELETE_ALL,handler:b}],E=()=>{e.commandBinder.issueCommandWhenBound(new w.c6({id:M,groupPhraseKey:"WORKSHOP.OBJECT_TAG_SUGGESTION.SEARCH_GROUP_HEADER",getSimpleMatches:m,registerChangeObserver:e=>new T.V(t.onChanged(e)),onSearchActivatedChanged:p,getKeywords:S,groupMenuActions:o?A(!1,!0):void 0,groupOrder:90,groupIcon:"public_symbols_tag"}))},k=()=>{e.commandBinder.issueCommandWhenBound(new w.Pe(M))},I={renew:E,cancel:k},N=e=>{o=e===f.Mx.WORKSHOP,k(),E()},O=s.onPropertyChanged("application",N);return N(s.application),new T.V(I,O)}(t,this.data,this.mattertagsData,await t.market.waitForData($.R)).then((e=>this.bindings.push(e)));const{commandBinder:a}=this.engine;this.bindings.push(a.addBinding(u.yJ,(({ids:e})=>this.filterTagSuggestions(...e))),a.addBinding(u.w$,(async({id:e})=>this.navigateToSuggestion(e))),a.addBinding(u.xN,(async()=>this.closeSelectedSuggestion())),a.addBinding(u.Bh,(async({ids:e,enabled:t})=>this.setTagsEnabled(t,...e))),a.addBinding(u.SO,(async({ids:e})=>this.deleteTags(...e))),a.addBinding(u.I2,(async e=>this.createObjectTag(e))),a.addBinding(u.OD,(async e=>this.dockObjectTag(e))),this.pinsViewData.onSelectedPinChanged((()=>this.onPinSelectionChange())),this.pinsViewData.onFocusedPinChanged((()=>this.onPinFocusChange())),this.data.onChanged((()=>this.createSuggestionsPins()))),this.createSuggestionsPins()}dispose(e){super.dispose(e),this.data&&e.market.unregister(this,g.h)}onPinSelectionChange(){const{commandBinder:e}=this.engine,{selectedPin:t}=this.pinsViewData,{billboardAnnotation:i}=this.annotationsViewData,n=this.data.suggestions.find((e=>e.id===(null==t?void 0:t.id)));if(!n)return void(i&&i.annotationType===p.J.OBJECT&&this.engine.commandBinder.issueCommand(new c.Aj(i.id,p.J.OBJECT)));const s=new ObjectTagSuggestionSearchResultItem(e,this.engine,n,M,!1);e.issueCommand(new w.IL(s)),e.issueCommand(new c.Kw(n.id,p.J.OBJECT))}createSuggestionsPins(){const e=[];this.data.suggestions.forEach((t=>{e.push(this.getPinUpdate(t))})),this.engine.commandBinder.issueCommand(new l.mE(e)),this.engine.commandBinder.issueCommand(new l.qN(d.Er.OBJECT,!1))}getPinUpdate(e){const t=this.mattertagsData.getTag(e.mattertagId||""),i=e.getPin(t);return Object.assign({id:e.id,pinType:d.Er.OBJECT,backgroundTexture:W,visible:e.visible,scale:new a.Vector3(.75,.75,.75),icon:"simple-tag-small"},i)}async filterTagSuggestions(...e){const t=this.data.suggestions;for(const i of t){const t=e.includes(i.id)&&i.visible;this.engine.commandBinder.issueCommand(new l.ik(i.id,d.Er.OBJECT,t))}}async navigateToSuggestion(e){const t=this.data.suggestions.find((t=>t.id===e));if(!t)return;const i={anchorPosition:t.position.clone(),stemNormal:t.stemDirection.clone(),stemLength:t.stemLength,stemEnabled:!0,color:"",floorId:t.floorId,roomId:t.roomId,layerId:t.layerId};await this.engine.commandBinder.issueCommand(new r.OR({pinPosition:i,transition:o.n.FadeToBlack})),this.engine.commandBinder.issueCommand(new l.Ar(e,d.Er.OBJECT,!1))}async closeSelectedSuggestion(){const e=this.pinsViewData.selectedPin;e&&e.pinType===d.Er.OBJECT&&this.engine.commandBinder.issueCommand(new l.RH(e.id,d.Er.OBJECT))}async setTagsEnabled(e,...t){0===t.length&&(t=this.data.getObjectTagIds()),await this.data.setEnabled(e,...t);for(const i of this.data.suggestions)t.includes(i.id)&&(i.enabled=e,i.commit());this.engine.commandBinder.issueCommand(new w.s7)}async deleteTags(...e){0===e.length&&(e=this.data.getObjectTagIds());const t=await this.data.delete(...e);for(const e of t)this.engine.commandBinder.issueCommand(new l.OL(e.id,d.Er.OBJECT)),e&&e.mattertagId&&this.engine.commandBinder.issueCommand(new H.T3(e.mattertagId,"search_menu_object_tag"));this.engine.commandBinder.issueCommand(new w.s7);const i=this.annotationsViewData.billboardAnnotation;(null==i?void 0:i.annotationType)===p.J.OBJECT&&this.engine.commandBinder.issueCommand(new c.Aj(i.id,i.annotationType))}}},66338:(e,t,i)=>{"use strict";i.d(t,{W:()=>OrderedListData});var n=i(67992),s=i(15637);class OrderedListData extends n.V{constructor(e){super(),this.name="ordered-list-data",this.lists=(0,s.q)(e)}replace(e){this.lists.replace(e)}getOrderedLists(){return this.lists.values}getOrderedList(e){return this.lists.get(e)}updateOrderedList(e){this.lists.has(e.name)?this.lists.get(e.name).copy(e):this.lists.set(e.name,e)}}},43846:(e,t,i)=>{"use strict";i.d(t,{wg:()=>SaveNamedOrderedListCommand,Bd:()=>CreateOrderedListCommand,ui:()=>UpdateOrderedListCommand});var n=i(19663);class SaveNamedOrderedListCommand extends n.m{constructor(e,t){super(),this.payload={name:e,entries:t}}}class CreateOrderedListCommand extends n.m{constructor(e,t){super(),this.payload={name:e,entries:t}}}class UpdateOrderedListCommand extends n.m{constructor(e,t,i){super(),this.payload={id:e,name:t,entries:i}}}},24102:(e,t,i)=>{"use strict";var n;i.d(t,{l:()=>n}),function(e){e.TAG="tag"}(n||(n={}))},51366:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CreateOrderedListCommand:()=>y.Bd,MdsOrderedListDeserializer:()=>MdsOrderedListDeserializer,MdsOrderedListStore:()=>MdsOrderedListStore,OrderedList:()=>OrderedList,OrderedListData:()=>v.W,OrderedListEntryType:()=>w.l,SaveNamedOrderedListCommand:()=>y.wg,TAG_ORDERED_LIST_NAME:()=>b.q,UpdateOrderedListCommand:()=>y.ui,default:()=>f});var n=i(97542),s=i(57956),a=i(79728),o=i(635),r=i(90632),d=i(75287);class OrderedList extends d.T{constructor(e){super(),this.id="",this.name="",this.description="",this.entries=[],e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.name=e.name,e.description&&(this.description=e.description),this.entries=e.entries.slice(),this.commit(),this}}var l=i(17788),h=i(29474),c=i(73123),m=i(97998),u=i(22001);const g=new m.Z("ordered-list-deserializer");class MdsOrderedListDeserializer{deserialize(e){var t;return e&&this.validate(e)?new OrderedList({id:e.id,name:null!==(t=e.label)&&void 0!==t?t:"",entries:e.entries.filter((e=>!!e)).map((e=>({id:e.id,type:e.type})))}):(g.debug("Deserialized invalid ordered list data from Mds",e),null)}validate(e){return["id","label","entries"].every((t=>t in e))}}const p=new m.Z("MdsOrderedListStore");class MdsOrderedListStore extends l.u{constructor(e){super(e),this.prefetchKey="data.model.orderedLists",this.deserializer=new MdsOrderedListDeserializer}async read(){const e=this.getViewId();return this.query(u.GetOrderedLists,{modelId:e}).then((e=>{var t,i;const n=null===(i=null===(t=e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.orderedLists;if(!n||!Array.isArray(n))return p.debug("GetOrderedLists failed"),{};return n.reduce(((e,t)=>{const i=this.deserializer.deserialize(t);return i&&(e[i.name]&&p.debug(`Duplicate orderedList found with label: ${i.name}`),e[i.name]=i),e}),{})}))}async create(e){if(0===e.length)return[];const t=this.getViewId();return Promise.all(e.map((e=>this.mutate(u.AddOrderedList,{modelId:t,label:e.name,description:e.description,entries:e.entries}).then((e=>{var t;return this.deserializer.deserialize(null===(t=e.data)||void 0===t?void 0:t.addOrderedList)})))))}async update(e){if(0===e.length)return;const t=this.getViewId();let i="";const n={};n.modelId=t;let s="";for(const t of e){const e=t.id;i+=`\n        , $label${e}: String!\n        , $description${e}: String!\n        , $entries${e}: [EntryInput!]\n      `,n[`label${e}`]=t.name,n[`description${e}`]=t.description,n[`entries${e}`]=t.entries,s+=`\n        update${e}:\n        patchOrderedList(modelId: $modelId,\n                         orderedListId: "${e}",\n                         label: $label${e},\n                         description: $description${e},\n                         entries: $entries${e}) {\n          id\n          label\n          entries {\n            id\n            type\n          }\n        }\n      `}const a=h.Ps`
      mutation orderedListsUpdate($modelId: ID! ${i}) {
        ${s}
      }
    `;return this.mutate(a,n).then((e=>{p.debug(Object.assign({type:"patchOrderedList"},Object.values((0,c.q)(e,"data"))))}))}}var v=i(66338),y=i(43846);class OrderedListsModule extends n.Y{constructor(){super(...arguments),this.name="ordered-lists",this.saveNamedOrderedList=async e=>{const{name:t,entries:i}=e;let n=this.data.getOrderedList(t);return n?n.entries=i:n=new OrderedList({name:t,entries:i}),this.data.updateOrderedList(n),this.engine.commandBinder.issueCommand(new o.VQ({dataTypes:[a.g.ORDERED_LISTS]}))}}async init(e,t){const{baseUrl:i,workshop:n}=e;if(this.engine=t,this.store=new MdsOrderedListStore({baseUrl:i,readonly:!n}),this.bindings.push(this.store.onNewData((async e=>{this.data.replace(e)}))),this.data=new v.W({}),await this.store.refresh(),n){const e=await t.getModuleBySymbol(s.y.STORAGE);this.bindings.push(t.commandBinder.addBinding(y.wg,this.saveNamedOrderedList),e.onSave((()=>this.save()),{dataType:a.g.ORDERED_LISTS}));const i=await t.market.waitForData(r.Q);i.setPublishableType(a.g.ORDERED_LISTS),i.setRevertableType(a.g.ORDERED_LISTS)}t.market.register(this,v.W,this.data)}dispose(e){this.store.dispose(),super.dispose(e)}onUpdate(){}async save(){const e=this.data.getOrderedLists(),t=[],i=[];e.forEach((e=>{""===e.id?t.push(e):i.push(e)}));return Promise.all([this.store.create(t),this.store.update(i)]).then((e=>{e[0].forEach((e=>{e&&this.data.updateOrderedList(e)}))}))}}var w=i(24102),b=i(25561);const f=OrderedListsModule},25561:(e,t,i)=>{"use strict";i.d(t,{q:()=>n});const n="mp.tags"},47297:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CancelNewPinCommand:()=>_.tT,ChangePinOpacityByTypeCommand:()=>_.kb,ChangePinOpacityCommand:()=>_._Y,ChangePinVisibilityByTypeCommand:()=>_.qN,ChangePinVisibilityCommand:()=>_.ik,ClickOffPinCommand:()=>_.yR,CreatePinCommand:()=>_.fM,EnablePinCreationCommand:()=>_.Ki,MovePinCommand:()=>_.I$,NewPinReadyMessage:()=>$.cd,PinAddCancelledMessage:()=>$.hu,PinAnchorMesh:()=>PinAnchorMesh,PinClickedMessage:()=>$.F7,PinColorVariant:()=>F.K_,PinEditor:()=>PinEditor,PinEditorState:()=>F.V8,PinHeadMesh:()=>H.$,PinHoverChangeMessage:()=>$.tP,PinMovedMessage:()=>$.bV,PinPlacedMessage:()=>$.b0,PinPlacementCancelledMessage:()=>$.pe,PinPreviewDirection:()=>F.Od,PinRenderer:()=>PinRenderer,PinSelectedMessage:()=>$.Q4,PinType:()=>F.Er,PinUnselectedMessage:()=>$.WM,PinsViewData:()=>D.B,PlacePinCommand:()=>_.ip,RemovePinCommand:()=>_.OL,RemovePinsByTypeCommand:()=>_.zM,SelectPinCommand:()=>_.Ar,UnselectPinCommand:()=>_.RH,UpdatePinCommand:()=>_.tE,UpdatePinViewsCommand:()=>_.mE,default:()=>we});var n=i(84428),s=i(97542),a=i(57956),o=i(59370),r=i(31362),d=i(54244),l=i(5332),h=i(79727),c=i(5135),m=i(25985),u=i(53954),g=i(23254),p=i(95882),v=i(95512),y=i(38987),w=i(34956),b=i(14630),f=i(10699),T=i(79596),D=i(60083),C=i(89570),P=i(53058),M=i(82814);var S=i(94046),A=i(97998),E=i(72996),k=i(16769),I=i(16782),N=i(67678),O=i(86819),V=i(80592),R=i(62017),x=i(89553),B=i(6667),L=i(32597),F=i(62612),H=i(33160),U=i(12529),G=i(87926),z=i(30749),j=i(84958);class PinAnchorMesh extends n.Mesh{constructor(e){super(new n.PlaneGeometry(j.Z.anchor.size,j.Z.anchor.size),new n.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:PinAnchorMesh.getTexture(),side:n.DoubleSide})),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=U.z.pins}static getTexture(){return PinAnchorMesh.anchorTexture||(PinAnchorMesh.anchorTexture=(0,G.p)(z)),PinAnchorMesh.anchorTexture}}var _=i(72936),$=i(13132),W=i(76957),J=i(35826),K=i(12039),Y=i(51411);class PinEditor{constructor(e,t,i,s){this.viewData=e,this.engine=t,this.input=i,this.pinRenderer=s,this.editEnabled=!1,this.handlersRegistered=!1,this.bindings=[],this.externalBehaviorsBlocked=!1,this.touchDevice=(0,r.Jm)(),this.longPressCreateThreshold=500,this.ndcPoint=new n.Vector3,this.movingPin=!1,this.anchored=!1,this.inAnchorClick=!1,this.startingPinData=void 0,this.log=new A.Z("pin-editor"),this.stopEventPropagation=()=>!0,this.updateMeshPreviewSphere=async(e,t)=>{this.engine.commandBinder.issueCommand(new Y.n(e,t))},this.startPinCreation=()=>{this.editEnabled&&(this.addingHandlers.renew(),this.touchDevice||this.engine.commandBinder.issueCommand(new y.u(w.C.XHAIR)),this.engine.commandBinder.issueCommand(new J.ZD))},this.endPinCreation=()=>{this.editEnabled&&(this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.clearLongPressTimeout(),this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new y.u(w.C.DEFAULT)),this.engine.commandBinder.issueCommand(new J.zd))},this.onSelectedPinChanged=()=>{const{selectedPin:e}=this.viewData;e?this.selectedHandlers.renew():this.selectedHandlers.cancel(),this.updateAnchorMesh()},this.onPinStateUpdated=()=>{const e=this.viewData.pinEditorState;switch(this.updateAnchorMesh(),e){case F.V8.PLACING:this.draggingHandlers.renew();break;case F.V8.IDLE:this.allowExternalBehaviors(!0)}},this.updateAnchorMesh=()=>{if(!this.editEnabled)return;const{selectedPin:e,pinEditorState:t,isPinEditable:i}=this.viewData;e&&t!==F.V8.CREATING?([F.V8.PLACING,F.V8.PLACED].includes(t)||i?(this.pinRenderer.showAnchorMesh(e.pinType,e.id,e),this.anchored=!0):this.removePinAnchorMesh(),this.editableSelectedHandlers.renew()):(this.editableSelectedHandlers.cancel(),this.anchored&&this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1))},this.clearLongPressTimeout=()=>{this.longPressStart=0,-1!==this.longPressTimeout&&window.clearTimeout(this.longPressTimeout),this.longPressTimeout=-1},this.placePin=()=>{this.viewData.pinEditorState===F.V8.PLACING&&(this.engine.commandBinder.issueCommand(new y.u(w.C.DEFAULT)),this.engine.commandBinder.issueCommand(new _.ip),this.engine.broadcast(new $.cd),this.updateMeshPreviewSphere(!1))},this.onDragEvent=e=>{e.buttons!==I.r.PRIMARY&&(this.touchDevice||this.viewData.selectedPin)||this.positionPin(e)},this.onDragEnd=e=>{const{selectedPin:t,creatingNewPin:i,pinEditorState:n}=this.viewData;i&&!this.touchDevice&&n===F.V8.PLACING||t&&!i&&(this.engine.commandBinder.issueCommand(new _.I$(t.id,this.copyPinData(t),this.startingPinData)),this.updateMeshPreviewSphere(!1))},this.positionPin=(()=>{const e=new n.Vector3;return async t=>{if(this.touchDevice&&t.buttons!==I.r.PRIMARY)return!1;const i=this.viewData,n=i.pinEditorState;if(n===F.V8.CREATING)this.engine.commandBinder.issueCommand(new v.y(!0));else if(n!==F.V8.PLACING&&!this.movingPin)return!1;const s=i.selectedPin;if(!s)return!1;this.saveScreenPosition(t.position.x,t.position.y);const a=this.getModelIntersection();if(a&&a.face){this.engine.commandBinder.issueCommand(new y.u(w.C.XHAIR)),i.setCanPlace(!0);const t=((e,t,i)=>{var n;return null!==(n=t.floorIdFromObject(i.object))&&void 0!==n?n:e.getClosestFloorAtHeight(i.point.y).id})(this.floorsData,this.meshQuery,a);if(null===t)return!1;const o=this.meshQuery.mdsRoomIdFromObject(a.object);return e.copy(s.stemNormal).setLength(s.stemLength),this.updateMeshPreviewSphere(!0,s.anchorPosition),i.updateSelectedPin({anchorPosition:s.anchorPosition.copy(a.point),stemNormal:s.stemNormal.copy(a.face.normal).normalize(),floorId:t,roomId:o}),n===F.V8.CREATING&&i.setPinEditorState(F.V8.PLACING),!0}return this.engine.commandBinder.issueCommand(new y.u(w.C.NOPE)),i.setCanPlace(!1),!1}})(),this.allowExternalBehaviors=async e=>{e||this.externalBehaviorsBlocked?e&&this.externalBehaviorsBlocked&&(this.dragInterceptor.cancel(),this.engine.commandBinder.issueCommand(new K.Lp),this.externalBehaviorsBlocked=!1):(this.dragInterceptor.renew(),this.engine.commandBinder.issueCommand(new K.ZK),this.externalBehaviorsBlocked=!0)},this.getModelIntersection=()=>{const e=.5*j.Z.anchor.size;return this.fatcaster.cast(e,(e=>!!(0,k.Pv)(e)&&(!this.viewmodeData.isDollhouse()&&!this.viewmodeData.isFloorplan()||this.floorsViewData.isCurrentMeshGroupOrAllFloors(e.meshGroup))),P.a.Filter.CENTER_GROUP(e))},this.onPointerButton=e=>{e.down||this.viewData.pinEditorState!==F.V8.PLACED||(this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new v.y(!1)))},this.onAnchorSelect=e=>{const{selectedPin:t,isPinEditable:i,pinEditorState:n}=this.viewData;!t||e.button!==I.M.PRIMARY||n!==F.V8.PLACED&&n!==F.V8.IDLE||(i?e.down?(this.movingPin=!0,this.startingPinData=this.copyPinData(t),this.allowExternalBehaviors(!1),this.draggingHandlers.renew(),this.engine.commandBinder.issueCommand(new y.u(w.C.GRABBING)),this.engine.commandBinder.issueCommand(new v.y(!0)),this.inAnchorClick=!0):(this.doneMovingPin(),this.inAnchorClick=!1):this.log.debug("onAnchorSelect called on a non-editable pin"))},this.doneMovingPin=()=>{this.viewData.selectedPin&&this.movingPin&&(this.draggingHandlers.cancel(),this.engine.commandBinder.issueCommand(new y.u(null)),this.engine.commandBinder.issueCommand(new v.y(!1)),this.movingPin=!1,this.startingPinData=void 0,this.allowExternalBehaviors(!0),this.updateMeshPreviewSphere(!1))},this.onClickElsewhere=e=>{const{selectedPin:t,pinEditorState:i}=this.viewData;if(!(i===F.V8.CREATING&&t||this.inAnchorClick))return t&&(this.movingPin?this.doneMovingPin():this.engine.commandBinder.issueCommand(new _.yR)),!0},this.onLongPressStart=async e=>{if(e.buttons!==I.r.PRIMARY)return;const t=this.viewData;t.pinEditorState===F.V8.CREATING&&(this.longPressStart=Date.now(),t.setPinEditorState(F.V8.PRESSING),this.allowExternalBehaviors(!1),this.saveScreenPosition(e.position.x,e.position.y),this.longPressTimeout=window.setTimeout((async()=>{t.setPinEditorState(F.V8.PLACING);await this.positionPin(e)||(t.setPinEditorState(F.V8.CREATING),t.setCanPlace(!1)),this.longPressTimeout=-1}),this.longPressCreateThreshold))},this.onLongPressEnd=()=>{const e=this.viewData.pinEditorState;e===F.V8.PRESSING?(this.log.debug("Did not press long enough"),this.endPinCreation()):e===F.V8.PLACING&&this.placePin()},this.onPointerEvent=e=>{const t=this.viewData.pinEditorState;t!==F.V8.PLACING&&t!==F.V8.CREATING||this.positionPin(e)},this.onClickToPlacePin=()=>{this.placePin()},this.onKeyEvent=e=>{if(e.state===B.M.PRESSED)switch(e.key){case L.R.ESCAPE:this.viewData.creatingNewPin&&this.engine.broadcast(new $.pe)}},Promise.all([t.market.waitForData(m.M),t.market.waitForData(W.i),t.market.waitForData(h.c),t.market.waitForData(g.O),t.getModuleBySymbol(a.y.FAT_RAYCAST),t.getModuleBySymbol(a.y.MESH_QUERY)]).then((([t,n,s,a,o,r])=>{this.cameraData=t,this.floorsData=n,this.floorsViewData=s,this.viewmodeData=a,this.fatcaster=o,this.meshQuery=r,this.bindings.push(i.registerPriorityHandler(N.er,H.$,this.stopEventPropagation),e.onSelectedPinChanged(this.onSelectedPinChanged)),this.selectedHandlers=new C.V(i.registerPriorityHandler(O.R,M.S,this.onClickElsewhere),i.registerPriorityHandler(O.R,S.i,this.onClickElsewhere)),this.selectedHandlers.cancel()}))}dispose(){this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1),this.dragInterceptor.cancel(),this.addingHandlers.cancel(),this.draggingHandlers.cancel(),this.selectedHandlers.cancel(),this.editableSelectedHandlers.cancel(),this.bindings.forEach((e=>{e.cancel()}))}update(){if(!this.editEnabled)return;const e=this.viewData;if(this.touchDevice&&e.pinEditorState===F.V8.PRESSING){const t=Math.min(1,(Date.now()-this.longPressStart)/this.longPressCreateThreshold);e.setProgress(t)}}toggleEditing(e){e!==this.editEnabled&&(this.editEnabled=e,e?(this.handlersRegistered?this.creationHandlers.renew():this.registerHandlers(),this.updateAnchorMesh()):(this.inAnchorClick=!1,this.anchored=!1,this.movingPin=!1,this.creationHandlers.cancel(),this.allowExternalBehaviors(!0),this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1)),this.dragInterceptor.cancel(),this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.editableSelectedHandlers.cancel())}registerHandlers(){const e=this.input,t=this.viewData;this.creationHandlers=new C.V(t.onPinEditorStateChanged(this.onPinStateUpdated)),this.dragInterceptor=new C.V(e.registerPriorityHandler(V._t,M.S,(()=>!0)),e.registerPriorityHandler(V._t,S.i,(()=>!0))),this.draggingHandlers=new C.V(e.registerUnfilteredHandler(V._t,this.onDragEvent),e.registerUnfilteredHandler(V._R,this.onDragEnd)),this.editableSelectedHandlers=new C.V(e.registerMeshHandler(N.er,E.s.isType(PinAnchorMesh),this.onAnchorSelect)),this.touchDevice?this.addingHandlers=new C.V(e.registerHandler(N.er,this.onPointerButton),e.registerUnfilteredHandler(R.Vh,this.onLongPressStart),e.registerUnfilteredHandler(R.pt,this.onLongPressEnd)):this.addingHandlers=new C.V(e.registerHandler(x.e,this.onKeyEvent),e.registerHandler(N.er,this.onPointerButton),e.registerUnfilteredHandler(O.R,this.onClickToPlacePin),e.registerHandler(N.mE,this.onPointerEvent))}removePinAnchorMesh(){this.pinRenderer.hideAnchorMesh(),this.anchored=!1}copyPinData(e){return{anchorPosition:e.anchorPosition.clone(),stemNormal:e.stemNormal.clone(),floorId:e.floorId,roomId:e.roomId,stemLength:e.stemLength,stemEnabled:e.stemEnabled,color:e.color,layerId:e.layerId}}saveScreenPosition(e,t){this.ndcPoint.set(e,t,0);const i=(0,o.fi)(this.cameraData.width,this.cameraData.height,this.ndcPoint);this.viewData.setScreenPosition(i)}}var q=i(23612),Z=i(4510),Q=i(7402),X=i(23885),ee=i(55763);class PinSelectedMesh extends n.Mesh{constructor(e){super(new n.PlaneGeometry(j.Z.anchor.size,j.Z.anchor.size),new ee.Dx),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=U.z.pinSelectedHalo}}class PinRenderer{constructor(e,t,i,s){this.input=e,this.layer=t,this.commandBinder=i,this.raycaster=s,this.container=new n.Object3D,this.floorIdToContainer=new Map,this.hexColorToColor=new Map,this.bindings=[],this.anchor=null,this.selected=null,this.haloEasing=(0,X.tf)(.5,.52,0,1.98),this.pinsWithOverrideTexture=new Set,this.iconsEnabled=!1,this.updateAnchorPosition=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3;return n=>{const s=this.anchorMesh;if(!s)return;const a=this.raycaster.picking;e.copy(n.stemNormal).normalize(),t.copy(e).multiplyScalar(.2).add(n.anchorPosition),i.copy(e).multiplyScalar(-1);const o=a.pick(t,i,(e=>e instanceof Q.g));if(o){const e=Math.min(.2,o.distance);s.position.copy(t).add(i.multiplyScalar(.999*e))}else s.position.copy(t).add(i.multiplyScalar(.999*n.stemLength));s.lookAt(t)}})(),this.onAnchorHover=()=>{this.commandBinder.issueCommand(new y.u(w.C.GRAB)),this.commandBinder.issueCommand(new v.y(!0))},this.onAnchorUnhover=()=>{this.commandBinder.issueCommand(new y.u(null)),this.commandBinder.issueCommand(new v.y(!1))}}init(){this.container.name="PinContainer",this.container.layers.mask=this.layer.mask,this.anchorMesh=new PinAnchorMesh(this.layer),this.anchorMesh.name="Anchor Mesh",this.container.add(this.anchorMesh),this.selectedMesh=new PinSelectedMesh(this.layer),this.selectedMesh.name="Selected Mesh",this.container.add(this.selectedMesh)}dispose(){this.container.parent&&this.container.parent.remove(this.container);for(const e of[this.anchorMesh,this.selectedMesh])e&&e.parent&&e.parent.remove(e)}activate(e){this.bindings.length>0||this.bindings.push(this.input.registerMeshHandler(q.z,E.s.isType(PinAnchorMesh),this.onAnchorHover),this.input.registerMeshHandler(q.A,E.s.isType(PinAnchorMesh),this.onAnchorUnhover))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}render(e){if(!this.selected)return;const{animation:t,hideWhenDoneAnimating:i}=this.selected,s=this.selectedMesh;if(s&&s.visible&&t){const e=this.pinHeadTransform(this.selected.id),a=new n.Vector3,o=new n.Quaternion,r=new n.Vector3;e.decompose(a,o,r),r.multiplyScalar(t.getUpdatedValue()),i&&!t.isAnimating?(s.visible=!1,this.selected=null):(s.position.copy(a),s.quaternion.copy(o),s.scale.copy(r))}}updatePin(e,t,i,n,s,a){this.anchorMesh&&this.anchorMesh.visible&&this.anchor&&this.anchor.pinType===t&&this.anchor.id===e&&this.updateAnchorPosition(i)}removePin(e){this.selected&&this.selected.id===e&&this.clearSelected()}removePinsByType(e){this.removePinsByPredicate((t=>t===e))}removePinsByPredicate(e){}setPinVisible(e,t){}setPinColorVariant(e,t){}setPinColorVariants(e,t){}setPinColorVariantByType(e,t,i){}setPinOpacity(e,t){}setPinOpacityByType(e,t,i){}fadePinOpacity(e,t){}fadePinOpacityByType(e,t,i=[]){}setPinRenderOverrides(e,t,i){t?(this.pinsWithOverrideTexture.add(e),this.selected&&this.selected.id===e&&this.clearSelected()):this.pinsWithOverrideTexture.delete(e)}setFloorsHidden(e){this.floorIdToContainer.forEach(((t,i)=>{t.visible=!e(i)}))}setPinTypeVisible(e,t){this.floorIdToContainer.forEach((i=>{i.userData.typeContainers[e].visible=t}))}showAnchorMesh(e,t,i){this.anchor={pinType:e,id:t},this.anchorMesh&&!this.anchorMesh.visible&&(this.anchorMesh.visible=!0,this.input.registerMesh(this.anchorMesh,!1)),this.updateAnchorPosition(i)}hideAnchorMesh(){this.anchorMesh&&this.anchorMesh.visible&&(this.anchorMesh.visible=!1,this.input.unregisterMesh(this.anchorMesh))}showSelectedMesh(e,t){const i=this.selected&&this.selected.pinType===e&&this.selected.id===t;this.selected&&i||this.pinsWithOverrideTexture.has(t)||(this.selected={pinType:e,id:t,hideWhenDoneAnimating:!1,animation:new Z.Z({startValue:10,endValue:14,duration:300,easingFunction:this.haloEasing})},this.selectedMesh.visible=!0)}hideSelectedMesh(){this.selected&&(this.selected.animation=new Z.Z({startValue:14,endValue:10,duration:300}),this.selected.hideWhenDoneAnimating=!0)}getFloorContainer(e){let t=this.floorIdToContainer.get(e);if(t)return t;t=new n.Object3D,t.name="Floor "+e,t.userData.typeContainers={},t.layers.mask=this.layer.mask;for(const e of Object.values(F.Er)){const i=new n.Object3D;i.name=e,i.layers.mask=this.layer.mask,t.add(i),t.userData.typeContainers[e]=i}return this.container.add(t),this.floorIdToContainer.set(e,t),t.userData.floorId=e,t}getColor(e){let t=this.hexColorToColor.get(e);if(t)return t;const i=new n.Color(e),s={h:0,s:0,l:0};i.getHSL(s);return t={baseColor:i,hoverColor:(new n.Color).setHSL(s.h,s.s,.8*s.l),dimmedColor:(new n.Color).setHSL(s.h,.5*s.s,s.l)},this.hexColorToColor.set(e,t),t}getViewportScale(e){return Math.sqrt(Math.min(e.width,e.height)/j.Z.pinHeadMesh.scale.baseViewportSize)}clearSelected(){this.selectedMesh.visible=!1,this.selected=null}}class PinStemMesh extends n.Line{constructor(e,t,i,s,a){const o=new n.BufferGeometry,r=new Float32Array(6);r[0]=r[1]=r[2]=0,r[3]=e.x,r[4]=e.y,r[5]=e.z,o.setAttribute("position",new n.BufferAttribute(r,3));const d=new ee.l0;super(o,d),this.geometry=o,this.layers.mask=i.mask,this.visible=t,this.vector=e.clone(),this.onBeforeRender=(e,t,i,n,o)=>{const r=o;r.uniforms.pinHeadMatrix.value.copy(s.matrixWorld),r.uniforms.resolution.value.set(a.width,a.height),r.uniformsNeedUpdate=!0},this.pinStemMaterial=d}dispose(){this.geometry.dispose()}updatePosition(e){this.vector.copy(e.stemNormal).setLength(Math.max(e.stemLength,.01));const t=this.geometry.getAttribute("position");t.setXYZ(1,this.vector.x,this.vector.y,this.vector.z),t.needsUpdate=!0}}var te=i(39689),ie=i(89557);class PinMeshGroup extends n.Object3D{constructor(e,t,i,s,a,o,r,d,l,h,c){super(),this.pinId=e,this.pinType=t,this.pinColor=s,this.stemVector=new n.Vector3,this.stemEnabled=!0,this.currentColorVariant=F.K_.DEFAULT,this.baseOpacity=1,this.pinHeadGeometryInst=new n.PlaneGeometry(j.l,j.l),this.pinHeadGeometryInst.setAttribute("instanceUvOffset",new n.BufferAttribute(a,2)),this.pinHeadGeometryInst.setAttribute("instanceUvScale",new n.BufferAttribute(o,1)),this.pinHeadGeometryInst.setAttribute("instanceStrokeWidth",new n.BufferAttribute(c,1)),PinMeshGroup.pinHeadGeometry||(PinMeshGroup.pinHeadGeometry=new n.PlaneGeometry(j.l,j.l));const m=(new n.Color).copy(s.baseColor);this.pinHeadMeshMaterial=new ee.Nv(m,l,h,1),this.pinHeadMesh=new H.$(e,this.pinHeadGeometryInst,this.pinHeadMeshMaterial,r),this.add(this.pinHeadMesh),this.stemMesh=new PinStemMesh(i.stemNormal,i.stemEnabled,r,this.pinHeadMesh,d),this.add(this.stemMesh),this.updateMeshPosition(i),this.opacityAnimation=new ie.z(1)}dispose(){this.remove(this.pinHeadMesh),this.pinHeadMesh.material.dispose(),this.pinHeadMesh.dispose(),this.remove(this.stemMesh),this.stemMesh.dispose()}static disposeAll(){PinMeshGroup.pinHeadGeometry.dispose()}updateFromPin(e,t,i,s,a,o,r){this.position.copy(e.anchorPosition),this.pinHeadMesh.updatePosition(e),this.stemVector.copy(e.stemNormal).setLength(e.stemLength),this.stemEnabled=e.stemEnabled,this.stemMesh.updatePosition(e),this.stemMesh.visible=e.stemEnabled,this.pinHeadGeometryInst.setAttribute("instanceUvOffset",new n.BufferAttribute(i,2)),this.pinHeadGeometryInst.setAttribute("instanceUvScale",new n.BufferAttribute(s,1)),this.pinHeadGeometryInst.setAttribute("instanceStrokeWidth",new n.BufferAttribute(r,1)),t!==this.pinColor&&(this.pinColor=t,this.setColorVariant(this.currentColorVariant));const d=this.pinHeadMeshMaterial.uniforms;d.bg.value===a&&d.mask.value===o||(d.bg.value=a,d.mask.value=o,this.pinHeadMeshMaterial.uniformsNeedUpdate=!0)}setColorVariant(e){const t=(0,te.k)(this.pinColor,e);this.pinHeadMeshMaterial.uniforms.color.value.copy(t),this.currentColorVariant=e}setOpacity(e){this.baseOpacity=e,this.updateOpacity()}fadeOpacity(e){e>0&&(this.visible=!0),this.opacityAnimation.modifyAnimation(this.opacityAnimation.value,e,300).onComplete((()=>{e<=0&&(this.visible=!1)}))}setVisibility(e,t){this.visible=e,this.pinHeadMesh.visible=e,this.stemMesh.visible=e&&t}setStemEnabled(e){this.stemMesh.visible=this.visible&&e}updateMeshPosition(e){this.position.copy(e.anchorPosition),this.pinHeadMesh.updatePosition(e),this.stemMesh.updatePosition(e)}update(e,t,i,n){this.pinHeadMesh.update(t,i,n);const s=this.opacityAnimation.active;this.opacityAnimation.tick(e),s&&this.updateOpacity()}setRenderOverrides(e,t){this.pinHeadMesh.material=e?new ee.m0(e,!1):this.pinHeadMeshMaterial,t?this.pinHeadMesh.geomScale.copy(t):this.pinHeadMesh.geomScale.set(1,1,1),this.setOpacity(this.pinHeadMeshMaterial.opacity)}updateOpacity(){const e=this.opacityAnimation.value*this.baseOpacity;if(this.pinHeadMeshMaterial.opacity=e,this.pinHeadMeshMaterial.uniforms.alpha.value=e,this.pinHeadMesh.material!==this.pinHeadMeshMaterial){this.pinHeadMesh.material.opacity=e;const t=this.pinHeadMesh.material;t&&t.uniforms&&t.uniforms.alpha&&(t.uniforms.alpha.value=e)}this.stemMesh.pinStemMaterial.uniforms.alpha.value=e}}var ne=i(81346);class NonInstancedPinRenderer extends PinRenderer{constructor(e,t,i,n,s,a,o,r){super(e,n,s,a),this.camera=t,this.canvasData=i,this.codepointMap=r,this.idToMesh=new Map,this.inputCallbacks=o}dispose(){super.dispose(),this.removePinsByPredicate((()=>!0)),PinMeshGroup.disposeAll()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(O.R,H.$,((e,t)=>{const i=t.parent;return this.inputCallbacks.onClick(i.pinId,i.pinType),!0}))),(0,r.Jm)()||(this.bindings.push(this.input.registerMeshHandler(q.z,E.s.isType(H.$),((e,t)=>{const i=t.parent;this.inputCallbacks.onHover(i.pinId,i.pinType)}))),this.bindings.push(this.input.registerMeshHandler(q.A,E.s.isType(H.$),((e,t)=>{const i=t.parent;this.inputCallbacks.onUnhover(i.pinId,i.pinType)})))))}render(e){const t=this.getViewportScale(this.canvasData);this.idToMesh.forEach((i=>{i.update(e,this.camera,t,this.canvasData)})),super.render(e)}updatePin(e,t,i,n,s,a){var o,r;super.updatePin(e,t,i,n,s,a);const d=this.getColor(i.color),l=(0,te.m)(t,i.icon,this.iconsEnabled),h=ne.f[l],c=this.codepointMap[+h],m=new Float32Array(8),u=new Float32Array(4),g=new Float32Array(4);if(c){const{u:e,v:t,uvScale:i}=c;u[0]=i,u[1]=i,u[2]=i,u[3]=i,m[0]=e,m[2]=e,m[4]=e,m[6]=e,m[1]=t,m[3]=t,m[5]=t,m[7]=t}const p=t===F.Er.OBJECT?0:.06;g[0]=p,g[1]=p,g[2]=p,g[3]=p;let v=this.idToMesh.get(e);v||(v=new PinMeshGroup(e,t,i,d,m,u,this.layer,this.canvasData,n,s,g),this.idToMesh.set(e,v),this.input.registerMesh(v.pinHeadMesh,!1)),void 0!==a&&(v.visible=a),v.updateFromPin(i,d,m,u,n,s,g);const y=i.floorId;v.parent&&(null===(o=v.parent)||void 0===o?void 0:o.userData.floorId)===y||(v.parent&&(null===(r=v.parent)||void 0===r||r.remove(v)),this.getFloorContainer(y).userData.typeContainers[t].add(v))}removePin(e){var t;super.removePin(e);const i=this.idToMesh.get(e);i&&(this.idToMesh.delete(e),null===(t=i.parent)||void 0===t||t.remove(i),this.input.unregisterMesh(i.pinHeadMesh),i.dispose())}removePinsByPredicate(e){this.idToMesh.forEach(((t,i)=>{e(t.pinType)&&this.removePin(i)}))}setPinVisible(e,t){const i=this.idToMesh.get(e);i&&(i.visible=t)}setPinColorVariant(e,t){const i=this.idToMesh.get(e);i&&i.setColorVariant(t)}setPinColorVariants(e,t){this.idToMesh.forEach((i=>{i.pinId!==t&&i.setColorVariant(e)}))}setPinColorVariantByType(e,t,i){this.idToMesh.forEach((n=>{n.pinType===e&&n.pinId!==i&&n.setColorVariant(t)}))}setPinOpacity(e,t){const i=this.idToMesh.get(e);i&&i.setOpacity(t)}fadePinOpacity(e,t){const i=this.idToMesh.get(e);i&&i.fadeOpacity(t)}setPinOpacityByType(e,t,i){this.idToMesh.forEach((n=>{n.pinType===e&&n.pinId!==i&&n.setOpacity(t)}))}fadePinOpacityByType(e,t,i=[]){this.idToMesh.forEach((n=>{n.pinType!==e||i.includes(n.pinId)||n.fadeOpacity(t)}))}setPinRenderOverrides(e,t,i){super.setPinRenderOverrides(e,t,i);const n=this.idToMesh.get(e);n&&n.setRenderOverrides(t,i)}pinHeadTransform(e){const t=this.idToMesh.get(e);return t?t.pinHeadMesh.matrixWorld:new n.Matrix4}}var se=i(66372),ae=i(49827),oe=i(21646),re=i(90304),de=i(79183);const le=new ee.uW,he=new A.Z("InstancedPinHeads");class InstancedPinLines extends n.InstancedMesh{constructor(e){const t=new n.BufferGeometry,i=new Float32Array(6);i[0]=i[1]=i[2]=0,i[3]=1,i[4]=1,i[5]=1,t.setAttribute("position",new n.BufferAttribute(i,3));const s=new Float32Array(3*e),a=new n.InstancedBufferAttribute(s,3);t.setAttribute("stemVector",a);const o=new Float32Array(e),r=new n.InstancedBufferAttribute(o,1);t.setAttribute("instanceAlpha",r);const d=[],l=[];for(let i=0;i<4;i++){const s=new Float32Array(4*e),a=new n.InstancedBufferAttribute(s,4);t.setAttribute(`pinHeadMatrixCol${i}`,a),d.push(s),l.push(a)}super(t,le,e),this.maxCount=e,this.stemVectorArray=s,this.stemVectorAttrib=a,this.pinHeadMatrixArray=d,this.pinHeadMatrixAttrib=l,this.opacityArray=o,this.opacityAttrib=r,this.renderOrder=U.z.lines,this.posMatrix=new n.Matrix4,this.isLine=!0,this.isMesh=!1}update(e,t){let i=0;for(const t of e){if(!t.visible||!t.stemEnabled||t.stemLength<.001)continue;if(i>=this.maxCount){he.error("Instance count is too small!");continue}this.posMatrix.setPosition(t.anchorPosition),this.setMatrixAt(i,this.posMatrix),this.opacityArray[i]=t.opacity*t.opacityAnimation.value;const e=3*i;t.pinHeadObjPosition.toArray(this.stemVectorArray,e);let n=0;for(let e=0;e<4;e++)for(let s=0;s<4;s++)this.pinHeadMatrixArray[e][s+4*i]=t.pinHeadMatrix.elements[n++];i++}this.count=i,this.visible=this.count>0,this.instanceMatrix.needsUpdate=!0,this.stemVectorAttrib.needsUpdate=!0;for(const e of this.pinHeadMatrixAttrib)e.needsUpdate=!0;this.opacityAttrib.needsUpdate=!0,le.uniforms.resolution.value.set(t.width,t.height),le.uniformsNeedUpdate=!0}}const ce=new A.Z("InstancedPinRenderer");class InstancedPinRenderer extends PinRenderer{constructor(e,t,i,s,a,o,r,d){super(e,s,a,o),this.camera=t,this.canvasData=i,this.codepointMap=d,this.pins=new Map,this.idToPin=new Map,this.keyToRenderObjs=new Map,this.updatePinHeadMatrix=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3,s=new n.Vector3,a=new n.Vector3,o=new n.Vector3,r=new n.Vector3;return n=>{const d=j.Z.pinHeadMesh.scale,l=this.getViewportScale(this.canvasData),h=1+d.responsiveness/100*(l-1);this.camera.getWorldPosition(o);const c=this.camera.quaternion,m=this.canvasData;for(const l of n){r.copy(l.pinHeadObjPosition).add(l.anchorPosition);const n=o.distanceTo(r),u=d.maxSize-(d.maxSize-d.minSize)*(0,se.C)(n,d.nearBound,d.farBound);t.copy(r).project(this.camera),i.set(m.width/2,m.height/2,1).multiply(t),s.set(u/2,0,0).add(i),a.set(2/m.width,2/m.height,1).multiply(s);const g=a.unproject(this.camera).distanceTo(r)*h,p=(0,ae.uZ)(g,oe.Z.epsilon,g),v=l.geomScale||re.f.UNIT;e.set(p*v.x,p*v.y,p*v.z),l.pinHeadMatrix.compose(r,c,e)}}})(),this.inputCallbacks=r}dispose(){super.dispose()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(O.R,de.z,((e,t,i)=>{if(!i||void 0===i.instanceId)return!0;const n=t.renderedPins[i.instanceId];return this.inputCallbacks.onClick(n.id,n.pinType),!0}))),(0,r.Jm)()||(this.bindings.push(this.input.registerMeshHandler(q.z,E.s.isType(de.z),((e,t,i)=>{if(!i||void 0===i.instanceId)return;const n=t.renderedPins[i.instanceId];this.lastHoverId=n.id,this.lastHoverType=n.pinType,this.inputCallbacks.onHover(n.id,n.pinType)}))),this.bindings.push(this.input.registerMeshHandler(q.A,E.s.isType(de.z),(()=>{this.inputCallbacks.onUnhover(this.lastHoverId,this.lastHoverType)})))))}render(e){var t,i,n,s;for(const a of this.pins.values()){const o=Array.from(a.values());if(0===o.length)continue;const r=this.keyFromPin(o[0]),d=this.keyToRenderObjs.get(r);if(!d){ce.error("Expecting renderObjs for this key.",this.keyToRenderObjs,this.keyFromPin(o[0]));continue}let{lines:l,pinHeads:h}=d;if(o.forEach((t=>t.opacityAnimation.tick(e))),this.updatePinHeadMatrix(o),l.maxCount<o.length){const e=l.parent;if(!e){ce.error("Expecting a parent.");continue}e.remove(l),l.dispose(),e.remove(h),this.input.unregisterMesh(h);const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=o[0];h.dispose(),Object.assign(d,this.createInstances(e,d.id,o.length+16,t,i,n)),l=d.lines,h=d.pinHeads}l.update(o,this.canvasData),(null===(t=o[0].maskTexture)||void 0===t?void 0:t.uuid)&&(null===(s=null===(n=null===(i=h.material.uniforms)||void 0===i?void 0:i.mask)||void 0===n?void 0:n.value)||void 0===s?void 0:s.uuid)&&o[0].maskTexture.uuid!==h.material.uniforms.mask.value.uuid&&h.updateMaskTexture(o[0].maskTexture),h.update(o)}super.render(e)}updatePin(e,t,i,s,a,o){var r;super.updatePin(e,t,i,s,a,o);let d=this.idToPin.get(e);const l=i.floorId,h=this.getColor(i.color).baseColor,c=`${l}_${t}_${(null===(r=null==d?void 0:d.overrideTexture)||void 0===r?void 0:r.uuid)||s.uuid}`,m=(0,te.m)(t,i.icon,this.iconsEnabled),u=ne.f[m],g=this.codepointMap[+u],p=t===F.Er.OBJECT?0:.06;if(!d){d=Object.assign(Object.assign({id:e},i),{visible:!0,opacity:1,pinType:t,opacityAnimation:new ie.z(0),backgroundTexture:s,maskTexture:a,pinHeadMatrix:new n.Matrix4,pinHeadObjPosition:new n.Vector3,pinColor:h,colorVariant:F.K_.DEFAULT,overrideTexture:null,geomScale:null,pinIconUVOffset:g,pinStrokeWidth:p,needsEntryAnimation:!0}),this.idToPin.set(e,d);let o=this.pins.get(c);o||(o=new Map,this.pins.set(c,o)),o.set(e,d),this.createRenderObjsForPin(d)}const v=this.keyFromPin(d);Object.assign(d,i,{pinType:t,textureId:s.uuid,maskTexture:a}),this.changePinHeadGroupIfNeeded(v,c,d),d.pinHeadObjPosition.copy(d.stemNormal).setLength(d.stemLength),d.pinColor=(0,te.k)(this.getColor(d.color),d.colorVariant),d.pinIconUVOffset=g,d.pinStrokeWidth=p,void 0!==o&&this.setPinVisible(e,o),g&&d.needsEntryAnimation&&(d.opacityAnimation.modifyAnimation(d.opacityAnimation.value,1,500,X.ad),d.opacityAnimation.onComplete((()=>{d&&(d.needsEntryAnimation=!1)})))}removePin(e){super.removePin(e);const t=this.idToPin.get(e);if(!t)return;this.idToPin.delete(e);const i=this.keyFromPin(t),n=this.pins.get(i);n&&(n.delete(e),this.cleanupRenderObjIfNeeded(i))}removePinsByPredicate(e){this.idToPin.forEach(((t,i)=>{e(t.pinType)&&this.removePin(i)}))}setPinVisible(e,t){const i=this.idToPin.get(e);i?i.visible=t:ce.error("setPinVisible on a pin that doesn't exist.",e)}setPinColorVariant(e,t){const i=this.idToPin.get(e);i?(i.colorVariant=t,i.pinColor=(0,te.k)(this.getColor(i.color),t)):ce.error("setPinColorVariant on a pin that doesn't exist.")}setPinColorVariants(e,t){this.idToPin.forEach(((i,n)=>{n!==t&&this.setPinColorVariant(n,e)}))}setPinColorVariantByType(e,t,i){this.idToPin.forEach(((n,s)=>{n.pinType===e&&s!==i&&this.setPinColorVariant(s,t)}))}setPinOpacity(e,t){const i=this.idToPin.get(e);i?i.opacity=t:ce.error("setPinOpacity on a pin that doesn't exist.")}fadePinOpacity(e,t){const i=this.idToPin.get(e);i?(t>0&&this.setPinVisible(e,!0),i.opacityAnimation.modifyAnimation(i.opacityAnimation.value,t,300).onComplete((()=>{i.opacityAnimation.endValue<=0&&this.setPinVisible(e,!1)}))):ce.error("setPinVisible on a pin that doesn't exist.",e)}setPinOpacityByType(e,t,i){this.idToPin.forEach(((n,s)=>{n.pinType===e&&s!==i&&this.setPinOpacity(s,t)}))}fadePinOpacityByType(e,t,i=[]){this.idToPin.forEach(((n,s)=>{n.pinType!==e||i.includes(s)||this.fadePinOpacity(s,t)}))}setPinRenderOverrides(e,t,i){super.setPinRenderOverrides(e,t,i);const n=this.idToPin.get(e);if(!n)return void ce.error("setPinRenderOverrides on a pin that doesn't exist.");const s=this.keyFromPin(n);if(!this.keyToRenderObjs.get(s))return void ce.error("Expecting renderObjs while setting override material");n.overrideTexture=t,n.geomScale=i;const a=this.keyFromPin(n);this.changePinHeadGroupIfNeeded(s,a,n)}pinHeadTransform(e){const t=this.idToPin.get(e);return t?t.pinHeadMatrix:(ce.error("pinHeadTransform on a pin that doesn't exist."),new n.Matrix4)}keyFromPin(e){return`${e.floorId}_${e.pinType}_${e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid}`}createRenderObjsForPin(e){const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=e,s=this.keyFromPin(e);if(this.keyToRenderObjs.get(s))return;const a=this.getFloorContainer(e.floorId).userData.typeContainers[e.pinType];a.userData||(a.userData={});const o=e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid;if(!a.userData[o]){const e=this.createInstances(a,o,16,t,i,n);a.userData[o]=e,this.keyToRenderObjs.set(s,e)}}createInstances(e,t,i,n,s,a){const o=new InstancedPinLines(i);o.layers.mask=this.layer.mask,e.add(o);const r=new de.z(i,a||n,a?null:s,!a);return r.layers.mask=this.layer.mask,e.add(r),this.input.registerMesh(r,!1),{lines:o,pinHeads:r,id:t}}changePinHeadGroupIfNeeded(e,t,i){if(e!==t){let n=this.pins.get(t);n||(n=new Map,this.pins.set(t,n)),n.set(i.id,i),this.createRenderObjsForPin(i);const s=this.pins.get(e);s&&(null==s||s.delete(i.id),this.cleanupRenderObjIfNeeded(e))}}cleanupRenderObjIfNeeded(e){const t=this.pins.get(e),i=this.keyToRenderObjs.get(e);if(t&&0===t.size&&i){const t=i.lines.parent;if(this.input.unregisterMesh(i.pinHeads),this.pins.delete(e),this.keyToRenderObjs.delete(e),!t)return void ce.error("Expecting pinTypeObj!");t.userData[i.id]=void 0,t.remove(i.lines),t.remove(i.pinHeads)}}}var me=i(80742),ue=i(67557),ge=i(44148);const pe=Object.values(F.Qk),ve=e=>e.map((e=>String.fromCharCode(+ne.f[e]))),ye={fontPath:"fonts/mp-font.woff",fontWeight:700,fontFamily:"mp-font",fontStyle:"normal",fontSize:120,squareSize:128,width:4096,height:4096,transparent:!0,defaultCharset:ue.Tz.NONE,initialChars:ve(pe),outline:!1,outlineWidth:0,texturePadding:0};class PinsModule extends s.Y{constructor(){super(...arguments),this.name="pins",this.editActivated=!1,this.editBindings=[],this.touchDevice=(0,r.Jm)(),this.worldPosition=new n.Vector3,this.fontManager=ue.Qi.instance,this.visibilityChanged=()=>{const e=!this.in360View(),t=!this.interactionmodeData.isVR();this.pinRenderer.container.visible=e&&t;const{floorsViewData:i}=this,n=this.viewmode===p.Ey.Dollhouse||this.viewmode===p.Ey.Floorplan,s=i.transition.progress.active?()=>!0:i.isHidden;this.pinRenderer.setFloorsHidden(n?s:()=>!1)},this.viewmodeChanged=e=>{this.viewmode=e.toMode,this.visibilityChanged()},this.onEnablePinEditing=async e=>{e.enabled?this.enableEditing():this.disableEditing()},this.updateCurrentPin=()=>{const{pinEditorState:e,selectedPin:t,focusedPin:i}=this.viewData;if(e!==F.V8.CREATING){const e=i||t;if(this.pinEditor.updateAnchorMesh(),e){const{id:t,pinType:i,backgroundTexture:n}=e;this.pinRenderer.updatePin(t,i,e,n,this.iconMaskTexture),this.pinRenderer.setPinColorVariant(t,F.K_.HIGHLIGHTED),this.pinRenderer.setPinColorVariants(F.K_.DEFAULT,t)}else this.pinRenderer.setPinColorVariants(F.K_.DEFAULT)}},this.onUpdatePin=async e=>{const{id:t,pinType:i,properties:n}=e,s=this.viewData.getPin(t);if(s&&s.pinType===i){const{selectedPin:e,focusedPin:i}=this.viewData,a=Object.assign(Object.assign({},s),n);this.viewData.updatePin(a),this.pinRenderer.updatePin(a.id,a.pinType,a,a.backgroundTexture,this.iconMaskTexture),(null==e?void 0:e.id)===t&&(this.saveScreenPosition(a),this.viewData.updateSelectedPin(a)),(null==i?void 0:i.id)===t&&this.saveScreenPosition(a),a.icon&&this.addIconsToAtlas([a.icon])}else this.log.debug(`Cannot update non-existent ${i} pin`)},this.onUpdatePinViews=async e=>{const{pinViews:t}=e,{selectedPin:i}=this.viewData,n=[];t.forEach((e=>{this.viewData.updatePin(e),this.pinRenderer.updatePin(e.id,e.pinType,e,e.backgroundTexture,this.iconMaskTexture,e.visible),(null==i?void 0:i.id)===e.id&&this.viewData.updateSelectedPin(e),void 0!==e.opacity&&this.pinRenderer.setPinOpacity(e.id,e.opacity),void 0!==e.scale&&this.pinRenderer.setPinRenderOverrides(e.id,null,e.scale),e.icon&&n.push(e.icon)})),this.addIconsToAtlas(n)},this.addIconsToAtlas=(e=pe)=>{const t=ve(e);this.fontManager.getFont(this.fontId).addCharsIfNeeded(t.join(""))},this.refreshPins=()=>{this.viewData.iteratePins(((e,t)=>{this.pinRenderer.updatePin(e.id,e.pinType,e,e.backgroundTexture,this.iconMaskTexture)}))},this.onChangePinVisibility=async e=>{const{id:t,pinType:i,visible:n}=e,s=this.viewData.getPin(t);if(s&&s.pinType===i){this.pinRenderer.setPinVisible(t,n);const{selectedPin:e,focusedPin:i}=this.viewData;n||(null==e?void 0:e.id)!==t||this.changeSelectedPin(null),n||(null==i?void 0:i.id)!==t||this.viewData.setFocusedPin(null)}else this.log.debug(`Cannot change visibility of non-existent ${i} pin`)},this.onChangePinVisibilityByType=async e=>{const{pinType:t,visible:i}=e;this.pinRenderer.setPinTypeVisible(t,i)},this.onChangePinOpacity=async e=>{const{id:t,pinType:i,opacity:n}=e,s=this.viewData.getPin(t);s&&s.pinType===i?this.pinRenderer.setPinOpacity(t,n):this.log.debug(`Cannot change opacity of non-existent ${i} pin`)},this.onChangePinOpacityByType=async e=>{const{pinType:t,opacity:i,skipIds:n}=e;this.pinRenderer.fadePinOpacityByType(t,i,n)},this.onUnselectPin=async e=>{const{pinType:t,id:i}=e,{selectedPin:n}=this.viewData;(null==n?void 0:n.pinType)===t&&(null==n?void 0:n.id)===i&&this.changeSelectedPin(null)},this.onStartPinCreation=async e=>{const{id:t,pin:i,pinType:n,backgroundTexture:s}=e,a=this.viewData,o=Object.assign(Object.assign({id:t,pinType:n},i),{backgroundTexture:s});a.setEditablePin(!0),a.setPinEditorState(F.V8.CREATING),this.changeSelectedPin(o),this.pinEditor.startPinCreation()},this.saveScreenPosition=(()=>{const e=new n.Vector3;return t=>{const i=this.viewData;e.copy(t.stemNormal).setLength(t.stemLength),this.worldPosition.copy(t.anchorPosition).add(e);const n=(0,o.q9)(this.cameraData,this.worldPosition);i.setScreenPosition(n.ndcPosition.z>1?null:n.screenPosition)}})(),this.onCameraUpdate=()=>{const{creatingNewPin:e,focusedPin:t,selectedPin:i}=this.viewData;!e&&t?this.saveScreenPosition(t):i&&this.saveScreenPosition(i)},this.handleSweepChange=()=>this.handleSweepAndViewModeChange(),this.handleViewModeChange=()=>this.handleSweepAndViewModeChange(),this.cancelPinCreation=()=>{const{creatingNewPin:e,selectedPin:t}=this.viewData;e&&t&&(this.engine.broadcast(new $.hu(t.id,t.pinType)),this.removePin(t.id,t.pinType),this.resetEditingState())},this.resetEditingState=()=>{const e=this.viewData;e.setPinEditorState(F.V8.IDLE),e.setEditablePin(!1),e.setCanPlace(!0),e.setCanAdd(!this.in360View())},this.onPinPlacementCancelled=()=>{this.cancelPinCreation()},this.onCancelNewPin=async e=>{const{pinType:t,id:i}=e;this.removePin(i,t),this.resetEditingState()},this.handleRemovingPin=async e=>{const{pinType:t,id:i}=e;this.removePin(i,t)},this.handleRemovingPinsByType=async e=>{const{pinType:t}=e;if(t===F.Er.MATTERTAG&&!this.tagsEnabled)return;this.viewData.removePinsByType(t),this.pinRenderer.removePinsByType(t);const{selectedPin:i,focusedPin:n}=this.viewData;(null==i?void 0:i.pinType)===t&&this.changeSelectedPin(null),(null==n?void 0:n.pinType)===t&&this.viewData.setFocusedPin(null)},this.onPinClicked=e=>{const{pinType:t,id:i}=e;if(t===F.Er.MATTERTAG&&!this.tagsEnabled)return;const{selectedPin:n,creatingNewPin:s}=this.viewData,a=i===(null==n?void 0:n.id)&&t===(null==n?void 0:n.pinType);if(n&&a){if(s)return;this.changeSelectedPin(null)}else if(s)this.cancelPinCreation();else{if(!(i===(null==n?void 0:n.id)&&t===(null==n?void 0:n.pinType))){const e=this.viewData.getPin(i);e&&(this.changeSelectedPin(e),this.engine.broadcast(new $.Q4(i,t)))}}},this.onHoverChanged=e=>{const{pinType:t,id:i,hovering:n}=e;if(t===F.Er.MATTERTAG&&!this.tagsEnabled)return;const{creatingNewPin:s,focusedPin:a,selectedPin:o}=this.viewData;if(!s)if(n){if(o&&o.id===i&&o.pinType===t)return;const e=this.viewData.getPin(i);if(!e)return void this.log.debug("Cannot find pin to focus");this.saveScreenPosition(e),this.viewData.setFocusedPin(e),this.pinRenderer.setPinColorVariantByType(t,F.K_.DEFAULT,null==a?void 0:a.id),this.pinRenderer.setPinColorVariant(i,F.K_.HIGHLIGHTED)}else a&&(this.pinRenderer.setPinColorVariant(a.id,F.K_.DEFAULT),this.viewData.setFocusedPin(null))},this.onSelectPin=async e=>{const{id:t,pinType:i,editable:n}=e,s=this.viewData,{selectedPin:a,isPinEditable:o}=s;if(s.setPinEditorState(F.V8.IDLE),t===(null==a?void 0:a.id)&&n===o)return void this.log.debug("Pin is already selected");const r=this.viewData.getPin(t);r&&r.pinType===i?(s.setEditablePin(n),this.changeSelectedPin(r),s.setFocusedPin(null)):this.log.debug(`Cannot select ${i} pin`)},this.clickOffPin=async()=>{this.viewData.creatingNewPin||this.changeSelectedPin(null)},this.movePin=async e=>{const{selectedPin:t,isPinEditable:i}=this.viewData;i&&(t&&t.id===e.id?(this.viewData.updateSelectedPin(e.pos),this.engine.broadcast(new $.bV(t.id,t.pinType,e.pos,e.previousPos))):this.log.debug("Cannot move the pin, not open for edit"))},this.placePin=async e=>{const{selectedPin:t,isPinEditable:i,canPlace:n}=this.viewData;i&&(t&&n?(this.viewData.setPinEditorState(F.V8.PLACED),this.engine.broadcast(new $.b0(t.id,t.pinType,t))):(this.log.debug("Cannot place pin because there is no open pin"),this.cancelPinCreation()))}}async init(e,t){this.engine=t,this.tagsEnabled=e.newTagsEnabled;const[i,n,s,o,r,p]=await Promise.all([t.getModuleBySymbol(a.y.INPUT),t.getModuleBySymbol(a.y.WEBGL_RENDERER),t.market.waitForData(l.W),t.market.waitForData(d.pu),t.getModuleBySymbol(a.y.RAYCASTER),t.market.waitForData(me.R)]);this.input=i;const C={onClick:(e,i)=>{t.broadcast(new $.F7(e,i))},onHover:(e,i)=>{t.broadcast(new $.tP(e,!0,i)),t.commandBinder.issueCommand(new y.u(w.C.FINGER)),t.commandBinder.issueCommand(new v.y(!0))},onUnhover(e,i){t.broadcast(new $.tP(e,!1,i)),t.commandBinder.issueCommand(new y.u(null)),t.commandBinder.issueCommand(new v.y(!1))}},P=t.claimRenderLayer(this.name);this.defaultPinMaskTexture=(0,G.p)(ge),this.iconMaskTexture=this.defaultPinMaskTexture,this.fontId=this.fontManager.getFontId(ye);const{font:M,codepointMap:S}=this.fontManager.getFontAndCodepoints(this.fontId);M.textures[0]&&(this.iconMaskTexture=M.textures[0]),M.onChanged((()=>{const e=this.fontManager.getFontAndCodepoints(this.fontId);e.font.textures[0]&&(this.iconMaskTexture=e.font.textures[0]),this.pinRenderer.codepointMap=e.codepointMap,this.refreshPins()})),this.pinRenderer=n.supportsInstancing()?new InstancedPinRenderer(i,n.getCamera(),s,P,t.commandBinder,r,C,S):new NonInstancedPinRenderer(i,n.getCamera(),s,P,t.commandBinder,r,C,S),this.pinRenderer.iconsEnabled=e.tagIconsEnabled,n.getScene().add(this.pinRenderer.container),t.addComponent(this,this.pinRenderer),[this.floorsViewData,this.viewmodeData,this.interactionmodeData,this.sweepData,this.cameraData]=await Promise.all([t.market.waitForData(h.c),t.market.waitForData(g.O),t.market.waitForData(c.Z),t.market.waitForData(u.Z),t.market.waitForData(m.M)]),this.viewData=new D.B,this.pinEditor=new PinEditor(this.viewData,this.engine,this.input,this.pinRenderer),this.floorsViewData.iterate((e=>this.pinRenderer.getFloorContainer(e.id))),this.viewmode=this.viewmodeData.currentMode,this.bindings.push(t.commandBinder.addBinding(_.Ki,this.onEnablePinEditing),t.commandBinder.addBinding(_.Ar,this.onSelectPin),t.commandBinder.addBinding(_.RH,this.onUnselectPin),t.commandBinder.addBinding(_.yR,this.clickOffPin),t.commandBinder.addBinding(_.tE,this.onUpdatePin),t.commandBinder.addBinding(_.mE,this.onUpdatePinViews),t.commandBinder.addBinding(_.ik,this.onChangePinVisibility),t.commandBinder.addBinding(_.qN,this.onChangePinVisibilityByType),t.commandBinder.addBinding(_._Y,this.onChangePinOpacity),t.commandBinder.addBinding(_.kb,this.onChangePinOpacityByType),t.commandBinder.addBinding(_.fM,this.onStartPinCreation),t.commandBinder.addBinding(_.OL,this.handleRemovingPin),t.commandBinder.addBinding(_.zM,this.handleRemovingPinsByType),t.commandBinder.addBinding(_.I$,this.movePin),this.interactionmodeData.onChanged(this.visibilityChanged),this.floorsViewData.onChanged(this.visibilityChanged),this.viewmodeData.makeModeChangeSubscription(this.visibilityChanged),t.subscribe(b.Z,this.visibilityChanged),t.subscribe(T.a,this.viewmodeChanged),t.subscribe(f.Z,this.viewmodeChanged),t.subscribe($.F7,this.onPinClicked),this.viewData.onPinEditorStateChanged(this.updateCurrentPin),this.viewData.onSelectedPinChanged(this.updateCurrentPin),this.viewData.onFocusedPinChanged(this.updateCurrentPin),this.viewData.onPinEditableChanged(this.updateCurrentPin),this.cameraData.onChanged(this.onCameraUpdate),p.onPropertyChanged("currentViewId",this.resetEditingState)),this.touchDevice||this.bindings.push(t.subscribe($.tP,this.onHoverChanged));let A=o.application;this.bindings.push(o.onPropertyChanged("application",(e=>{e!==A&&(this.visibilityChanged(),this.viewData.creatingNewPin?this.cancelPinCreation():(this.changeSelectedPin(null),this.viewData.setFocusedPin(null),this.resetEditingState()),A=e)}))),this.visibilityChanged(),t.market.register(this,D.B,this.viewData)}dispose(e){this.disableEditing(),this.viewData.setPinEditorState(F.V8.IDLE),this.pinEditor.dispose(),this.pinRenderer.dispose(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.editBindings=[],super.dispose(e)}onUpdate(){this.editActivated&&this.pinEditor.update()}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}enableEditing(){if(!this.editActivated){if(this.editActivated=!0,this.pinEditor.toggleEditing(!0),0===this.editBindings.length){const e=this.engine,t=e.commandBinder;this.editBindings.push(t.addBinding(_.ip,this.placePin),t.addBinding(_.tT,this.onCancelNewPin),this.sweepData.makeSweepChangeSubscription(this.handleSweepChange),e.subscribe(f.Z,this.handleViewModeChange),e.subscribe($.pe,this.onPinPlacementCancelled))}else this.editBindings.forEach((e=>{e.renew()}));this.handleSweepAndViewModeChange()}}disableEditing(){this.editActivated&&(this.editActivated=!1,this.pinEditor.toggleEditing(!1),this.resetEditingState(),this.editBindings.forEach((e=>{e.cancel()})))}changeSelectedPin(e){const{selectedPin:t}=this.viewData;(null==e?void 0:e.id)!==(null==t?void 0:t.id)?(t&&(this.engine.broadcast(new $.WM(t.id,t.pinType)),this.pinRenderer.hideSelectedMesh()),e?(this.saveScreenPosition(e),this.viewData.setSelectedPin(e),this.pinRenderer.showSelectedMesh(e.pinType,e.id)):(this.viewData.setScreenPosition(null),this.viewData.setSelectedPin(null))):this.log.debug("Pin selection did not change")}handleSweepAndViewModeChange(){const e=this.viewData,t=!this.in360View();e.creatingNewPin&&!t?(this.cancelPinCreation(),this.resetEditingState()):e.setCanAdd(t)}removePin(e,t){if(t===F.Er.MATTERTAG&&!this.tagsEnabled)return;this.viewData.removePin(e),this.pinRenderer.removePin(e);const{selectedPin:i,focusedPin:n}=this.viewData;(null==i?void 0:i.id)===e&&(null==i?void 0:i.pinType)===t&&this.changeSelectedPin(null),(null==n?void 0:n.id)===e&&(null==n?void 0:n.pinType)===t&&this.viewData.setFocusedPin(null)}}const we=PinsModule},49657:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>PreRendererModule});var n,s=i(97542),a=i(57956),o=i(53954),r=i(46368),d=i(9699),l=i(39880);!function(e){e[e.None=0]="None",e[e.Queued=1]="Queued",e[e.Rendering=2]="Rendering",e[e.Rendered=3]="Rendered"}(n||(n={}));class PreRenderer{constructor(e){this.statusMap={},this.active=[],this.queued=[],this.panoRenderer=e,this.disablePreRendering()}init(){}dispose(){}activate(e){}deactivate(e){this.disablePreRendering()}enablePreRendering(){this.enabled=!0}disablePreRendering(){this.enabled=!1}render(){}beforeRender(){this.enabled&&this.processQueued()}tryPreRender(e){return this.getPreRenderState(e)===n.None&&(this.queued.push(e),this.statusMap[e]=n.Queued,!0)}getPreRenderState(e){const t=this.statusMap[e];return void 0!==t?t:n.None}processQueued(){let e=0;for(const t of Object.keys(this.statusMap))this.statusMap[t]===n.Rendering&&e++;if(0===e&&this.queued.length>0){const e=this.queued.shift();if(e){this.active.push(e),this.statusMap[e]=n.Rendering;this.panoRenderer.activateSweep(e).then((()=>{this.onRendered(e)}))}}}cleanup(e=[]){const t=(0,l.ow)(e),i=[];for(const e of this.queued)t[e]?i.push(e):this.statusMap[e]=n.None;this.queued.length=0,this.queued.push.apply(this.queued,i);const s=[];for(const e of this.active)t[e]?s.push(e):this.statusMap[e]=n.None;this.active.length=0,this.active.push.apply(this.active,s)}onRendered(e){this.statusMap[e]=n.Rendered}}var h=i(34029);class PreRendererModule extends s.Y{constructor(){super(...arguments),this.name="prerenderer-module",this.lastPrerendered=null}async init(e,t){if((await t.market.waitForData(h.e)).getOverrideParam("pre",!0)||e.preRenderTourPanos){this.sweepData=await t.market.waitForData(o.Z);const e=await t.getModuleBySymbol(a.y.SWEEP_PANO);this.panoRenderer=e.getRenderer(),this.preRenderer=new PreRenderer(this.panoRenderer),t.addComponent(this,this.preRenderer),this.bindings.push(t.subscribe(r.Z,(e=>{this.preRenderer.enablePreRendering(),this.lastPrerendered=null,e.sweepIds&&e.sweepIds.length>=3&&(this.lastPrerendered=e.sweepIds[2],this.preRenderer.tryPreRender(this.lastPrerendered)),this.cleanup(this.sweepData),this.currentRestrictedSweeps=e.sweepIds}))),this.bindings.push(t.subscribe(d.Z,(e=>{this.preRenderer.disablePreRendering(),this.cleanup(this.sweepData,!0),this.currentRestrictedSweeps=null})))}}getCurrentSweeps(){return this.currentRestrictedSweeps||[]}cleanup(e,t=!1){const i=[];e.transition.active?(e.transition.from&&i.push(e.transition.from),e.transition.to&&i.push(e.transition.to)):e.currentSweep&&i.push(e.currentSweep),this.lastPrerendered&&i.push(this.lastPrerendered),t&&this.panoRenderer.freeAllTextures(i),this.preRenderer.cleanup(i)}}},74642:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ScreenshotsModule});var n=i(97542),s=i(57956),a=i(5332),o=i(17878),r=i(31362),d=i(41603),l=i(68191),h=i(84428),c=i(41187),m=i(23254),u=i(41326),g=i(64918),p=i(95882);class ScreenshotsModule extends n.Y{constructor(){super(...arguments),this.name="screenshots-module",this.capturer=new ScreenCapturer}async init(e,t){this.engine=t,[this.settingsModule,this.canvas,this.renderer,this.renderToTexture]=await Promise.all([t.getModuleBySymbol(s.y.SETTINGS),t.market.waitForData(a.W),t.getModuleBySymbol(s.y.WEBGL_RENDERER),t.getModuleBySymbol(s.y.RENDER_TO_TEXTURE)]),this.settingsModule.registerButton("Debug","Take screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,o.o.ALL)})),this.settingsModule.registerButton("Debug","Take 4k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:2304,width:4096},`image_${e}.jpg`,o.o.ALL)})),this.settingsModule.registerButton("Debug","Take 8k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:4608,width:8192},`image_${e}.jpg`,o.o.ALL)})),this.settingsModule.registerButton("Debug","Take 16k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:9e3,width:16e3},`image_${e}.jpg`,o.o.ALL)})),this.settingsModule.registerButton("Debug","Take FB 3D screenshot",(async()=>{const e=Date.now(),t=this.engine.getRenderLayer("model-mesh"),i=this.engine.getRenderLayer("skybox"),n=t.clone();n.addLayers(i);const s=(await this.engine.market.waitForData(m.O)).currentMode;try{await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,n),await this.engine.commandBinder.issueCommand(new l.U(l.U.modes.Depth)),await this.engine.commandBinder.issueCommand(new u._i(u.BD.MESH,g.n.Instant)),await this.takeAndDownloadScreenshot({height:Math.floor(this.canvas.height/4),width:Math.floor(this.canvas.width/4)},`image_${e}_depth.jpg`,t)}catch(e){throw this.log.error("Could not take screenshot"),e}finally{await this.engine.commandBinder.issueCommand(new l.U(null)),await this.engine.commandBinder.issueCommand(new u._i(u.KP[s||p.Ey.Panorama]))}}))}async takeAndDownloadScreenshot(e,t,i){this.renderTarget||(this.renderTarget=await this.engine.commandBinder.issueCommandWhenBound(new c.oM));const n=await this.capturer.capture(i,e,this.renderer,this.renderToTexture,this.renderTarget);(0,r.Hx)((0,d.Xk)(n),t)}}class ScreenCapturer{constructor(){this.captureCamera=new h.Camera}async capture(e,t,i,n,s){const{camera:a,scene:o}=i.getScene();return a.getWorldPosition(this.captureCamera.position),a.getWorldQuaternion(this.captureCamera.quaternion),this.captureCamera.projectionMatrix.copy(a.projectionMatrix),this.captureCamera.layers.mask=e.mask,s.setSize(t.width,t.height),n.render(s.target,o,this.captureCamera),await(0,d.vP)(s)}}},56163:(e,t,i)=>{"use strict";i.d(t,{K:()=>SearchResultItem});var n=i(52528),s=i(71166),a=i(25823);const o=new n.v({});class SearchResultItem{constructor(e){this.enabled=!0,this.textParser=o,this.bindings=[],this.commandBinder=e}getGroupingId(e){switch(e){case a.l.TYPE:return this.typeId;case a.l.FLOOR:return this.floorId;case a.l.LAYER:return this.layerId}}onSelect(){this.commandBinder.issueCommand(new s.IL(this))}registerBindings(){}cancelBindings(){this.bindings.forEach((e=>e.cancel()))}}},21723:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>SnapshotsEditor});var n=i(97542),s=i(57956),a=i(53954),o=i(25985),r=i(95882),d=i(23254),l=i(41187),h=i(41603),c=i(27646),m=i(20387),u=i(71239),g=i(17878),p=i(76609),v=i(69505),y=i(50090),w=i(19663),b=i(60542);class CaptureSnapshotCommand extends w.m{constructor(e){super(),this.id="CAPTURE_SNAPSHOT",this.payload={maxSize:e.maxSize||p.SL.ULTRAHIGH,aspect:e.aspect||b.g$,category:e.category||y.i.USER,onProgress:e.onProgress,waitForUpload:void 0===e.waitForUpload||e.waitForUpload}}}class EquirectSnapshotCommand extends w.m{constructor(e){super(),this.id="EQUIRECTANGULAR_SNAPSHOT",this.payload={onProgress:e.onProgress,waitForUpload:void 0===e.waitForUpload||e.waitForUpload}}}var f=i(37082),T=i(42418),D=i(90304),C=i(67944),P=i(98010);class SnapshotErrorMessage extends P.v{constructor(e){super(),this.error=e}}var M=i(2224);class SnapshotCaptureError extends M.y{constructor(e,t="72002"){super(e),this.name="SnapshotCaptureError"}}class SnapshotUploadError extends M.y{constructor(e,t="73002"){super(e),this.name="SnapshotUploadError"}}var S,A=i(79727),E=i(63252),k=i(39880),I=i(12039),N=i(8728);!function(e){e.CAPTURING="capturing",e.UPLOADING="uploading",e.ERROR="error",e.DONE="done"}(S||(S={}));var O=i(58368),V=i(66917);const R=u.Xd.uploadIntervalDelay;class SnapshotsEditor extends n.Y{constructor(){super(...arguments),this.name="snapshots-editor"}async init(e,t){this.engine=t,[this.renderer,this.sweepTilingModule]=await Promise.all([t.getModuleBySymbol(s.y.WEBGL_RENDERER),t.getModuleBySymbol(s.y.SWEEP_PANO)]),[this.sweepData,this.viewmodeData,this.cameraData,this.floorsViewData]=await Promise.all([t.market.waitForData(a.Z),t.market.waitForData(d.O),t.market.waitForData(o.M),t.market.waitForData(A.c),t.market.waitForData(T.P)]),[this.snapshotTarget,this.snapshotOverlayTarget]=await Promise.all([t.commandBinder.issueCommandWhenBound(new l.oM),t.commandBinder.issueCommandWhenBound(new l.oM)]),this.bindings.push(t.commandBinder.addBinding(CaptureSnapshotCommand,(async e=>{const i=e.onProgress||(0,f.Y)(0);i.value=10,t.commandBinder.issueCommand(new I.ZK),t.commandBinder.issueCommand(new V.M);const n=await this.queryIdealResolution(e.maxSize,e.aspect);this.snapshotTarget.setSize(n.width,n.height),this.snapshotOverlayTarget.setSize(n.width,n.height),await this.fetchHighestAvailable(!1,e.maxSize,(e=>i.value=Math.max(10,e))),await(0,k.gw)(2*R),await this.takeScreenshot();const s=this.sweepData.getSweep(this.sweepData.currentSweep);this.viewmodeData.currentMode===r.Ey.Panorama&&await this.sweepTilingModule.resetSweep(s.id),t.commandBinder.issueCommand(new I.Lp),t.commandBinder.issueCommand(new V.I);let a=e.category;s&&(s.alignmentType===E.z9.UNALIGNED||s.placementType===E.hU.MANUAL)&&a===y.i.USER&&(a=y.i.UNALIGNED);const o=this.uploadAndAddSnapshot(a).then((e=>e&&e.sid)).catch((e=>{throw this.log.error(e),this.engine.broadcast(new SnapshotErrorMessage(e)),e}));return e.waitForUpload?o:null})));const i=D.f.FORWARD.clone(),n=D.f.FORWARD.clone();this.bindings.push(t.commandBinder.addBinding(EquirectSnapshotCommand,(async e=>{const s=e.onProgress||(0,f.Y)(0);s.value=10,t.commandBinder.issueCommand(new I.ZK),await(0,k.gw)(50);const a=this.queryIdealEqResolution();this.snapshotTarget.setSize(a.width,a.height);const o=this.sweepData.getSweep(this.sweepData.currentSweep);i.copy(D.f.FORWARD).applyQuaternion(o.rotation).setY(0),n.copy(D.f.FORWARD).applyQuaternion(this.cameraData.pose.rotation).setY(0);const r=(0,C.k2)(i,n)+Math.PI;await this.fetchHighestAvailable(!0,p.SL.ULTRAHIGH,(e=>s.value=Math.max(10,e))),await this.takeEquirectangular(r),await this.sweepTilingModule.resetSweep(o.id),t.commandBinder.issueCommand(new I.Lp);const d=(0,h.fY)(this.snapshotTarget.width,this.snapshotTarget.height,r,0),l=this.uploadAndAddSnapshot(y.i.PANORAMA,d).then((e=>e&&e.sid)).catch((e=>{throw this.log.error(e),this.engine.broadcast(new SnapshotErrorMessage(e)),e}));return e.waitForUpload?l:null})))}async uploadAndAddSnapshot(e,t){const i=this.createSnapshot(e);i.state=S.CAPTURING,i.imageBlob=(0,h.Xk)(await(0,h.vP)(this.snapshotTarget,t)),i.state=S.UPLOADING;try{return await this.engine.commandBinder.issueCommand(new O.nM(i))}catch(e){throw i.state=S.ERROR,this.log.error(e),new SnapshotUploadError(e)}}createSnapshot(e){const t=this.viewmodeData.isInside();let i=(0,k.DZ)(new Date);if(t){const e=this.sweepData.getSweep(this.sweepData.currentSweep).name;e&&(i=e)}const n=new N.a;return n.name=i,n.category=e,n.is360=t&&!this.sweepData.currentAlignedSweepObject,n.metadata={cameraMode:this.viewmodeData.currentMode,cameraPosition:this.cameraData.pose.position.clone(),cameraQuaternion:this.cameraData.pose.rotation.clone(),orthoZoom:this.viewmodeData.currentMode===r.Ey.Floorplan?this.cameraData.zoom():-1,ssZoom:this.cameraData.zoom(),scanId:t?this.sweepData.currentSweep:void 0,floorId:this.floorsViewData.currentFloorId,floorVisibility:this.floorsViewData.getFloorsVisibility()},n}async queryIdealResolution(e=p.SL.ULTRAHIGH,t){let i=3840,n=i*b.LP;const s=this.renderer.maxTextureSize;if(i>s&&(this.log.warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${s}`),i=s,n=i*b.LP),this.viewmodeData.currentMode===r.Ey.Panorama){const a=await this.sweepTilingModule.availableResolution(this.sweepData.currentSweepObject,e),o=c.Z.getPanoSize(a)*(this.cameraData.fovY()*v.MN)/90;i=Math.min(Math.round(o*t),s),n=Math.round(i/t)}return Promise.resolve({width:i,height:n})}queryIdealEqResolution(){let e=4096,t=.5*e;if(this.viewmodeData.currentMode!==r.Ey.Panorama)throw new SnapshotCaptureError("Equirectangular capture is only supported in Panorama mode");const i=this.renderer.maxTextureSize;return e>i&&this.log.warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${i}`),e=Math.min(i,e),t=.5*e,{width:e,height:t}}fetchHighestAvailable(e,t=p.SL.ULTRAHIGH,i){if(this.viewmodeData.currentMode===r.Ey.Panorama){const n=this.sweepData.currentSweepObject,s=e?m.v.FullPanorama:m.v.CurrentView;return this.sweepTilingModule.requestResolution(n,t,s,!0).then((e=>{const t=this.sweepTilingModule.waitForQueue(s,e);return i&&t.progress((e=>i(e*SnapshotsEditor.captureProgressFudgeFactor))),t.nativePromise()}))}return i&&i(SnapshotsEditor.captureProgressFudgeFactor),Promise.resolve()}takeScreenshot(){const e=g.o.ALL;e.removeLayers(this.engine.getRenderLayer("grid-underlay")),e.removeLayers(this.engine.getRenderLayer("cursor-mesh")),e.removeLayers(this.engine.getRenderLayer("current-pano-marker"));const t=this.renderer.getScene().scene,i=this.renderer.getScene().camera,n=i.layers.mask;return i.layers.mask=e.mask,this.engine.commandBinder.issueCommand(new l.vU(this.snapshotTarget,t,i)).then((()=>{i.layers.mask=n}))}takeEquirectangular(e){const t=this.sweepData.currentSweep,i=this.sweepTilingModule.getRenderer(),n=i.useTexture(t),s=this.engine.commandBinder.issueCommand(new l.fZ(this.snapshotTarget,n,e));return i.freeTexture(t),s}}SnapshotsEditor.captureProgressFudgeFactor=90},9699:(e,t,i)=>{"use strict";i.d(t,{Z:()=>RestrictedSweepsClearedMessge});var n=i(98010);class RestrictedSweepsClearedMessge extends n.v{constructor(){super()}}},46368:(e,t,i)=>{"use strict";i.d(t,{Z:()=>RestrictedSweepsSetMessge});var n=i(98010);class RestrictedSweepsSetMessge extends n.v{constructor(e){super(),this.sweepIds=e}}},65594:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>SweepPathModule});var n=i(84428),s=i(97542),a=i(53954),o=i(26306);const r=Object.freeze({sweeps:{maxNeighborDistance:50}});var d=i(46368),l=i(9699);class SweepPathModule extends s.Y{constructor(){super(...arguments),this.name="sweep-path"}async init(e,t){this.engine=t,this.sweepData=await t.market.waitForData(a.Z),this.validNeighbors={},this.maxNeighborDistance=e.maxNeighborDistance||r.sweeps.maxNeighborDistance,this.buildDistanceMap()}setRestrictedSweeps(e,t=0){if(this.restrictedSweeps=[],e){for(let i=t;i<e.length;i++)this.restrictedSweeps.push(e[i].id);this.engine.broadcast(new d.Z(this.restrictedSweeps))}else this.restrictedSweeps=void 0,this.engine.broadcast(new l.Z)}findShortestPath(e,t,i,n,s,a,r=5e3){const d=this.sweepData.getSweep(e),l=this.sweepData.getSweep(t),h=this,c=(0,o.K)({start:d,isEnd:e=>e===l,*neighbors(e){for(const t of e.neighbours)yield h.sweepData.getSweep(t)},distance:(e,t)=>h.getDistance(e.id,t.id),heuristic:(e,t)=>1,timeout:r});return c.status===o.h.Success&&c.path.length<s?(this.addSweepsNearPath(c.path,i),this.filterCloseSweepsFromPath(c.path,n)):null}addSweepsNearPath(e,t){const i=new n.Vector3,s=new n.Vector3,a=new n.Vector3,o=new n.Vector3,r=new n.Vector3,d=new n.Vector3,l=[],h=new n.Vector3,c=(e,t,i)=>(a.copy(t).sub(e),a.dot(i)),m=(e,t)=>c(h,e.position,i)-c(h,t.position,i);let u=0;for(;u<e.length-1;){const n=e[u].id,c=e[u+1].id,g=this.sweepData.getSweep(n),p=this.sweepData.getSweep(c);h.copy(g.position),l.length=0,i.copy(p.position).sub(h).normalize();const v=this.findConnectedSweeps(g,this.maxNeighborDistance),y=this.findConnectedSweeps(p,this.maxNeighborDistance),w=v.concat(y);for(const e of w){const n=a.copy(e.position).sub(h).dot(i);if(n>0){r.copy(i),r.multiplyScalar(n),o.copy(a),o.sub(r);if(o.length()<t){s.copy(i).negate(),d.copy(e.position).sub(p.position);d.dot(s)>0&&l.push(e)}}}if(l.length>0){l.sort(m);for(let t=e.length+l.length-1;t>=u+l.length;t--)e[t]=e[t-l.length];for(let t=0;t<l.length;t++)e[t+u+1]=l[t]}u+=l.length+1}}findConnectedSweeps(e,t,i=2){const n=[];return this._findConnectedSweeps(e,e,t,n,{},i,0),n}_findConnectedSweeps(e,t,i,n,s,a,o){const r=this.getValidNeighbors(e.id);for(const e of r)if(!s[e.id]){e.position.distanceTo(t.position)<i&&(n.push(e),s[e.id]=!0,o<a&&this._findConnectedSweeps(e,t,i,n,s,a,o+1))}}getValidNeighbors(e,t){let i=this.validNeighbors[e];if(!i){i=[],this.validNeighbors[e]=i;const n=this.sweepData.getSweep(e),s=n.neighbours;for(const a of s){const s=this.sweepData.getSweep(a),o=this.getDistance(e,a);if(!s.enabled)continue;if(o>this.maxNeighborDistance)continue;let r=!0;if(t){const e=s.position.clone().sub(n.position).normalize();r=0===t(n.position,e,o).length}r&&i.push(s)}}return i}filterCloseSweepsFromPath(e,t){const i=[];let n=null,s=!1;for(const a of e)s=n&&a.position.distanceTo(n.position)<t||!1,n&&s||(i.push(a),n=a);return i.length<2?e:(s&&e.length>1&&(i[i.length-1]=e[e.length-1]),i)}getCurveForPath(e){let t=0;const i=[0];for(let n=1;n<e.length;n++)t+=e[n-1].distanceTo(e[n]),i.push(t);const s=[0];for(let n=1;n<e.length;n++)s.push(i[n]/t);const a=new n.CatmullRomCurve3(e,!1);return{curve:new n.CatmullRomCurve3(a.getSpacedPoints(2*t).concat(e[e.length-1])),totalLength:t,sourceDistances:i,normalSourceDistances:s}}buildDistanceMap(){const e={},t=new n.Vector3(0,0,0);this.sweepData.iterate((i=>{const n={},s=i.neighbours;for(const e of s){const s=this.sweepData.getSweep(e);t.copy(i.position).sub(s.position);let a,o=Math.max(0,Math.abs(t.y)-.2),r=Math.sqrt(t.x*t.x+t.z*t.z);o>0?(o=Math.pow(4*o,2),r=Math.pow(r,2),a=Math.sqrt(o*o+r*r)):a=t.length(),n[s.id]=a}e[i.id]=n})),this.distanceMap=e}getDistance(e,t){return this.distanceMap[e][t]}}},46857:(e,t,i)=>{"use strict";i.d(t,{m1:()=>PinCollider,Vp:()=>PinMesh});var n=i(84428),s=i(77256),a=i.n(s),o=i(62118),r=i.n(o);class PinMaterial extends n.RawShaderMaterial{constructor(e,t){const i=n.UniformsUtils.clone(PinMaterial.uniforms);i.tMask.value=e,i.tPinHole.value=t,super({vertexShader:a(),fragmentShader:r(),uniforms:i,name:"PinMaterial",transparent:!0})}}PinMaterial.uniforms={tMask:{type:"t",value:null},tPinHole:{type:"t",value:null},pinColor:{type:"c",value:new n.Color},opacity:{type:"f",value:1}};var d=i(87926),l=i(49827),h=i(12529),c=i(15462),m=i(87928),u=i(48072);class PinCollider extends n.Mesh{}let g;const p=()=>g||(g=(0,d.p)(u),g);class PinMesh extends m.E{constructor(e,t,i,n){const s=new PinMaterial(p(),t);super(PinMesh.geometry,s),this.layers.mask=n.mask,this.name="PinMesh",this.cameraData=i,this._collider=new PinCollider(PinMesh.colliderGeometry,PinMesh.colliderMaterial),this._collider.name="PinMeshCollider",this._collider.material.visible=!1,this.add(this._collider),this.opacityProgress=0,this.shouldHide=!0,this.uniforms=s.uniforms,this.unhover(),this.selected=0,this.visible=!1,this.position.copy(e),this.renderOrder=h.z.pins360}updatePosition(e){this.position.copy(e)}get collider(){return this._collider}render(e){this.quaternion.copy(this.cameraData.pose.rotation),null===this.uniforms.tPinHole.value?this.opacityProgress=0:!this.shouldHide&&this.opacityProgress<1?this.opacityProgress+=e/PinMesh.FADE_DURATION:this.shouldHide&&this.opacityProgress>0&&(this.opacityProgress-=e/PinMesh.FADE_DURATION),this.opacityProgress=(0,l.uZ)(this.opacityProgress,0,1),this.uniforms.opacity.value=this.opacityProgress,this.visible=0!==this.opacityProgress}activate(){this.shouldHide=!1}deactivate(){this.shouldHide=!0}dispose(){this.collider.geometry.dispose(),this.collider.material.dispose()}setPinHover(e,t=!0,i=!0){const n=Math.min(Math.max(e,0),1);this.selected!==n&&(i&&this.uniforms.pinColor.value.copy(c.I.WHITE).lerp(c.I.MP_BRAND,n),t&&n>0&&n<=1&&(this.material.depthTest=!1),0===n&&(this.material.depthTest=!0),this.selected=n)}unhover(){this.uniforms.pinColor.value.copy(c.I.WHITE)}}PinMesh.FADE_DURATION=500,PinMesh.geometry=new n.PlaneGeometry(1.5,1.5),PinMesh.colliderGeometry=new n.SphereGeometry(1.5*.65),PinMesh.colliderMaterial=new n.MeshBasicMaterial({transparent:!0,opacity:.5,depthWrite:!1,color:16724312})},3054:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>SweepPinMesh});var n=i(97542),s=i(57956),a=i(84428),o=i(46857),r=i(98010);class PinSelectMessage extends r.v{constructor(e,t){super(),this.sweepId=e,this.selected=t}}class PinPlacementMessage extends r.v{constructor(e,t,i){super(),this.sweepId=e,this.pinIndex=t,this.placed=i}}var d=i(63252),l=i(76609),h=i(98169),c=i(23612),m=i(97998),u=i(35826),g=i(72996);const p=new m.Z("pin-mesh");class PinMeshRenderer{constructor(e,t,i,n,s,o){this.sweepViewData=e,this.scene=t,this.sweepTextureLoader=i,this.input=n,this.layer=o,this.container=new a.Object3D,this.bindings=[],this.visibilityFilter=()=>!0,this.updatePlacementType=(e,t)=>{this.dataToMeshMap[e.id]||e.placementType!==d.hU.MANUAL?this.dataToMeshMap[e.id]&&e.placementType!==d.hU.MANUAL&&(this.removePinMesh(e),this.engine.broadcast(new PinPlacementMessage(e.id,t,!1))):(this.createPinMesh(e,this.cameraData),this.engine.broadcast(new PinPlacementMessage(e.id,t,!0)))},this.hoverSweep=(e,t)=>{this.issueCommand(new u.kR(e,t,0));const i=this.sweepViewData.selectedSweep===e;this.highlightPin(e,t||i)},this.meshes=[],this.meshToDataMap={},this.dataToMeshMap={},this.cameraData=s,e.iterate((t=>{t.alignmentType!==d.z9.ALIGNED&&(t.placementType===d.hU.MANUAL&&this.createPinMesh(t,s),this.bindings.push(t.onChanged((()=>{const i=e.getIndexByAlignment(!1,t.id);this.updatePlacementType(t,i),h.H7(t)&&this.updatePinMeshPosition(t.id,t.position)}))))}))}updatePinMeshPosition(e,t){this.mapSweepToMesh(e).updatePosition(t)}mapSweepToMesh(e){return this.dataToMeshMap[e]}mapColliderToSweep(e){const t=e.hasOwnProperty("collider")?e:e.parent;if(t){const e=this.meshToDataMap[t.id];if(e)return e.sweep}return null}filter(e){this.visibilityFilter=e;for(const e of this.meshes)this.filterMesh(e)}init(){}dispose(){for(const e in this.meshToDataMap){const t=this.meshToDataMap[e];this.removePinMesh(t.sweep)}}render(e){for(const t of this.meshes)t.render(e)}activate(e){this.engine=e,this.issueCommand=e.commandBinder.issueCommand.bind(e.commandBinder),this.bindings.push(this.input.registerMeshHandler(c.z,g.s.isType(o.m1),((e,t)=>this.onHoverEvent(t,!0)))),this.bindings.push(this.input.registerMeshHandler(c.A,g.s.isType(o.m1),((e,t)=>this.onHoverEvent(t,!1)))),this.scene.add(this.container)}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}getMeshes(){return this.meshToDataMap}highlightPin(e,t){this.dataToMeshMap[e]&&this.dataToMeshMap[e].setPinHover(t?1:0,!1)}lockSelection(e,t){return t&&(this.engine.broadcast(new PinSelectMessage(e.id,!0)),this.hoverSweep(e.id,!0)),!0}createPinMesh(e,t){const i=new o.Vp(e.position,null,t,this.layer);this.meshes.push(i),this.dataToMeshMap[e.id]=i,this.meshToDataMap[i.id]={id:i.id,sweep:e},this.container.add(i),this.filterMesh(i),this.sweepTextureLoader.loadFace(e,l.SL.BASE,1,{flipY:!0}).then((e=>{i.material.uniforms.tPinHole.value=e})).catch((t=>{p.error(`${e.id} failed to load texture: ${t}`)}))}removePinMesh(e){const t=this.dataToMeshMap[e.id],i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),this.container.remove(t),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.id],t.dispose()}filterMesh(e){const t=this.meshToDataMap[e.id];if(t){const i=t.sweep;this.visibilityFilter(i)?this.activateMesh(e):this.deactivateMesh(e)}}onHoverEvent(e,t){const i=this.mapColliderToSweep(e);i&&this.hoverSweep(i.id,t)}activateMesh(e){this.input.registerMesh(e.collider,!1),e.activate()}deactivateMesh(e){this.input.unregisterMesh(e.collider);const t=this.meshToDataMap[e.id];t&&(this.hoverSweep(t.sweep.id,!1),e.deactivate())}}PinMeshRenderer.MENU_CLEAR_DEBOUNCE=100;var v=i(66777),y=i(19663);class PinUnselectCommand extends y.m{constructor(e){super(),this.id="PIN_UNSELECT",this.payload={id:e}}}var w=i(54244),b=i(25985),f=i(23254),T=i(34029),D=i(95882),C=i(79727),P=i(21973),M=i(71161),S=i(56159);class SweepStartedRotatingMessage extends r.v{constructor(e){super(),this.sweepId=e}}class SweepFinishedRotatingMessage extends r.v{constructor(e){super(),this.sweepId=e}}var A=i(43736);class SweepPinMesh extends n.Y{constructor(){super(...arguments),this.name="sweep-pin-mesh",this.onChange=()=>{const e=this.sweepViewData,t=e.selectedSweep,i=e.toolState===M._.ROTATING||e.toolState===M._.ROTATED;this.pinRenderer.filter((e=>{if(!this.settingsData.tryGetProperty(A.s,!0))return!1;if(i&&t===e.id)return!1;if(this.viewmodeData.transition.active&&(0,D.Bw)(this.viewmodeData.transition.to))return!1;const n=!this.nextFloor||this.nextFloor===e.floorId||!e.floorId,s=this.config.showPinsInFloorplanDollhouse||this.applicationData.application===w.Mx.WORKSHOP,a=this.viewmodeData.closestMode===D.Ey.Dollhouse||this.viewmodeData.closestMode===D.Ey.Floorplan;return n&&a&&s}))},this.onSelectedPinChange=()=>{const e=this.sweepViewData.selectedSweep;e&&(this.engine.commandBinder.issueCommand(new u.iF(e,!0,0)),this.pinRenderer.highlightPin(e,!0))}}async init(e,t){var i;[this.model,this.webglRenderer,this.input,this.sweepViewData,this.cameraData,this.settingsData,this.viewmodeData,this.floorsViewData,this.applicationData]=await Promise.all([t.getModuleBySymbol(s.y.MODEL_DATA),t.getModuleBySymbol(s.y.WEBGL_RENDERER),t.getModuleBySymbol(s.y.INPUT),t.market.waitForData(P.D),t.market.waitForData(b.M),t.market.waitForData(T.e),t.market.waitForData(f.O),t.market.waitForData(C.c),t.market.waitForData(w.pu)]);const n=t.claimRenderLayer(this.name),a=this.webglRenderer.getScene().scene;this.config={showPinsInFloorplanDollhouse:null===(i=e&&e.showPinsInFloorplanDollhouse)||void 0===i||i},this.engine=t;const o=new v.Z(this.model.getSignedUrls());this.pinRenderer=new PinMeshRenderer(this.sweepViewData,a,o,this.input,this.cameraData,n),t.addComponent(this,this.pinRenderer),this.bindings.push(this.applicationData.onPropertyChanged("application",this.onChange),this.settingsData.onPropertyChanged(A.s,this.onChange),this.viewmodeData.onChanged(this.onChange),this.sweepViewData.onSelectedSweepChanged(this.onSelectedPinChange),t.subscribe(S.S,(e=>{this.nextFloor=e.to,this.onChange()})),t.subscribe(SweepStartedRotatingMessage,this.onChange),t.subscribe(SweepFinishedRotatingMessage,this.onChange),t.commandBinder.addBinding(PinUnselectCommand,(async e=>{this.pinRenderer.highlightPin(e.id,!1)}))),this.nextFloor=this.floorsViewData.currentFloorId,this.onChange()}mapColliderToSweep(e){return this.pinRenderer.mapColliderToSweep(e)}selectPinMesh(e,t){return this.pinRenderer.lockSelection(e,t)}highlightPinMesh(e,t){this.pinRenderer.highlightPin(e,t)}mapSweepToMesh(e){return this.pinRenderer.mapSweepToMesh(e)}updatePosition(e,t){this.pinRenderer.updatePinMeshPosition(e,t)}}},39531:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>SweepPinNavigation});var n=i(97542),s=i(57956),a=i(46857),o=i(38987),r=i(34956),d=i(95882),l=i(64918),h=i(23254),c=i(84428),m=i(86819),u=i(23612),g=i(72996);class SweepPinNavigation extends n.Y{constructor(){super(...arguments),this.name="sweep-pin-navigation"}async init(e,t){const[i,n,p,v]=await Promise.all([t.getModuleBySymbol(s.y.SWEEP_PIN),t.getModuleBySymbol(s.y.VIEWMODE),t.market.waitForData(h.O),t.getModuleBySymbol(s.y.INPUT)]),y=new c.Quaternion;this.bindings.push(v.registerMeshHandler(m.R,g.s.isType(a.m1),((e,t,s)=>{const a=i.mapColliderToSweep(t);return!(!a||p.transition.active)&&(y.set(0,0,0,1).multiply(a.rotation),o=a.id,r=y,p.currentMode&&p.currentMode!==d.Ey.Panorama&&n.switchToMode(d.Ey.Panorama,l.n.FadeToBlack,{sweepID:o,rotation:r}),!0);var o,r})),v.registerMeshHandler(u.z,g.s.isType(a.m1),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.u(r.C.FINGER))})),v.registerMeshHandler(u.A,g.s.isType(a.m1),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.u(null))})))}}},8513:(e,t,i)=>{"use strict";i.d(t,{p:()=>PortalPuckMesh,Y:()=>p});var n=i(84428),s=i(35490),a=i.n(s),o=i(8346),r=i.n(o);class PortalMaterial extends n.RawShaderMaterial{constructor(e,t){const i=n.UniformsUtils.clone(PortalMaterial.uniforms);i.tNoHover.value=e,i.tHover.value=t,i.tPortal.value=null,super({vertexShader:a(),fragmentShader:r(),uniforms:i,name:"PortalMaterial",transparent:!0})}}PortalMaterial.uniforms={tNoHover:{type:"t",value:null},tHover:{type:"t",value:null},tPortal:{type:"t",vlaue:null},progress:{type:"f",value:1},opacity:{type:"f",value:1}};var d=i(87926),l=i(68444),h=i(85089),c=i(45545),m=i(64293);let u;const g={get:()=>u||(u={toExteriorTexture:(0,d.p)(l),toExteriorHoverTexture:(0,d.p)(h),toInteriorTexture:(0,d.p)(c),toInteriorHoverTexture:(0,d.p)(m)},u)};var p,v=i(49827),y=i(12529),w=i(23331);!function(e){e[e.HIDE=0]="HIDE",e[e.SHOW=1]="SHOW",e[e.ONTOP=2]="ONTOP"}(p||(p={}));class PortalPuckMesh extends n.Mesh{constructor(e,t){const i=new PortalMaterial(g.get().toInteriorTexture,g.get().toInteriorHoverTexture);super(PortalPuckMesh.geometry,i),this.layers.mask=t.mask,this.uniforms=i.uniforms,this.renderOrder=y.z.portals,this.setState(p.HIDE),this.update(e)}update(e){if(this.portalData=e,this.position.copy(e.position),null!==e.lookDirection){const t=e.lookDirection.clone().add(e.position);this.lookAt(t)}this.hoverProgress=0,this.hovered=!1,e.toExterior?(this.uniforms.tNoHover.value=g.get().toExteriorTexture,this.uniforms.tHover.value=g.get().toExteriorHoverTexture):(this.uniforms.tNoHover.value=g.get().toInteriorTexture,this.uniforms.tHover.value=g.get().toInteriorHoverTexture)}resetMesh(e=0,t=!1,i=!1){this.uniforms.opacity.value=e,this.visible=0!==e,this.material.depthTest=t,this.material.depthWrite=i}setHover(e){this.hovered=e}setState(e){switch(e){case p.HIDE:this.resetMesh(0,!0,!0);break;case p.SHOW:this.resetMesh(1,!0,!0);break;case p.ONTOP:this.resetMesh(1)}}render(e,t){var i;if(this.hovered&&this.hoverProgress<1?this.hoverProgress+=e/300:!this.hovered&&this.hoverProgress>0&&(this.hoverProgress-=e/300),this.hoverProgress=(0,v.uZ)(this.hoverProgress,0,1),this.uniforms.progress.value=this.hoverProgress,null===(i=this.portalData)||void 0===i?void 0:i.billboard){const e=t.pose.position,i=this.position.copy(this.portalData.position),n=e.distanceTo(i);n<w.nm?i.lerpVectors(e,i,w.nm/n):n>w.iz&&i.lerpVectors(e,i,w.iz/n),this.lookAt(t.pose.position)}}updatePortalTexture(e){this.uniforms.tPortal.value=e}raycast(e,t){if(!this.visible)return;const i=[];super.raycast(e,i),i.length>0&&(i[0].distance/=1e4,t.push(i[0]))}}PortalPuckMesh.geometry=new n.PlaneGeometry(w.vX,w.vX)},9162:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>PortalPuckMeshModule});var n=i(97542),s=i(57956),a=i(76609),o=i(84428),r=i(29837),d=i.n(r),l=i(45405),h=i.n(l);class PortalViewportMaterial extends o.RawShaderMaterial{constructor(){const e=o.UniformsUtils.clone(PortalViewportMaterial.uniforms);super({vertexShader:d(),fragmentShader:h(),uniforms:e,name:"PortalViewportMaterial",side:o.BackSide})}updateTexture(e){this.uniforms.tMap.value=e}}PortalViewportMaterial.uniforms={tMap:{type:"t",value:null}};class PortalViewportLoader{constructor(e,t,i,n){this.tempLookDirection=new o.Vector3,this.worldCamera=n,this.camera=new o.Camera,this.renderSize=i,this.sweepTextureLoader=e,this.textureRenderer=t,this.renderTargets={},this.renderCube=new o.Mesh(new o.BoxGeometry(4,4,4),new PortalViewportMaterial)}async getPortalTexture(e,t,i){const n=this.renderTargets[e.id]||this.textureRenderer.createRenderTarget2D(this.renderSize,this.renderSize),s=await this.sweepTextureLoader.load(e,a.SL.BASE);return this.renderCube.material.updateTexture(s),this.renderCube.quaternion.copy(t),this.camera.projectionMatrix.copy(this.worldCamera.projectionMatrix),this.worldCamera.getWorldPosition(this.tempLookDirection),this.camera.lookAt(this.tempLookDirection.sub(i).negate()),this.textureRenderer.render(n,this.renderCube,this.camera),n.texture}releasePortalTexture(e){const t=this.renderTargets[e];t&&this.textureRenderer.disposeRenderTarget2D(t)}}var c=i(8513),m=i(70903),u=i(23612),g=i(86819),p=i(72996),v=i(48476);class PortalPuckRenderer{constructor(e,t,i,n,s){this.container=new o.Object3D,this.bindings=[],this.visibilityFilter=e=>c.Y.HIDE,this.scene=e,this.input=t,this.layer=n,this.cameraData=s,this.viewportLoader=i,this.meshes=[],this.activeMeshes={},this.meshToDataMap={},this.dataToMeshMap={},this.activeTexturePromises={},this.meshPool=new m.L}addPortal(e){let t;const i=this.meshPool.get();i?(t=i.object,t.update(e)):t=this.meshPool.add(new c.p(e,this.layer)).object,this.meshes.push(t),this.container.add(t),this.meshToDataMap[t.id]=e,this.dataToMeshMap[e.index]=t,this.activateMesh(t,this.visibilityFilter(e))}removePortal(e){const t=this.dataToMeshMap[e.index];if(t){this.meshPool.free(t);const i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),this.container.remove(t),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.index]}}init(){}activate(e){this.broadcast=e.broadcast.bind(e),this.bindings.push(this.input.registerMeshHandler(u.z,p.s.isType(c.p),((e,t)=>{this.onPuckSelect(t)}))),this.bindings.push(this.input.registerMeshHandler(u.A,p.s.isType(c.p),((e,t)=>{this.onPuckDeselect(t)}))),this.bindings.push(this.input.registerMeshHandler(g.R,p.s.isType(c.p),((e,t)=>{this.onPuckClick(t)}))),this.scene.add(this.container)}dispose(){for(const e of Object.keys(this.meshToDataMap)){const t=this.meshToDataMap[e],i=this.dataToMeshMap[t.index];this.removePortal(t),i.material.dispose(),i.geometry.dispose()}}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}render(e){for(const t of this.meshes)t.render(e,this.cameraData)}filter(e){this.visibilityFilter=e;for(const t of this.meshes){const i=e(this.meshToDataMap[t.id]);i===c.Y.HIDE?this.deactivateMesh(t):this.activateMesh(t,i)}}mapSweepToMesh(e){for(const t in this.meshToDataMap){const i=this.meshToDataMap[t];if(i.toSweep.id===e&&i.toExterior&&i.fromInterior)return this.dataToMeshMap[i.index]}return null}activateMesh(e,t=0){this.activeMeshes[e.id]||(this.input.registerMesh(e,!1),this.activeMeshes[e.id]=!0),e.setState(t)}deactivateMesh(e){this.input.unregisterMesh(e),this.activeMeshes[e.id]=!1,this.onPuckDeselect(e),e.setState(c.Y.HIDE)}onPuckClick(e){this.broadcast(new v.K(this.meshToDataMap[e.id]))}onPuckSelect(e){this.broadcast(new v.x(!0));const t=this.meshToDataMap[e.id].toSweep,i=this.viewportLoader.getPortalTexture(t,t.rotation,e.position);this.activeTexturePromises[e.id]=i,i.then((t=>{this.activeTexturePromises.hasOwnProperty(e.id)&&i===this.activeTexturePromises[e.id]&&(e.updatePortalTexture(t),e.setHover(!0))}))}onPuckDeselect(e){this.broadcast(new v.x(!1)),e.setHover(!1),this.viewportLoader.releasePortalTexture(this.meshToDataMap[e.id].toSweep.id),delete this.activeTexturePromises[e.id]}}var y=i(23331),w=i(16769),b=i(53954),f=i(25985),T=i(63252),D=i(66777),C=i(98169),P=i(81248);class PortalPuckMeshModule extends n.Y{constructor(){super(...arguments),this.name="sweep-portal-mesh",this.portalCount=0}async init(e,t){const[i,n,a,o,r,d,l]=await Promise.all([t.getModuleBySymbol(s.y.MODEL_DATA),t.getModuleBySymbol(s.y.RAYCASTER),t.getModuleBySymbol(s.y.INPUT),t.getModuleBySymbol(s.y.RENDER_TO_TEXTURE),t.getModuleBySymbol(s.y.WEBGL_RENDERER),t.market.waitForData(b.Z),t.market.waitForData(f.M)]),h=t.claimRenderLayer(this.name);this.portalData={};const c=r.getScene().camera,m=new D.Z(i.getSignedUrls());this.raycaster=n;const u=new PortalViewportLoader(m,o,256,c),g=r.getScene().scene;this.portalRenderer=new PortalPuckRenderer(g,a,u,h,l),await Promise.all([t.getModuleBySymbol(s.y.MESH_API_FIXUP)]);const p=T.hU.MANUAL,v=d.filter((e=>C.H7(e)));d.iterate((e=>{this.portalData[e.id]||(this.portalData[e.id]=[]),C.H7(e)&&this.addPortals(e,this.portalRenderer,d,v);let t=e.placementType;this.bindings.push(e.onPropertyChanged("placementType",(i=>{t!==p&&i===p&&this.addPortals(e,this.portalRenderer,d,v),t===p&&i!==p&&this.removePortals(e.id,this.portalRenderer),t=i}))),this.bindings.push(e.onChanged((()=>{C.H7(e)&&(this.removePortals(e.id,this.portalRenderer),this.addPortals(e,this.portalRenderer,d,v))})))})),t.addComponent(this,this.portalRenderer)}filter(e){this.portalRenderer.filter(e)}getPortalToExterior(e){return this.portalRenderer.mapSweepToMesh(e)}removePortals(e,t){for(const i of this.portalData[e])t.removePortal(i);this.portalData[e]=[]}addPortals(e,t,i,n){const s=this.nearestAlignedSweep(e,i);if(s){const i=this.entryLinks(e,s),a=this.neighborLinks(e,n);this.portalData[e.id]=i.concat(a);for(const i of this.portalData[e.id])t.addPortal(i)}else this.log.debug(`Couldn't find the nearest sweep for a 360 on floor ${e.floorId}; not adding portals`)}nearestAlignedSweep(e,t){const i=[C.ff(e),C._k(),C._T(),C.b1(e)],n=[P.TE(e.position)],s=t.sortByScore(i,n)[0];return s?s.sweep:null}modelIntersection(e,t,i=1/0){const n=(new o.Vector3).copy(e.position).sub(t.position).setY(0).normalize(),s=this.raycaster.picking.pick(t.position,n,w.T0);return{intersect:s&&s.distance<=i?s:null,rayDirection:n}}entryLinks(e,t){const i=[],n=e.position.distanceTo(t.position),s=this.modelIntersection(e,t,n+y.vX);let a,r,d=!1;s.intersect&&s.intersect.face?(a=s.intersect.face.normal.clone().setY(0).normalize(),Math.abs(s.rayDirection.dot(a))<.3&&a.copy(s.rayDirection).multiplyScalar(-1),r=s.intersect.point.clone().addScaledVector(a,y.AF)):(a=null,d=!0,r=e.position.clone()),r.y=t.position.y,i.push({index:this.portalCount++,toSweep:e,fromSweep:t,position:r,lookDirection:a,billboard:d,toExterior:!0,fromInterior:!0});const l=(new o.Vector3).lerpVectors(e.position,t.position,2/n).setY(e.position.y);return i.push({index:this.portalCount++,toSweep:t,fromSweep:e,position:l,lookDirection:a?a.clone().negate():null,billboard:d,toExterior:!1,fromInterior:!1}),i}neighborLinks(e,t){const i=[];for(const n of t)if(e!==n&&n.floorId===e.floorId&&e.position.distanceTo(n.position)<y.M0){const t=e.position.distanceTo(n.position);if(this.modelIntersection(e,n,t).intersect||this.modelIntersection(n,e,t).intersect)continue;const s=e.position.clone().sub(n.position).setY(0).normalize(),a=n.position.clone(),o=y.iz;t>o&&a.addScaledVector(s,t-o),i.push({index:this.portalCount++,toSweep:n,fromSweep:e,position:a,lookDirection:s,billboard:!1,toExterior:!0,fromInterior:!1})}return i}}},48476:(e,t,i)=>{"use strict";i.d(t,{K:()=>PortalClickMessage,x:()=>PortalHoverMessage});var n=i(98010);class PortalClickMessage extends n.v{constructor(e){super(),this.toSweep=e.toSweep,this.toExterior=e.toExterior,this.fromInterior=e.fromInterior,this.meshPosition=e.position}}class PortalHoverMessage extends n.v{constructor(e){super(),this.hovered=e}}},23331:(e,t,i)=>{"use strict";i.d(t,{M0:()=>n,AF:()=>s,vX:()=>a,nm:()=>o,iz:()=>r});const n=15,s=.1,a=.3,o=.75,r=4},87295:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>SweepPortalNavigation});const n=(0,i(78283)._F)(20);var s=i(97542),a=i(57956),o=i(63252),r=i(95882),d=i(64918),l=i(25985),h=i(53954),c=i(23254),m=i(8513),u=i(48476),g=i(12039),p=i(34029),v=i(43736),y=i(34956),w=i(38987);class SweepPortalNavigation extends s.Y{constructor(){super(...arguments),this.name="sweep-portal-navigation",this.onChange=()=>{this.portalRenderer.filter((e=>{if(!this.settingsData.tryGetProperty(v.s,!0))return m.Y.HIDE;if(!(0,r.Bw)(this.viewmodeData.closestMode))return m.Y.HIDE;const t=this.sweepData.getSweep(this.sweepData.currentSweep||"");if(t)if(t.alignmentType===o.z9.ALIGNED){if(e.fromInterior&&e.toExterior&&e.position.distanceTo(t.position)<n)return m.Y.SHOW}else if(t.placementType===o.hU.MANUAL&&e.fromSweep.id===t.id)return m.Y.ONTOP;return m.Y.HIDE}))}}async init(e,t){this.engine=t,[this.portalRenderer,this.cameraData,this.viewmodeModule,this.viewmodeData,this.sweepData,this.settingsData]=await Promise.all([t.getModuleBySymbol(a.y.SWEEP_PORTAL),t.market.waitForData(l.M),t.getModuleBySymbol(a.y.VIEWMODE),t.market.waitForData(c.O),t.market.waitForData(h.Z),t.market.waitForData(p.e)]);const i=(e,i)=>{this.viewmodeData.currentMode&&this.cameraData.canTransition()&&(this.viewmodeData.currentMode!==r.Ey.Panorama?this.viewmodeModule.switchToMode(r.Ey.Panorama,d.n.FadeToBlack,{sweepID:e,rotation:i}):t.commandBinder.issueCommand(new g.ju({sweep:e,rotation:i,transition:d.n.FadeToBlack})))};this.settingsData.onPropertyChanged(v.s,this.onChange),this.bindings.push(t.subscribe(u.K,(e=>{i(e.toSweep.id)})),t.subscribe(u.x,(e=>this.onPortalHover(e.hovered))),this.viewmodeData.onChanged(this.onChange),this.sweepData.onChanged(this.onChange)),this.onChange()}onPortalHover(e){const t=e?y.C.FINGER:null;this.engine.commandBinder.issueCommand(new w.u(t))}}},72512:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CancelNewTagCommand:()=>$.$g,CloseTagCommand:()=>$.xb,DeleteTagCommand:()=>$.T3,EditTagCommand:()=>$.zt,FilterVisibleTagsCommand:()=>$.Sq,OpenTagCommand:()=>$.lt,SaveCustomTagOrderCommand:()=>$.$B,SaveTagCommand:()=>$.QG,SaveTagVisibilityCommand:()=>$.bg,SetTagOrderByCommand:()=>$.kT,SetTagsModeCommand:()=>$.Li,StartNewTagCommand:()=>$.$J,TagOrderBy:()=>X.D,TagsMode:()=>X.U,TagsToolToggleCommand:()=>$.yU,TagsViewData:()=>_.n,TagsVisibilityFilterEnabledCommand:()=>$.aI,ToggleDirtyTagStateCommand:()=>$.q4,default:()=>de});var n,s=i(84428),a=i(97542),o=i(57956),r=i(38399),d=i(39880),l=i(87926),h=i(4592),c=i(79728),m=i(635),u=i(64918),g=i(12039),p=i(25071),v=i(52528),y=i(74082),w=i(14630),b=i(64773),f=i(47620),T=i(30643),D=i(98010);class editorMessages_MattertagAddMessage extends D.v{constructor(e,t,i){super(),this.sid=e,this.position=t,this.distanceFromCamera=i}}class editorMessages_MattertagRemoveMessage extends D.v{constructor(e,t){super(),this.sid=e,this.removeMethod=t}}class editorMessages_MattertagAddTitleMessage extends D.v{constructor(e,t){super(),this.sid=e,this.characterCount=t}}class editorMessages_MattertagAddDescriptionMessage extends D.v{constructor(e,t,i){super(),this.sid=e,this.characterCount=t,this.tagDescriptionChunks=i}}class editorMessages_MattertagAddMediaMessage extends D.v{constructor(e,t,i){super(),this.sid=e,this.mediaType=t,this.mediaSrc=i}}class editorMessages_MattertagEditedMessage extends D.v{constructor(e,t,i){super(),this.sid=e,this.property=t,this.value=i}}class editorMessages_MattertagMovedMessage extends D.v{constructor(e,t,i,n){super(),this.sid=e,this.position=t,this.distanceFromCamera=i,this.distanceMoved=n}}!function(e){e.DISC_COLOR="disc_color",e.STEM_VISIBLE="stem_visible",e.STEM_LENGTH="stem_length",e.TITLE="title",e.DESCRIPTION="description",e.MEDIA="media",e.LINKS="links",e.ENABLED="enabled",e.KEYWORDS="keywords"}(n||(n={}));var C=i(72936),P=i(62612),M=i(60083),S=i(13132),A=i(43470),E=i(86283),k=i(16935),I=i(5604),N=i(76631),O=i(40964),V=i(91380),R=i(89549),x=i(92211),B=i(24102),L=i(43846),F=i(66338),H=i(25561),U=i(71776),G=i(19648),z=i(20480),j=i(85679),_=i(61774),$=i(43037),W=i(35446),J=i(21149),K=i(54244),Y=i(79727),q=i(53954),Z=i(34029),Q=i(23254),X=i(12150),ee=i(55318),te=i(25985),ie=i(76957),ne=i(76087),se=i(80742),ae=i(28022),oe=i(55502),re=i(51397);class TagsModule extends a.Y{constructor(){super(...arguments),this.name="tags-module",this.opening=null,this.activated=!1,this.registered=!1,this.activeBindings=[],this.updatePerSettings=()=>{const e=this.settingsData.tryGetProperty(U.re,!1),t=!this.in360View()&&e;this.engine.commandBinder.issueCommand(new C.qN(P.Er.MATTERTAG,t)),t||this.closeTagBillboard()},this.tagsToolToggled=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.updateViewingControls=()=>{const{openTagView:e}=this.viewData,t=this.toolsData.toolPanelLayout===N.wS.BOTTOM_PANEL,i=!this.activated||!t&&!e;this.engine.broadcast(new O.ps(i))},this.onCloseTag=async()=>{this.closeTag()},this.pinAddCancelled=e=>{e.pinType===P.Er.MATTERTAG&&this.cancelTagCreation(!1)},this.onCancelNewTag=async()=>{this.cancelTagCreation(!0)},this.cancelTagCreation=e=>{var t;const i=this.viewData,n=null===(t=i.openTagView)||void 0===t?void 0:t.id;this.cancelAttachmentChanges(),i.setOpenTagView(null),i.creatingTag=!1,i.commit(),n&&(e&&this.engine.commandBinder.issueCommand(new C.tT(n,P.Er.MATTERTAG)),this.engine.commandBinder.issueCommand(new A.Aj(n,E.J.TAG)))},this.tagsWereChanged=()=>{this.updateTagViews(),this.displayTags()},this.updateTagViews=()=>{this.viewData.updateTagViews(this.getCustomTagOrder())},this.onTagRemoved=e=>{const t=e.objectAnnotationId?P.Er.OBJECT:P.Er.MATTERTAG;this.engine.commandBinder.issueCommand(new C.OL(e.sid,t))},this.handleModelViewChange=()=>{if(this.viewData.openTagView)if(this.viewData.creatingTag)this.cancelTagCreation(!0);else{this.tagsData.getTag(this.viewData.openTagView.id)||this.closeTag()}},this.onLayersChanged=()=>{this.closeTagBillboard(),this.displayTags()},this.onOpenTagViewChanged=()=>{const e=this.viewData.openTagView;e&&this.updateTagPin(e)},this.startTagCreation=async()=>{const e=this.viewData;e.setTagsMode(X.U.DEFAULT),await this.closeTag();let t=(0,d.O1)(11);for(;this.tagsData.getTag(t);)t=(0,d.O1)(11);const i=new z.U;i.sid=t,i.floorId=this.floorsViewData.getHighestVisibleFloor().id;const n=e.createTagView(i);e.creatingTag=!0,e.commit(),e.setOpenTagView(n),this.engine.commandBinder.issueCommand(new C.fM(n.id,n,P.Er.MATTERTAG,n.backgroundTexture))},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:s,embed:a}=e,o=this.viewData,{openTagView:r,creatingTag:d}=o;if(!r)return void this.log.debug("No open tag");const l=Object.assign({},r,i);this.trackChanges(t,l,a),d?await this.engine.commandBinder.issueCommand(new G.Mm(t,l,n,a)):await this.engine.commandBinder.issueCommand(new G.qq(t,l,n,s,a)),this.selectPin(t,!0),o.creatingTag=!1,o.commit(),await this.engine.commandBinder.issueCommand(new W.x9),this.closeTag()},this.saveTagVisibility=async e=>{const{id:t,visible:i}=e,n=this.tagsData.getTag(t);if(!n)throw new Error("Tag not found!");this.engine.commandBinder.issueCommand(new C.ik(t,P.Er.MATTERTAG,this.getTagVisibility(t,n.layerId,i)));const s={enabled:i};return this.trackChanges(t,s),this.engine.commandBinder.issueCommand(new G.qq(t,s))},this.onToggleTagDirty=async e=>{this.viewData.dirtyTagState=e.dirty,this.viewData.commit()},this.onDeleteTag=async e=>{const t=e.id;this.tagsData.getTag(t)?(this.engine.commandBinder.issueCommand(new x.rE),this.engine.broadcast(new editorMessages_MattertagRemoveMessage(t,e.removalMethod)),this.engine.commandBinder.issueCommand(new G.Gn(t)).then((()=>{this.saveTags().then((()=>{this.engine.commandBinder.issueCommand(new C.OL(t,P.Er.MATTERTAG));const e=this.viewData.openTagView;e&&e.id===t&&this.closeTag()}))})),this.engine.commandBinder.issueCommand(new W.x9)):this.log.debug("Cannot delete a non-existent tag")},this.onEditTag=async e=>{const{tagId:t}=e;this.tagsData.getTag(t)?(await this.engine.commandBinder.issueCommand(new W.x9),await this.openTag(t,u.n.FadeToBlack,!0,!0),this.openAnnotation(t,!0),this.selectPin(t,!0)):this.log.debug("Cannot edit a non-existent tag")},this.onSaveCustomTagOrder=async e=>{const{ids:t}=e,i=t.map((e=>({id:e,type:B.l.TAG})));await this.engine.commandBinder.issueCommand(new L.wg(H.q,i)),this.viewData.updateTagViews(t)},this.pinMoved=e=>{const{id:t,pinType:i,pinPos:n,previousPos:s}=e,a=this.viewData.openTagView;if(a&&i===P.Er.MATTERTAG&&t===a.id){if(this.tagsData.getTag(t)){const e={position:n.anchorPosition,normal:n.stemNormal,floorId:n.floorId};this.engine.broadcast(new editorMessages_MattertagMovedMessage(t,e.position,e.position.distanceTo(this.cameraData.pose.position),s?e.position.distanceTo(s.anchorPosition):0)),this.engine.commandBinder.issueCommand(new G.qq(t,e))}else this.log.debug("Cannot move a non-existent tag")}},this.pinPlaced=e=>{const t=this.viewData.openTagView;t&&e.pinType===P.Er.MATTERTAG&&e.id===t.id&&(this.viewData.updateOpenTagView(e.pinPos),this.openAnnotation(t.id,!0))},this.handlePinFocusChange=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t)return;const{commandBinder:i}=this.engine,{focusedPin:n,selectedPin:s}=this.pinsViewData,{billboardAnnotation:a}=this.annotationsViewData;if(!n)return void(a&&a.annotationType===E.J.TAG&&a.id!==(null==s?void 0:s.id)&&await i.issueCommand(new A.Aj(a.id,E.J.TAG)));const o=this.getSelectedTag(),r=o&&(null==o?void 0:o.id)===(null==e?void 0:e.id),d=e&&(null==e?void 0:e.id)===(null==n?void 0:n.id);if(e&&r&&!d&&this.closeTag(),n.pinType===P.Er.MATTERTAG){const t=this.viewData.getTagView(n.id);if(!t)return void this.log.debug("Focused pin changed, but no tag view.");t.id!==(null==e?void 0:e.id)&&(i.issueCommand(new A.Kw(t.id,E.J.TAG)),this.engine.broadcast(new oe.dJ(t.id,re.V.HOVER)))}},this.handlePinSelectionChange=async()=>{const{openTagView:e,dirtyTagState:t}=this.viewData,{selectedPin:i}=this.pinsViewData;if(t||(null==e?void 0:e.id)===(null==i?void 0:i.id))return;const n=this.appData.application===K.Mx.WORKSHOP;if(e&&!i)!n&&this.activated?this.deactivateTool():this.closeTag();else if(i&&i.pinType===P.Er.MATTERTAG){const e=this.isTagDocked(),t=n&&this.activated&&!!e,s=!(0,p.OR)()||t;this.engine.broadcast(new oe.dJ(i.id,re.V.OPEN)),await this.openTag(i.id,u.n.Interpolate,s),this.openAnnotation(i.id,s)}},this.handleAnnotationsChanged=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t||this.opening)return;const i=this.getDockedTag(),n=this.getSelectedTag(),s=i||n,a=!!i,{dockedAnnotation:o}=this.annotationsViewData;e&&!s&&(null==o?void 0:o.annotationType)!==E.J.OBJECT?this.closeTag():s&&s.id!==(null==e?void 0:e.id)&&(await this.openTag(s.id,u.n.Interpolate,a),this.selectPin(s.id,a));const{previousToolName:r}=this.toolsData;!a&&(r===N.w1.SEARCH||r===N.w1.LAYERS)||this.toggleToolForDocking(a)},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==E.J.TAG)return;const s=this.viewData.getTagView(i);if(!s)return void this.log.debug("Cannot view attachment for a non-existent tag");const a=s.attachments,o=a.find((e=>e.id===n));if(o&&(0,J.lV)(o)){const e=a.filter((e=>(0,J.lV)(e)));this.engine.commandBinder.issueCommand(new W.xW(!0,e,n))}},this.onOpenTag=async e=>{const{tagId:t,dock:i,transition:n,objectTag:s}=e,a=null!==i?i:this.isTagDocked(),o=this.settingsData.tryGetProperty(ne.fc,!1);a&&s&&!o?this.dockTagObjectOnLeft(t):(await this.openTag(t,n,a,!1),this.openAnnotation(t,a),this.selectPin(t,a))},this.filterVisibleTags=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit(),this.displayTags()},this.tagVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit(),this.displayTags()},this.setTagOrderBy=async({order:e})=>{e!==this.viewData.tagOrder&&(this.viewData.tagOrder=e,this.viewData.commit())},this.setTagsMode=async({mode:e})=>{e===X.U.REORDERING&&this.closeTag(),this.viewData.setTagsMode(e)}}async init(e,t){const[i,n,s,a,d,c,m,u,g,p,f,T]=await Promise.all([t.market.waitForData(te.M),t.market.waitForData(j.n),t.market.waitForData(V.t),t.market.waitForData(q.Z),t.market.waitForData(Z.e),t.market.waitForData(Q.O),t.market.waitForData(k.A),t.market.waitForData(K.pu),t.market.waitForData(Y.c),t.market.waitForData(F.W),t.market.waitForData(se.R),t.getModuleBySymbol(o.y.LOCALE)]),[D,C,P]=await Promise.all([t.market.waitForData(ie.i),t.market.waitForData(ee.O),t.getModuleBySymbol(o.y.DEEP_LINKS)]);this.cameraData=i,this.tagsData=n,this.toolsData=s,this.sweepData=a,this.settingsData=d,this.viewmodeData=c,this.annotationsViewData=m,this.appData=u,this.floorsViewData=g,this.orderedListData=p,this.layersData=f,this.engine=t,this.backgroundTexture=(0,l.p)(h),this.descriptionParser=new y.$({supportLinks:!0,keepLinkLabels:!0});const S=new v.v({links:!0,hashtags:!1}),A=this.getCustomTagOrder();this.viewData=new _.n(this.tagsData,D,C,A,S,P,T.t(r.Z.WORKSHOP.MATTERTAGS.DEFAULT_TAG_TITLE),this.backgroundTexture,e.objectTagsEnabled),this.pinsViewData=await t.market.waitForData(M.B),this.bindings.push(d.onPropertyChanged(U.re,this.updatePerSettings),t.commandBinder.addBinding($.yU,this.tagsToolToggled),t.subscribe(I.q,this.handleViewingAttachment),t.subscribe(w.Z,this.updatePerSettings),t.subscribe(b.m,this.updatePerSettings),c.makeModeChangeSubscription(this.updatePerSettings),t.commandBinder.addBinding($.xb,this.onCloseTag),t.commandBinder.addBinding($.lt,this.onOpenTag),t.commandBinder.addBinding($.Li,this.setTagsMode),t.commandBinder.addBinding($.kT,this.setTagOrderBy),t.commandBinder.addBinding($.QG,this.saveTag),t.commandBinder.addBinding($.q4,this.onToggleTagDirty),t.commandBinder.addBinding($.T3,this.onDeleteTag),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.annotationsViewData.onChanged(this.handleAnnotationsChanged),this.viewData.onOpenTagViewChanged(this.onOpenTagViewChanged),this.orderedListData.onChanged(this.updateTagViews),this.tagsData.onChanged(this.tagsWereChanged),this.tagsData.collection.onElementChanged({onRemoved:this.onTagRemoved}),this.appData.onChanged((()=>this.displayTags())),this.layersData.onCurrentLayersChanged(this.onLayersChanged),t.commandBinder.addBinding($.Sq,this.filterVisibleTags),t.commandBinder.addBinding($.aI,this.tagVisbilityFilterEnabled),t.subscribe(ae.Y,this.handleModelViewChange)),t.market.register(this,_.n,this.viewData),this.updatePerSettings(),this.displayTags()}dispose(e){this.deactivateTool(!0),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.engine.commandBinder.issueCommand(new C.zM(P.Er.MATTERTAG)),this.backgroundTexture.dispose(),super.dispose(e)}onUpdate(){}activateTool(){this.activated||(this.engine.commandBinder.issueCommand(new A.yL(E.J.TAG)),this.engine.commandBinder.issueCommand(new C.Ki(!0)),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0,this.updateViewingControls())}deactivateTool(e){if(!this.activated)return;const{creatingTag:t,openTagView:i,tagsMode:n}=this.viewData;n!==X.U.DEFAULT&&this.viewData.setTagsMode(X.U.DEFAULT),t?this.cancelTagCreation(!0):i&&this.closeTag(),this.engine.commandBinder.issueCommand(new C.Ki(!1)),this.activeBindings.forEach((e=>{e.cancel()})),this.activated=!1,this.updateViewingControls(),this.engine.commandBinder.issueCommand(new W.x9)}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(S.b0,this.pinPlaced),this.engine.subscribe(S.bV,this.pinMoved),this.engine.subscribe(S.hu,this.pinAddCancelled),e.addBinding($.bg,this.saveTagVisibility),e.addBinding($.$J,this.startTagCreation),e.addBinding($.$g,this.onCancelNewTag),e.addBinding($.zt,this.onEditTag),e.addBinding($.$B,this.onSaveCustomTagOrder),this.viewData.onOpenTagViewChanged(this.updateViewingControls),this.viewData.onPropertyChanged("creatingTag",this.updateViewingControls)),this.registered=!0}closeTagBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===E.J.TAG&&this.engine.commandBinder.issueCommand(new A.Aj(e.id,E.J.TAG))}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeTag(){const{commandBinder:e}=this.engine,t=this.viewData,{openTagView:i}=t;if(i){const{id:n,layerId:s,enabled:a}=i;t.setOpenTagView(null),this.cancelAttachmentChanges(),e.issueCommand(new W.xW(!1));this.tagsData.getTag(n)&&(e.issueCommand(new C.RH(n,P.Er.MATTERTAG)),e.issueCommand(new C.ik(n,P.Er.MATTERTAG,this.getTagVisibility(n,s,a)))),await this.engine.commandBinder.issueCommand(new W.x9),await e.issueCommand(new A.Aj(n,E.J.TAG))}this.engine.commandBinder.issueCommand(new W.x9)}getTagVisibility(e,t,i){const{openTagView:n,idVisibilityEnabled:s,idVisibility:a}=this.viewData,o=this.appData.application===K.Mx.WORKSHOP,r=(null==n?void 0:n.id)===e,d=o||this.layersData.layerToggled(t),l=!s||a.has(e);return d&&(r||i&&l)}displayTags(){const e=[];this.viewData.getOrderedTags(!1).forEach((t=>{t.objectAnnotationId||e.push(Object.assign(Object.assign({},t),{pinType:t.objectAnnotationId?P.Er.OBJECT:P.Er.MATTERTAG,backgroundTexture:this.backgroundTexture,visible:this.getTagVisibility(t.id,t.layerId,t.enabled)}))})),this.engine.commandBinder.issueCommand(new C.mE(e))}updateTagPin(e){if(e.objectAnnotationId)return;const t=Object.assign(Object.assign({},e),{pinType:P.Er.MATTERTAG,backgroundTexture:this.backgroundTexture,visible:this.getTagVisibility(e.id,e.layerId,e.enabled)});this.engine.commandBinder.issueCommand(new C.mE([t]))}async cancelAttachmentChanges(){return this.engine.commandBinder.issueCommand(new W.Ze)}getCustomTagOrder(){const e=this.orderedListData.getOrderedList(H.q);return e?e.entries.map((e=>e.id)):[]}async saveTags(){this.engine.commandBinder.issueCommand(new m.VQ({dataTypes:[c.g.MATTERTAGS]}))}openAnnotation(e,t){const i=this.annotationsViewData.getCapabilities(e);t&&i.dock?this.engine.commandBinder.issueCommand(new A.bd(e,E.J.TAG)):i.preview&&this.engine.commandBinder.issueCommand(new A.oM(e,E.J.TAG))}async selectPin(e,t=!1){const i=t&&this.activated&&this.appData.application===K.Mx.WORKSHOP;t?this.engine.broadcast(new oe.dJ(e,re.V.DOCKED)):this.engine.broadcast(new oe.dJ(e,re.V.OPEN)),await this.engine.commandBinder.issueCommand(new C.Ar(e,P.Er.MATTERTAG,i))}dockTagObjectOnLeft(e){const t=this.viewData.getTagView(e);this.engine.commandBinder.issueCommand(new A.bd(e,E.J.OBJECT)),this.viewData.setOpenTagView(t),this.selectPin(e,!0),this.toolsData.toolCollapsed&&this.engine.commandBinder.issueCommand(new R.Fg(!1))}async openTag(e,t,i,n){const s=this.viewData,a=s.getTagView(e);if(a){const{openTagView:o,tagsMode:r}=this.viewData,{commandBinder:d}=this.engine,{dockedAnnotation:l,selectedAnnotation:h}=this.annotationsViewData;i&&r===X.U.REORDERING&&s.setTagsMode(X.U.DEFAULT),i&&this.toolsData.toolCollapsed&&this.activated&&d.issueCommand(new R.Fg(!1));const c=(null==o?void 0:o.id)===e;if(c&&this.activated===i)return void this.log.debug("Tag is already open and "+(i?"docked":"undocked"));if(i!==!!l&&(await this.toggleToolForDocking(i),l&&await this.engine.commandBinder.issueCommand(new A.Aj(l.id,l.annotationType))),!c&&this.opening!==e){this.opening=e,d.issueCommand(new x.rE),h&&h.id!==e&&await this.engine.commandBinder.issueCommand(new A.Aj(h.id,h.annotationType)),s.setOpenTagView(a);const i=s.getCapabilities(e);null!==t&&i.focus&&!n&&await this.engine.commandBinder.issueCommand(new g.OR({pinPosition:a,transition:t})).then((()=>{this.engine.broadcast(new oe.QY(a.id))})),setTimeout((()=>{this.opening=null}),0)}}else this.log.debug("Cannot open a non-existent tag")}isTagDocked(){const{dockedAnnotation:e}=this.annotationsViewData;return(null==e?void 0:e.annotationType)===E.J.TAG}getDockedTag(){const{dockedAnnotation:e}=this.annotationsViewData;return e&&e.annotationType===E.J.TAG?this.viewData.getTagView(e.id):null}getSelectedTag(){const{billboardAnnotation:e,billboardSelected:t}=this.annotationsViewData;return e&&t&&e.annotationType===E.J.TAG||(null==e?void 0:e.annotationType)===E.J.OBJECT?this.viewData.getTagView(e.id):null}async toggleToolForDocking(e){const t=this.appData.application===K.Mx.WORKSHOP;if(e){const e=!this.activated;await this.engine.commandBinder.issueCommand(new R.z2(N.w1.TAGS,e))}else t||await this.engine.commandBinder.issueCommand(new R.CH(N.w1.TAGS))}trackChanges(e,t,i){const a=this.tagsData.getTag(e),{position:o,color:r,description:d,label:l,stemHeight:h,stemVisible:c,enabled:m,keywords:u}=t;if(!a&&o)return void this.engine.broadcast(new editorMessages_MattertagAddMessage(e,o,o.distanceTo(this.cameraData.pose.position)));if(void 0!==m&&a.enabled!==m&&this.engine.broadcast(new editorMessages_MattertagEditedMessage(e,n.ENABLED,m)),r){const t=new s.Color(r.r,r.g,r.b).getHexString();a.color.getHexString()!==t&&this.engine.broadcast(new editorMessages_MattertagEditedMessage(e,n.DISC_COLOR,`#${t}`))}if(void 0!==h&&a.stemHeight!==h&&this.engine.broadcast(new editorMessages_MattertagEditedMessage(e,n.STEM_LENGTH,h)),void 0!==c&&a.stemVisible!==c&&this.engine.broadcast(new editorMessages_MattertagEditedMessage(e,n.STEM_VISIBLE,c)),void 0!==l&&a.label!==l&&(this.engine.broadcast(new editorMessages_MattertagEditedMessage(e,n.TITLE,l.length)),this.engine.broadcast(new editorMessages_MattertagAddTitleMessage(e,l.length))),void 0!==d&&a.description!==d){this.engine.broadcast(new editorMessages_MattertagEditedMessage(e,n.DESCRIPTION,d.length));const t=this.descriptionParser.parse(d,this.layersData.getNonworkshopViewId());this.engine.broadcast(new editorMessages_MattertagAddDescriptionMessage(e,d.length,t));const i=y.$.getNumLinks(t);y.$.getNumLinks(a.parsedDescription)!==i&&this.engine.broadcast(new editorMessages_MattertagEditedMessage(e,n.LINKS,i))}if(i){const t=i?i.src:"",s=i?(0,f.F5)(i.mediaType):T.z.none;a.mediaSrc===t&&a.mediaType===s||(this.engine.broadcast(new editorMessages_MattertagEditedMessage(e,n.MEDIA,s)),this.engine.broadcast(new editorMessages_MattertagAddMediaMessage(e,s,t)))}const g=a.keywords.every((e=>u&&u.includes(e)));if((null==u?void 0:u.length)!==a.keywords.length||!g){const t=(null==u?void 0:u.length)||0;this.engine.broadcast(new editorMessages_MattertagEditedMessage(e,n.KEYWORDS,t))}}}const de=TagsModule},79232:(e,t,i)=>{"use strict";i.d(t,{F:()=>DeletedObject});var n=i(75287),s=i(39880);class DeletedObject extends n.T{constructor(e){super(),this.id=(0,s.O1)(11),e&&Object.assign(this,e)}}},33824:(e,t,i)=>{"use strict";i.d(t,{B:()=>RegisterDeletedObjectTypeCommand,p:()=>RestoreDeletedObjectCommand});var n=i(19663);class RegisterDeletedObjectTypeCommand extends n.m{constructor(e){super(),this.id="REGISTER_DELETED_OBJECT_TYPE_COMMAND",this.payload=e}}class RestoreDeletedObjectCommand extends n.m{constructor(e){super(),this.id="RESTORE_DELETED_OBJECT_COMMAND",this.payload={id:e}}}},70903:(e,t,i)=>{"use strict";i.d(t,{L:()=>ObjectPool});class ObjectPool{constructor(e){this.comparer=e||this.defaultComparer,this.poolArray=[]}add(e){const t=this.createObjectDescriptor(e);return t.object=e,t.inUse=!0,this.addObjectDescriptorToPool(t),t}get(e){for(const t of this.poolArray)if(!t.inUse&&this.comparer(t,e))return t.inUse=!0,t;return null}free(e){for(const t of this.poolArray)if(t.object===e)return t.inUse=!1,!0;return!1}all(){return this.poolArray}remove(e){const t=this.poolArray.findIndex((t=>t.object===e));return-1!==t&&(this.poolArray.splice(t,1),!0)}defaultComparer(e,t){return!0}createObjectDescriptor(e){return{object:e,inUse:!1}}addObjectDescriptorToPool(e){this.poolArray.push(e)}}},77597:(e,t,i)=>{"use strict";i.d(t,{f:()=>ReticleMesh});var n=i(84428);const s={extensions:{derivatives:!0},defines:{RING_COUNT:0,USE_TEXTURE:!1},uniforms:{discRadius:{value:.2},discNormal:{value:new n.Vector3(0,0,1)},ringRadii:{value:[]},ringColors:{value:[]},opacity:{value:1},texture:{value:null}},vertexShader:i(29535),fragmentShader:i(37198),side:n.FrontSide,transparent:!0};var a=i(93377);const o=new n.Color,r=[{outerRadius:1,innerRadius:.75,color:16777215,opacity:1}];class ReticleMaterial extends a.b{constructor(e=r){super(Object.assign(Object.assign({},s),{defines:Object.assign({},s.defines),uniforms:n.UniformsUtils.clone(s.uniforms)})),this.setRings(e),Object.defineProperty(this,"opacity",{set(e){this.uniforms.opacity.value=e},get(){return this.uniforms.opacity.value}})}setDiscNormal(e){this.uniforms.discNormal.value.copy(e)}setDiscRadius(e){this.uniforms.discRadius.value=e}setRings(e){e=e||[],this.defines.RING_COUNT!==e.length&&(this.defines.RING_COUNT=e.length,this.needsUpdate=!0),this.uniforms.ringRadii.value=e.map((({innerRadius:e,outerRadius:t})=>new n.Vector2(e||-1,t))),this.uniforms.ringColors.value=e.map((({color:e,opacity:t})=>(o.set(e),new n.Vector4(o.r,o.g,o.b,t))))}setTexture(e){this.defines.USE_TEXTURE!==!!e&&(this.defines.USE_TEXTURE=!!e,this.needsUpdate=!0),this.uniforms.texture.value=e}getTexture(){return this.uniforms.texture.value}}class ReticleMesh extends n.Mesh{constructor(e){super(new n.SphereGeometry(Math.sqrt(2),8,6),new ReticleMaterial),e&&this.configure(e)}configure(e){const{radius:t,normal:i,rings:n,texture:s,opacity:a}=e,{material:o}=this;void 0!==t&&(this.scale.setScalar(t),o.setDiscRadius(t)),void 0!==i&&o.setDiscNormal(i),void 0!==n&&o.setRings(n),void 0!==s&&o.setTexture(s),void 0!==a&&(o.opacity=a)}dispose(){var e;null===(e=this.material.getTexture())||void 0===e||e.dispose(),this.geometry.dispose()}}},62118:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;uniform sampler2D tMask;uniform sampler2D tPinHole;uniform vec3 pinColor;uniform float opacity;void main(){vec4 maskColor=texture2D(tMask,vUv);vec4 pinHoleColor=vec4(texture2D(tPinHole,vec2(vUv.x,vUv.y-0.11)).xyz,1.);float redness=maskColor.r-maskColor.b;vec4 mixedPinColor=mix(vec4(pinColor,1.),pinHoleColor,redness);mixedPinColor.a=min(mixedPinColor.a,maskColor.a)*opacity;gl_FragColor=mixedPinColor;}"},77256:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;attribute vec2 uv;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},45405:e=>{e.exports="precision highp float;precision highp int;uniform samplerCube tMap;varying vec3 vUvw;void main(){vec4 color=textureCube(tMap,vec3(-vUvw.x,vUvw.yz));gl_FragColor=vec4(color.rgb,1.);}"},29837:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;varying vec3 vUvw;void main(){vUvw=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},8346:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;uniform float progress;uniform float opacity;uniform sampler2D tNoHover;uniform sampler2D tHover;uniform sampler2D tPortal;void main(){vec4 noHoverColor=texture2D(tNoHover,vUv);vec4 hoverColor=texture2D(tHover,vUv);vec4 portalColor=texture2D(tPortal,vUv);float xToCtr=2.*vUv.x-1.;float yToCtr=2.*vUv.y-1.;float withinRadius=step(xToCtr*xToCtr+yToCtr*yToCtr,0.9);vec4 mixedPortalColor=mix(hoverColor,portalColor,withinRadius);mixedPortalColor=mix(mixedPortalColor,hoverColor,hoverColor.a);mixedPortalColor=mix(noHoverColor,mixedPortalColor,progress);mixedPortalColor.a=min(mixedPortalColor.a,opacity);gl_FragColor=mixedPortalColor;}"},35490:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;attribute vec2 uv;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},37198:e=>{e.exports="precision highp float;precision highp int;uniform mat4 viewMatrix;uniform vec3 cameraPosition;uniform float opacity;uniform float discRadius;uniform vec3 discNormal;varying vec3 vFragWorldPos;varying vec3 vCenterWorldPos;\n#ifdef USE_TEXTURE\nuniform sampler2D texture;\n#else\nuniform vec2 ringRadii[RING_COUNT];uniform vec4 ringColors[RING_COUNT];\n#endif\nfloat rayDistToPlane(vec3 rayOrigin,vec3 rayDir,vec3 planeOrigin,vec3 planeNormal){float planeConstant=-dot(planeOrigin,planeNormal);float denom=dot(planeNormal,rayDir);return denom==0.?-1e9:-(dot(rayOrigin,planeNormal)+planeConstant)/denom;}vec4 getColorAtRay(vec3 rayOrigin,vec3 rayDir){vec4 color=vec4(0.);float intersectDist=rayDistToPlane(rayOrigin,rayDir,vCenterWorldPos,discNormal);vec3 intersect=rayOrigin+rayDir*intersectDist;\n#ifdef USE_TEXTURE\nif(intersectDist>0.){vec3 stableDir=abs(discNormal.y)>0.8?normalize((vCenterWorldPos-rayOrigin)*vec3(1.,0.,1.))*sign(discNormal.y):vec3(0.,1.,0.);vec3 xAxis=normalize(cross(stableDir,discNormal));vec3 yAxis=normalize(cross(discNormal,xAxis));intersect-=vCenterWorldPos;vec2 uv=vec2(dot(xAxis,intersect),dot(yAxis,intersect))/discRadius/2.+0.5;if(clamp(uv,vec2(0.),vec2(1.))==uv){color=texture2D(texture,uv);}}\n#else\nfloat fragRadius=intersectDist>0.?distance(intersect,vCenterWorldPos):1e9;if(fragRadius<=discRadius*2.){for(int i=0;i<RING_COUNT;i++){vec2 radii=ringRadii[i]*discRadius;vec4 ringColor=ringColors[i];float ringDist=min(fragRadius-radii[0],radii[1]-fragRadius);\n#if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300\nfloat delta=length(vec2(dFdx(fragRadius),dFdy(fragRadius)))*0.70710678;ringColor.a*=smoothstep(-delta,delta,ringDist);\n#else\nringColor.a*=step(0.,ringDist);\n#endif\ncolor=vec4(color.rgb,1.)*color.a+ringColor*(1.-color.a);}}\n#endif\nreturn color;}void main(){vec3 rayDir=normalize(vFragWorldPos-cameraPosition);gl_FragColor=getColorAtRay(cameraPosition,rayDir);gl_FragColor.a*=opacity;if(gl_FragColor.a==0.){discard;}}"},29535:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat4 viewMatrix;uniform mat3 normalMatrix;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec3 vCenterWorldPos;varying vec3 vFragWorldPos;void main(){vCenterWorldPos=(modelMatrix*vec4(0.,0.,0.,1.)).xyz;vFragWorldPos=(modelMatrix*vec4(position,1.)).xyz;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},44602:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"FileAttachments"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"fileAttachmentsByModelId"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"results"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteFileAttachment"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"id"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteFileAttachment"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"id"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"FileAttachmentDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"FileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"bytes"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"mimeType"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ImageFileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"imageWidth"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"imageHeight"},arguments:[],directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"UploadFileAttachmentToModel"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"organizationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"contents"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"FileUpload"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"filename"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"uploadFileAttachmentToModel"},arguments:[{kind:"Argument",name:{kind:"Name",value:"organizationId"},value:{kind:"Variable",name:{kind:"Name",value:"organizationId"}}},{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"contents"},value:{kind:"Variable",name:{kind:"Name",value:"contents"}}},{kind:"Argument",name:{kind:"Name",value:"filename"},value:{kind:"Variable",name:{kind:"Name",value:"filename"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}],loc:{start:0,end:757}};t.loc.source={body:"# read all attachments for the specified model\nquery FileAttachments($modelId: ID!) {\n  fileAttachmentsByModelId(modelId: $modelId) {\n    results { ...FileAttachmentDetails }\n  }\n}\n\nmutation DeleteFileAttachment($id: ID!) {\n  deleteFileAttachment(id: $id)\n}\n\nfragment FileAttachmentDetails on FileAttachment {\n  id\n  created\n  filename\n  url\n  validUntil\n  bytes\n  mimeType\n  ...on ImageFileAttachment {\n      imageWidth\n      imageHeight\n  }\n}\n\nmutation UploadFileAttachmentToModel($organizationId: ID!, $modelId: ID!, $contents: FileUpload!, $filename: String!) {\n  uploadFileAttachmentToModel(organizationId: $organizationId, modelId: $modelId,\n                              contents: $contents, filename: $filename) {\n    ...FileAttachmentDetails\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function s(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function a(e,t){var i={kind:e.kind,definitions:[s(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=n[t]||new Set,o=new Set,r=new Set;for(a.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=s(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.FileAttachments=a(t,"FileAttachments"),e.exports.DeleteFileAttachment=a(t,"DeleteFileAttachment"),e.exports.FileAttachmentDetails=a(t,"FileAttachmentDetails"),e.exports.UploadFileAttachmentToModel=a(t,"UploadFileAttachmentToModel")},69665:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetObjectAnnotations"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}},type:{kind:"NamedType",name:{kind:"Name",value:"Float"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"ids"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}},type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"objectAnnotations"},arguments:[{kind:"Argument",name:{kind:"Name",value:"inferenceEvents"},value:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}}},{kind:"Argument",name:{kind:"Name",value:"minimumConfidenceOverride"},value:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}}},{kind:"Argument",name:{kind:"Name",value:"ids"},value:{kind:"Variable",name:{kind:"Name",value:"ids"}}},{kind:"Argument",name:{kind:"Name",value:"includeDisabled"},value:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"AddObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationDetails"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"addObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotation"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"SetBulkObjectAnnotationsEnabled"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}},type:{kind:"NonNullType",type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"setBulkObjectAnnotationsEnabled"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationIds"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}}},{kind:"Argument",name:{kind:"Name",value:"setEnabled"},value:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ObjectAnnotationInfo"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotation"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"modified"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"room"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[{kind:"Directive",name:{kind:"Name",value:"include"},arguments:[{kind:"Argument",name:{kind:"Name",value:"if"},value:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}}}]}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"enabled"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"confidence"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"panos"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"region"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"VectorRegion"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"anchorPosition"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemNormal"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemLength"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"tag"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"keywords"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"classification"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"defaultKeywords"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:1708}};t.loc.source={body:"# Object Tag Suggestions\n# Reference: https://matterport-confluence.atlassian.net/wiki/spaces/PP/pages/2678521926/Datafication+Object+Detection+Schema+Proposal\n\n\nquery GetObjectAnnotations($modelId: ID!, $inferenceEvents: [ID!], $minConfidence: Float, $ids: [ID!], $includeDisabled: Boolean, $includeLayers: Boolean!) {\n  model(id: $modelId) {\n    objectAnnotations(inferenceEvents: $inferenceEvents, minimumConfidenceOverride: $minConfidence, ids: $ids, includeDisabled: $includeDisabled) {\n      ...ObjectAnnotationInfo\n    }\n  }\n}\n\nmutation AddObjectAnnotation($modelId: ID!, $objectAnnotation: ObjectAnnotationDetails!, $includeLayers: Boolean!) {\n  addObjectAnnotation(modelId: $modelId, objectAnnotation: $objectAnnotation) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation SetBulkObjectAnnotationsEnabled($modelId: ID! $objectAnnotationIds:[ID!]!, $setEnabled: Boolean!, $includeLayers: Boolean!) {\n  setBulkObjectAnnotationsEnabled(modelId: $modelId, objectAnnotationIds: $objectAnnotationIds, setEnabled: $setEnabled) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation DeleteObjectAnnotation($modelId: ID!, $objectAnnotationId: ID!) {\n  deleteObjectAnnotation(modelId: $modelId, objectAnnotationId: $objectAnnotationId)\n}\n\nfragment ObjectAnnotationInfo on ObjectAnnotation {\n  id\n  created\n  modified\n  model {\n    id\n  }\n  floor {\n    id\n  }\n  room {\n    id\n  }\n  layer @include(if: $includeLayers) { id } \n  enabled\n  label\n  confidence\n  panos {\n    id\n  }\n  region {\n    ... on VectorRegion {\n      anchorPosition {\n        x, y, z\n      }\n      stemNormal {\n        x, y, z\n      }\n      stemLength\n    }\n  }\n  tag {\n    id\n  }\n  keywords\n  classification {\n    id,\n    label,\n    defaultKeywords\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function s(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function a(e,t){var i={kind:e.kind,definitions:[s(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=n[t]||new Set,o=new Set,r=new Set;for(a.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=s(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.GetObjectAnnotations=a(t,"GetObjectAnnotations"),e.exports.AddObjectAnnotation=a(t,"AddObjectAnnotation"),e.exports.SetBulkObjectAnnotationsEnabled=a(t,"SetBulkObjectAnnotationsEnabled"),e.exports.DeleteObjectAnnotation=a(t,"DeleteObjectAnnotation"),e.exports.ObjectAnnotationInfo=a(t,"ObjectAnnotationInfo")}}]);